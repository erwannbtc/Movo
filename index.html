<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <title>Movo - Gestion Financière</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <meta name="theme-color" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Movo">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --revolut -dark: #0A0A0B;
            --revolut-card: #1C1C1E;
            --revolut-gray: #2C2C2E;
            --revolut-light-gray: #48484A;
            --revolut-blue: #007AEF;
            --revolut-green: #30D158;
            --revolut-red: #FF3B30;
            --revolut-orange: #FF9500;
            --bitcoin-orange: #F7931A;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --border-color: #38383A;
            --accent-purple: #5856D6;
            --accent-cyan: #32D4F0;
            --bottom-nav-height: 80px;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --bg-primary: #000000;
            --bg-secondary: #0a0a15;
            --bg-tertiary: #1a1a2e;
            --accent-dark-blue: #16213e;
            --accent-dark-yellow: #2d2410;
            /* Pour les appareils avec encoche/Dynamic Island */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
        }

        /* Fix spécifique pour iOS Safari */
        @supports (-webkit-touch-callout: none) {
            .main-content {
                padding-bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 60px);
                min-height: calc(100vh - 200px);
            }

            .all-transactions-content {
                padding-bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 60px);
            }

            /* Forcer le body à avoir une hauteur minimum */
            body {
                min-height: 100vh;
                min-height: -webkit-fill-available;
            }

            html {
                height: -webkit-fill-available;
            }
        }

        /* Amélioration pour les appareils avec safe-area */
        @supports (padding: max(0px)) {
            .main-content {
                padding-bottom: max(calc(var(--bottom-nav-height) + 40px), calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 40px));
            }

            .all-transactions-content {
                padding-bottom: max(calc(var(--bottom-nav-height) + 40px), calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 40px));
            }
        }

        /* Fix pour les modales aussi */
        .modal-content {
            max-height: calc(90vh - var(--safe-area-bottom));
            margin-bottom: var(--safe-area-bottom);
        }

        /* Assurer que tous les contenus dans les pages ont assez d'espace */
        .bitcoin-card:last-child,
        .portfolio:last-child,
        .tools:last-child,
        .settings:last-child {
            margin-bottom: 40px;
        }

        /* Reset et styles de base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            width: 100%;
            height: 100%;
            overflow: auto;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            touch-action: auto;
            background-color: #000000;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui, sans-serif;
            width: 100vw;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            touch-action: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-x: none;
            overscroll-behavior-y: auto;
            color: var(--text-primary);
            position: relative;
            margin: 0;
            padding: 0;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: url("assets/Aura.png");
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            z-index: -1;
            filter: contrast(120%) brightness(100%);
        }

        /* Icons SVG*/
        .action-icon svg,
        .nav-icon svg {
            color: inherit;
            transition: all 0.3s ease;
        }

        .action-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Animations */
        @keyframes floatSubtle1 {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.03;
            }

            25% {
                transform: translate(-15px, -20px) scale(1.02);
                opacity: 0.06;
            }

            50% {
                transform: translate(10px, -25px) scale(0.98);
                opacity: 0.04;
            }

            75% {
                transform: translate(-5px, -10px) scale(1.01);
                opacity: 0.07;
            }
        }

        @keyframes floatSubtle2 {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.02;
            }

            33% {
                transform: translate(20px, 15px) scale(1.03);
                opacity: 0.05;
            }

            66% {
                transform: translate(-10px, 25px) scale(0.97);
                opacity: 0.03;
            }
        }

        @keyframes gentlePulse {

            0%,
            100% {
                opacity: 0.03;
                transform: scale(1);
            }

            50% {
                opacity: 0.08;
                transform: scale(1.02);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Écran de chargement */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000000;
            display: flex;
            align-items: flex-start;
            /* ← CHANGE ICI */
            justify-content: center;
            padding-top: 40vh;
            /* ← AJOUTE CETTE LIGNE pour positionner à 40% de l'écran */
            z-index: 99999;
            transition: opacity 0.8s ease, visibility 0.8s ease;
            overflow: hidden;
        }

        .loading-screen.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        .loading-text {
            font-size: 48px;
            font-weight: 300;
            color: var(--text-primary);
            letter-spacing: 5px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            position: relative;
            z-index: 2;
            visibility: hidden;
        }

        /* Effet lumineux directement sur le texte */
        .loading-text::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(88, 86, 214, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
        }

        /* Une fois que les lettres sont créées, rendre visible */
        .loading-text.letters-ready {
            visibility: visible;
        }

        /* Chaque lettre apparaît simplement */
        .loading-text .letter {
            display: inline-block;
            opacity: 0;
            color: var(--text-primary);
            animation: letterAppear 0.4s ease-out forwards;
        }

        .loading-text .letter:nth-child(1) {
            animation-delay: 0.1s;
        }

        .loading-text .letter:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-text .letter:nth-child(3) {
            animation-delay: 0.3s;
        }

        .loading-text .letter:nth-child(4) {
            animation-delay: 0.4s;
        }

        .loading-text .letter:nth-child(5) {
            animation-delay: 0.5s;
        }

        .loading-text .letter:nth-child(6) {
            animation-delay: 0.6s;
        }

        .loading-text .letter:nth-child(7) {
            animation-delay: 0.7s;
        }

        .loading-text .letter:nth-child(8) {
            animation-delay: 0.8s;
        }

        .loading-text .letter:nth-child(9) {
            animation-delay: 0.9s;
        }

        .loading-text .letter:nth-child(10) {
            animation-delay: 1.0s;
        }

        @keyframes letterAppear {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Effet de fond subtil et statique */
        /* Effet de fond subtil et statique */
        .loading-screen::before {
            content: '';
            position: absolute;
            top: 40vh;
            /* ← CHANGE pour suivre le texte */
            left: 50%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(88, 86, 214, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        /* Responsive pour mobile */
        @media (max-width: 768px) {
            .loading-text {
                font-size: 36px;
                letter-spacing: 3px;
            }

            .loading-screen::before {
                width: 300px;
                height: 300px;
            }
        }


        /* Container principal */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
            max-width: 100vw;
            position: relative;
            overflow-x: hidden;
            opacity: 0;
            /* ← AJOUTE CETTE LIGNE */
            visibility: hidden;
            /* ← AJOUTE CETTE LIGNE */
            transition: opacity 0.6s ease, visibility 0.6s ease;
            /* ← AJOUTE CETTE LIGNE */
        }

        .app-container.loaded {
            opacity: 1;
            visibility: visible;
        }

        /* Header */
        .header {
            background: transparent;
            padding: 100px 0px 0px;
            text-align: center;
            position: relative;
            border-bottom: 0px solid rgba(255, 255, 255, 0.03);
            flex-shrink: 0;
        }

        /* Carousel du header */
        .header-carousel {
            position: relative;
            width: 100%;
            overflow: hidden;
            z-index: 2;
            touch-action: pan-x;
            cursor: grab;
        }

        .header-carousel:active {
            cursor: grabbing;
        }

        .header-slides {
            display: flex;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0%);
            touch-action: pan-x;
        }

        .header-slide {
            width: 100%;
            flex-shrink: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            touch-action: pan-x;
        }

        .header-indicators {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            z-index: 3;
        }

        .header-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .header-indicator.active {
            background: var(--text-primary);
            transform: scale(1.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
        }

        .account-type {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
            font-weight: 600;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .balance-amount {
            font-size: 48px;
            font-weight: 300;
            color: var(--text-primary);
            margin-bottom: 20px;
            letter-spacing: -1px;
            text-shadow: 0 0 40px rgba(255, 255, 255, 0.2);
        }

        .balance-button {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 12px 24px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .balance-button:hover {
            background: rgba(255, 255, 255, 0.18);
            transform: translateY(-2px);
        }

        /* Ajustement de l'espacement des pages */
        .page:not(.dashboard-page) {
            padding-top: 20px;
        }


        /* Header conditionnel selon la page */
        .header {
            background: transparent;
            padding: 100px 0px 0px;
            text-align: center;
            position: relative;
            border-bottom: 0px solid rgba(255, 255, 255, 0.03);
            flex-shrink: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .header.hidden {
            height: 0;
            overflow: hidden;
            padding: 0;
            opacity: 0;
            transform: translateY(-20px);
        }

        /* Fonds personnalisés pour certains logos */
        .suggestion-avatar img[src*="amazon-a.png"],
        .debtor-avatar-modern img[src*="amazon-a.png"],
        .transaction-icon img[src*="amazon-a.png"] {
            background: white;
            padding: 3px;
            border-radius: 50%;
        }

        .suggestion-avatar img[src*="office.png"],
        .debtor-avatar-modern img[src*="office.png"],
        .transaction-icon img[src*="office.png"] {
            background: white;
            padding: 3px;
            border-radius: 50%;
        }

        .suggestion-avatar img[src*="deezer.png"],
        .debtor-avatar-modern img[src*="deezer.png"],
        .transaction-icon img[src*="deezer.png"] {
            background: black;
            padding: 3px;
            border-radius: 50%;
        }

        .suggestion-avatar img[src*="openai.png"],
        .debtor-avatar-modern img[src*="openai.png"],
        .transaction-icon img[src*="openai.png"] {
            background: white;
            padding: 3px;
            border-radius: 50%;
        }

        /* Règle universelle pour masquer toutes les barres de scroll */
        * {
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* Internet Explorer 10+ */
        }

        *::-webkit-scrollbar {
            display: none;
            /* Webkit browsers */
        }



        /* Masquer les actions rapides quand le header est masqué */
        .app-container.header-hidden .quick-actions {
            opacity: 0;
            transform: translateY(-20px);
            height: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }

        .quick-actions::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(88, 86, 214, 0.12) 0%, transparent 80%);
            animation: gentlePulse 12s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        .action-icon {
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: rgba(44, 44, 46, 0.6);
            backdrop-filter: blur(30px);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 24px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
        }

        .action-icon:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .action-icon svg {
            color: white;
            fill: none;
        }

        .action-icon svg path {
            stroke: white;
        }


        .action-label {
            font-size: 12px;
            color: var(--text-primary);
            font-weight: 500;
            text-align: center;
            max-width: 80px;
        }

        .stats-grid,
        .transaction-card,
        .stat-card {
            margin-bottom: 20px;
            /* Assurer un espacement en bas */
        }

        .transaction-card:last-child,
        .stat-card:last-child {
            margin-bottom: 40px;
            /* Plus d'espace pour le dernier élément */
        }

        /* Contenu principal avec scroll parfait */
        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 100px 16px calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 40px);
            /* ← CHANGÉ : de 12px à 16px */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: auto;
            touch-action: auto;
            min-height: calc(100vh - 280px);
        }

        /* SOLUTION : Ajouter un padding-top spécifique pour chaque page */
        #portfolio,
        #bitcoin,
        #calendar,
        #settings,
        #debtors,
        #data-management,
        #tools,
        #budget {
            padding-top: 80px !important;
        }

        /* Pour la page dashboard (elle a son propre header) */
        #dashboard {
            padding-top: 20px !important;
        }

        /* Pour all-transactions */
        #all-transactions {
            padding-top: 0 !important;
            /* Elle gère son propre padding */
        }

        .page {
            display: none;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: calc(100vh - var(--bottom-nav-height) - var(--safe-area-bottom));
            padding-bottom: 40px;
            padding: 120px 16px calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 40px);
            /* ← CHANGÉ : de 12px à 16px */
        }

        .page.active {
            display: block;
        }

        /* Fix spécifique pour iOS en mode PWA */
        @supports (-webkit-touch-callout: none) {
            .search-container {
                padding-top: calc(16px + var(--safe-area-top));
                min-height: calc(60px + var(--safe-area-top));
            }

            .app-container {
                padding-top: 0;
                margin-top: 0;
            }

            /* Assurer que tout le contenu respecte les safe areas */
            /* Fix simple pour iOS Safari */
            body {
                padding-top: 20px;
                /* ← Réduit de 44px à 20px */
            }

            @media screen and (orientation: landscape) {
                body {
                    padding-top: 15px;
                    /* ← Réduit de 30px à 15px */
                }
            }

            /* Fix pour les modales qui peuvent être cachées */
            .modal-content {
                margin-top: var(--safe-area-top);
                max-height: calc(90vh - var(--safe-area-top) - var(--safe-area-bottom));
            }
        }

        /* Barre de recherche moderne */
        .search-container {
            display: flex;
            gap: 8px;
            padding: calc(8px + var(--safe-area-top)) 12px 12px;
            align-items: center;
            position: fixed;
            /* ← CHANGÉ de relative à fixed */
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            /* ← AJOUTÉ : fond semi-transparent */
            backdrop-filter: blur(20px);
            /* ← AJOUTÉ : effet de flou */
            -webkit-backdrop-filter: blur(20px);
            /* ← AJOUTÉ : pour Safari */
        }

        .search-bar {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 20px;
            /* Réduit de 22px à 20px */
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 14px 8px 36px;
            /* Encore plus compact */
            font-size: 14px;
            /* Réduit de 15px à 14px */
            color: var(--text-primary);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            font-weight: 500;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            height: 36px;
            /* Réduit de 40px à 36px */
            box-sizing: border-box;
            max-width: 220px;
            /* Réduit de 260px à 220px */
        }

        .search-bar::placeholder {
            color: rgba(255, 255, 255, 0.6);
            font-weight: 400;
        }

        .search-bar:focus {
            outline: none;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2), 0 0 0 2px rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            /* Réduit de 14px à 12px */
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            /* Réduit de 16px à 14px */
            height: 14px;
            color: rgba(255, 255, 255, 0.6);
            pointer-events: none;
            z-index: 1;
        }

        .chart-button {
            width: 36px;
            /* Réduit de 40px à 36px */
            height: 36px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            /* Réduit de 20px à 18px */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .chart-button:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .chart-button svg {
            width: 20px;
            height: 20px;
            color: var(--text-primary);
        }

        /* Menu profil en overlay */
        /* Menu profil en overlay */
        .profile-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            z-index: 10001;
            display: none;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .profile-menu.active {
            display: flex;
            opacity: 1;
        }

        /* Conteneur du menu */
        .profile-menu-container {
            background: rgba(10, 10, 11, 0.05);
            /* Changé pour correspondre au thème sombre avec transparence */
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            /* Ajouté pour Safari */
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* Bordure subtile */
            border-radius: 24px;
            width: 80%;
            height: 100vh;
            margin: 0 auto;
            padding: 0;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .profile-menu.active .profile-menu-container {
            transform: translateX(0);
        }

        /* Header du profil */
        .profile-menu-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            /* Changé pour être plus subtil */
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            /* Transparent */
        }

        .profile-menu-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            overflow: hidden;
            position: relative;
        }

        .profile-menu-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-menu-avatar svg {
            width: 28px;
            height: 28px;
            color: var(--text-secondary);
            /* Changé de rgba(0, 0, 0, 0.4) à var(--text-secondary) pour gris clair */
        }

        .profile-menu-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            /* Changé pour texte blanc */
            margin-bottom: 4px;
        }

        .profile-menu-email {
            font-size: 14px;
            color: var(--text-secondary);
            /* Changé pour texte gris */
            font-weight: 500;
        }

        .profile-menu-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            color: var(--text-primary);
            /* Changé pour texte blanc */
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
            font-size: 16px;
            font-weight: 500;
        }

        .profile-menu-item:hover {
            background: rgba(255, 255, 255, 0.08);
            /* Changé pour fond hover transparent */
        }

        .profile-menu-item:active {
            background: rgba(0, 0, 0, 0.08);
            transform: scale(0.98);
        }

        .profile-menu-icon {
            width: 20px;
            height: 20px;
            margin-right: 16px;
            color: var(--text-primary);
            /* Changé de rgba(0, 0, 0, 0.6) à var(--text-primary) pour blanc */
            flex-shrink: 0;
        }

        .profile-menu-text {
            flex: 1;
        }

        /* Séparateur */
        .profile-menu-separator {
            height: 1px;
            background: rgba(255, 255, 255, 0.08);
            /* Changé de rgba(0, 0, 0, 0.08) à blanc transparent */
            margin: 8px 20px;
        }

        /* Bouton de déconnexion avec style spécial */
        .profile-menu-item.logout {
            color: #ff3b30;
        }

        .profile-menu-item.logout .profile-menu-icon {
            color: #ff3b30;
            /* Garde le rouge pour la déconnexion */
        }

        /* Animation d'entrée pour les éléments */
        .profile-menu-item {
            opacity: 0;
            transform: translateX(-20px);
            animation: slideInProfileItem 0.3s ease forwards;
        }

        .profile-menu-item:nth-child(1) {
            animation-delay: 0.1s;
        }

        .profile-menu-item:nth-child(2) {
            animation-delay: 0.15s;
        }

        .profile-menu-item:nth-child(3) {
            animation-delay: 0.2s;
        }

        .profile-menu-item:nth-child(4) {
            animation-delay: 0.25s;
        }

        .profile-menu-item:nth-child(5) {
            animation-delay: 0.3s;
        }

        .profile-menu-item:nth-child(6) {
            animation-delay: 0.35s;
        }

        @keyframes slideInProfileItem {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .profile-menu-container {
                width: 300px;
                margin-left: 0px;
            }
        }



        /* style bitcoin */

        .bitcoin-container-modern {
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 0;
        }

        /* Carte principale avec stats */
        .main-stats-card-bitcoin {
            background: transparent;
            backdrop-filter: none;
            border: none;
            border-radius: 20px;
            padding: 28px;
            position: relative;
            overflow: hidden;
            box-shadow: none;
        }

        .main-stats-card-bitcoin::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            pointer-events: none;
            z-index: -1;
        }

        .primary-stat-bitcoin {
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .primary-number-bitcoin {
            font-size: 32px;
            font-weight: 300;
            color: var(--bitcoin-orange);
            margin-bottom: 8px;
            text-shadow: 0 2px 12px rgba(247, 147, 26, 0.4);
            letter-spacing: -1px;
        }

        .primary-label-bitcoin {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0;
        }

        .rarity-text-bitcoin {
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
            opacity: 0.8;
            line-height: 1.4;
            margin-top: 8px;
        }

        .rarity-highlight-bitcoin {
            color: var(--bitcoin-orange);
            font-weight: 600;
        }

        .secondary-stats-bitcoin {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .secondary-stat-bitcoin {
            text-align: center;
            padding: 16px 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }

        .secondary-stat-bitcoin:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-2px);
        }

        .secondary-number-bitcoin {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .secondary-label-bitcoin {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Graphique */
        .chart-container-bitcoin {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .chart-header-bitcoin {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title-bitcoin {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-period-bitcoin {
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.08);
            padding: 6px 12px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Transactions */
        .transactions-card-bitcoin {
            background: transparent;
            backdrop-filter: none;
            border: none;
            border-radius: 20px;
            padding: 24px 0;
            box-shadow: none;
        }

        .section-header-bitcoin {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title-bitcoin {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-badge-bitcoin {
            background: rgba(247, 147, 26, 0.2);
            color: var(--bitcoin-orange);
            font-size: 12px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 12px;
            border: 1px solid rgba(247, 147, 26, 0.3);
        }

        .transaction-item-bitcoin {
            display: flex;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.2s ease;
        }

        .transaction-item-bitcoin:hover {
            background: rgba(255, 255, 255, 0.03);
            margin: 0 -16px;
            padding: 16px 16px;
            border-radius: 12px;
        }

        .transaction-item-bitcoin:last-child {
            border-bottom: none;
        }

        .transaction-icon-bitcoin {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--bitcoin-orange), #FFB84D);
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            margin-right: 16px;
            box-shadow: 0 4px 16px rgba(247, 147, 26, 0.3);
        }

        .transaction-details-bitcoin {
            flex: 1;
        }

        .transaction-name-bitcoin {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .transaction-meta-bitcoin {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .transaction-btc-bitcoin {
            color: var(--bitcoin-orange);
            font-weight: 600;
        }

        .transaction-amount-bitcoin {
            text-align: right;
        }

        .transaction-price-bitcoin {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .transaction-date-bitcoin {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes fadeInUpBitcoin {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bitcoin-container-modern>* {
            animation: fadeInUpBitcoin 0.6s ease forwards;
        }

        .bitcoin-container-modern>*:nth-child(2) {
            animation-delay: 0.1s;
        }

        .bitcoin-container-modern>*:nth-child(3) {
            animation-delay: 0.2s;
        }

        /* Style outils */

        /* Cartes simulateur */
        .simulator-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .simulator-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .simulator-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
        }

        .simulator-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }

        .simulator-header p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
        }

        /* Formulaires */
        .simulator-form {
            margin: 20px 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--revolut-blue);
            background: rgba(255, 255, 255, 0.08);
        }

        /* Boutons simulateur */
        .simulator-btn {
            background: linear-gradient(135deg, var(--revolut-blue), #0056b3);
            border: none;
            color: white;
            padding: 14px 24px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 16px;
        }

        .simulator-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 122, 239, 0.3);
        }

        .simulator-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        /* Résultats */
        .simulator-results {
            margin-top: 24px;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-container h4 {
            color: var(--text-primary);
            font-size: 18px;
            margin-bottom: 16px;
        }

        .chart-placeholder {
            height: 120px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.05));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .result-amount {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .result-amount.green {
            color: var(--revolut-green);
        }

        .result-amount.blue {
            color: var(--revolut-blue);
        }

        .result-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .final-result {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(6, 182, 212, 0.1));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            padding: 32px 24px;
            text-align: center;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.1);
        }

        .final-result::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(16, 185, 129, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .final-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--revolut-green);
            margin-bottom: 12px;
            text-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            letter-spacing: -1px;
        }

        .final-label {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 16px;
            font-weight: 600;
        }

        .final-gain {
            font-size: 15px;
            color: var(--text-secondary);
            opacity: 0.9;
            font-weight: 500;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .final-amount {
                font-size: 24px;
            }
        }


        /* style analytics */

        /* Sélecteur de mois moderne */
        .analytics-month-selector-modern {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .month-nav-btn-modern {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-radius: 12px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .month-nav-btn-modern:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .current-month-modern {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            min-width: 160px;
            background: linear-gradient(135deg, rgba(88, 86, 214, 0.1), rgba(75, 0, 130, 0.05));
            padding: 12px 24px;
            border-radius: 16px;
            border: 1px solid rgba(88, 86, 214, 0.2);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            box-shadow: 0 4px 16px rgba(88, 86, 214, 0.1);
        }

        /* Grille d'indicateurs */
        .analytics-indicators-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 8px;
        }

        /* Styles pour la carte Bitcoin stacké */
        .bitcoin-stacked-card {
            background: linear-gradient(135deg, rgba(247, 147, 26, 0.08), rgba(255, 165, 0, 0.04));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(247, 147, 26, 0.2);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(247, 147, 26, 0.1);
        }

        .bitcoin-stacked-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 80% 20%, rgba(247, 147, 26, 0.12) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .bitcoin-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--bitcoin-orange);
            margin-bottom: 6px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .bitcoin-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .bitcoin-value {
            font-size: 12px;
            color: var(--bitcoin-orange);
            font-weight: 600;
            opacity: 0.8;
        }

        /* Mise à jour de la carte de variation */
        .balance-variation-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .balance-variation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(88, 86, 214, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .variation-amount {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 6px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .variation-amount.positive {
            color: var(--revolut-green);
        }

        .variation-amount.negative {
            color: var(--revolut-red);
        }

        .variation-amount.neutral {
            color: var(--text-secondary);
        }

        .variation-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .variation-breakdown {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            opacity: 0.8;
            gap: 8px;
        }

        .income-part {
            color: var(--revolut-green);
            font-weight: 600;
            flex: 1;
        }

        .expense-part {
            color: var(--revolut-red);
            font-weight: 600;
            flex: 1;
        }

        /* Responsive pour mobile */
        @media (max-width: 768px) {
            .analytics-indicators-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .analytics-month-selector-modern {
                gap: 16px;
                padding: 16px;
            }

            .current-month-modern {
                font-size: 18px;
                min-width: 140px;
                padding: 10px 20px;
            }

            .month-nav-btn-modern {
                width: 40px;
                height: 40px;
            }

            .variation-amount,
            .bitcoin-amount {
                font-size: 20px;
            }
        }

        /* Styles pour l'indicateur de variation du solde */
        .balance-variation-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            margin-bottom: 8px;
        }

        .balance-variation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(88, 86, 214, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .variation-amount {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .variation-amount.positive {
            color: var(--revolut-green);
        }

        .variation-amount.negative {
            color: var(--revolut-red);
        }

        .variation-amount.neutral {
            color: var(--text-secondary);
        }

        .variation-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 12px;
        }

        .variation-breakdown {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.8;
        }

        .income-part {
            color: var(--revolut-green);
            font-weight: 600;
        }

        .expense-part {
            color: var(--revolut-red);
            font-weight: 600;
        }

        /* Ajuster la modal Analytics pour plus d'espace */
        .analytics-modal .modal-content {
            max-width: 520px;
            width: 95%;
            max-height: 95vh;
        }

        /* Cartes d'action modernes - VERSION COMPACTE */
        .action-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px 16px;
            /* Réduit de 32px 24px */
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .action-card:hover {
            transform: translateY(-2px);
            /* Réduit de -4px */
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
            /* Réduit l'ombre */
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .action-card:hover::before {
            left: 100%;
        }

        .action-icon {
            width: 48px;
            /* Réduit de 64px */
            height: 48px;
            border-radius: 12px;
            /* Réduit de 16px */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            /* Réduit de 20px */
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
            /* Réduit l'ombre */
        }

        .action-card h3 {
            font-size: 16px;
            /* Réduit de 18px */
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 6px 0;
            /* Réduit de 8px */
        }

        .action-card p {
            font-size: 13px;
            /* Réduit de 14px */
            color: var(--text-secondary);
            margin: 0;
            opacity: 0.8;
        }

        /* Zone dangereuse */
        .danger-zone {
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding-top: 32px;
            /* Réduit de 40px */
            margin-top: 16px;
            /* Réduit de 20px */
        }

        .action-card.danger {
            border-color: rgba(239, 68, 68, 0.2);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.04));
        }

        .action-card.danger:hover {
            border-color: rgba(239, 68, 68, 0.4);
            box-shadow: 0 12px 32px rgba(239, 68, 68, 0.2);
            /* Réduit l'ombre */
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .action-card {
                padding: 16px 12px;
                /* Encore plus compact sur mobile */
            }

            .action-icon {
                width: 40px;
                /* Plus petit sur mobile */
                height: 40px;
                margin-bottom: 12px;
            }

            .action-card h3 {
                font-size: 15px;
            }

            .action-card p {
                font-size: 12px;
            }
        }

        /* Styles pour la nouvelle page "Toutes les transactions" */
        .all-transactions-content {
            height: calc(100vh - 140px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-top: 100px;
            /* ← CHANGÉ : de 80px à 100px */
            padding-bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 40px);
        }


        .month-selector-swipeable {
            position: sticky;
            top: 85px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 16px 20px;
            margin: 0 -16px 20px;
            /* ← CHANGÉ : de -12px à -16px pour compenser */
            margin-bottom: 12px;
            z-index: 99;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .month-pills-swipeable {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 4px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .month-pills-swipeable::-webkit-scrollbar {
            display: none;
        }

        .month-pill-swipeable {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: 10px 18px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
            min-width: fit-content;
        }

        .month-pill-swipeable.active {
            background: linear-gradient(135deg, var(--text-primary), rgba(255, 255, 255, 0.9));
            color: var(--revolut-dark);
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .month-pill-swipeable:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .sort-controls-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 12px 16px;
            margin: 0 0 16px 0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .sort-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .sort-select {
            flex: 1;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23FFFFFF' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .sort-select:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .sort-select:focus {
            border-color: var(--revolut-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 239, 0.1);
        }

        .sort-select option {
            background: var(--revolut-dark);
            color: var(--text-primary);
            padding: 8px;
        }

        .transaction-group {
            margin-bottom: 16px;
        }

        .date-group-header-main {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 12px 0 12px 4px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .transaction-card-glassmorphism {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            margin-bottom: 8px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .transaction-card-glassmorphism:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.2);
        }


        /* Résultats de recherche */
        .search-results {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 11, 0.98);
            backdrop-filter: blur(30px);
            z-index: 10000;
            display: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-overlay {
            padding: 60px 20px 20px;
            height: 100vh;
            overflow-y: auto;
        }

        .search-overlay-full {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .search-header-compact {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0 10px;
        }

        .search-header-full {
            display: flex;
            align-items: center;
            padding: 60px 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .back-arrow {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin-right: 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .back-arrow:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex: 1;
        }

        .show-all-inline {
            background: none;
            border: none;
            color: var(--revolut-blue);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .show-all-inline:hover {
            background: rgba(0, 122, 239, 0.1);
        }

        .search-header-compact h3,
        .search-header-full h3 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .show-all-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 16px 0;
            text-align: center;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-top: 12px;
            width: 100%;
        }

        .show-all-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-1px);
        }


        .month-selector-sticky {
            position: sticky;
            top: 0;
            background: rgba(10, 10, 11, 0.98);
            backdrop-filter: blur(30px);
            padding: 10px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 100;
        }

        .month-pills {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 8px 0;
        }

        .month-pill {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .month-pill.active {
            background: var(--text-primary);
            color: var(--revolut-dark);
        }

        .transactions-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
        }

        .date-group-header {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 30px 0 20px 0;
            padding-left: 4px;
        }

        .search-transaction-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: rgba(44, 44, 46, 0.6);
            border-radius: 16px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-transaction-item:hover {
            background: rgba(44, 44, 46, 0.8);
        }

        .search-transaction-icon {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 20px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .search-transaction-icon.income {
            background: var(--revolut-green);
            color: white;
        }

        .search-transaction-icon.expense {
            background: var(--revolut-red);
            color: white;
        }

        .search-transaction-icon.bitcoin {
            background: var(--bitcoin-orange);
            color: white;
        }

        .search-transaction-details {
            flex: 1;
            min-width: 0;
        }

        .search-transaction-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .search-transaction-meta {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .search-transaction-amount {
            font-size: 18px;
            font-weight: 600;
            text-align: right;
            flex-shrink: 0;
        }

        .no-results {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
            font-size: 16px;
        }

        /* Modal Analytics */
        .analytics-modal .modal-content {
            max-width: 500px;
            width: 95%;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        #chartLegend {
            display: none;
        }

        /* Retire tous les conteneurs de navigation de mois */
        *[class*="month"],
        *[class*="date-selector"],
        *[class*="period"] {
            background: transparent !important;
            backdrop-filter: none !important;
            border: none !important;
            box-shadow: none !important;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(142, 142, 147, 0.12);
            border-radius: 8px;
            padding: 8px 12px;
        }

        .month-nav-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .month-nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .current-month {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            min-width: 120px;
            text-align: center;
        }

        .analytics-section {
            margin-bottom: 24px;
        }

        .analytics-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .summary-item {
            background: rgba(44, 44, 46, 0.6);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .summary-amount {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            background: rgba(44, 44, 46, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .chart-placeholder {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .category-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .category-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .category-amount {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Cartes */

        .transaction-card .card-header {
            display: none;
        }

        .transaction-card {
            background: transparent;
            backdrop-filter: none;
            border: none;
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: none;
            margin: 0 auto 16px auto;
            max-width: none !important;
            /* ← CHANGÉ : retire la limite de largeur */
            border-radius: 16px !important;
            padding: 0;
        }

        .transaction-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            pointer-events: none;
        }

        .transaction-card:hover {
            transform: none;
            box-shadow: none;
        }

        .card-header {
            padding: 20px 20px 0;
            border-bottom: 0px solid rgba(255, 255, 255, 0.03);
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        /* Grille de statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(44, 44, 46, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            background: rgba(44, 44, 46, 0.8);
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Éléments de transaction */



        .transaction-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .transaction-detail-item:last-child {
            border-bottom: none;
        }

        .transaction-detail-item strong {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .transaction-detail-item span {
            color: var(--text-primary);
            font-weight: 600;
        }


        #transactionDetailsContent {
            margin-bottom: 20px;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
            flex-shrink: 0;
        }

        .transaction-icon svg {
            color: white;
            fill: none;
        }

        .transaction-icon svg path,
        .transaction-icon svg circle,
        .transaction-icon svg line,
        .transaction-icon svg rect,
        .transaction-icon svg polyline {
            stroke: white;
        }

        .transaction-details {
            flex: 1;
            min-width: 0;
        }

        .transaction-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transaction-meta {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transaction-amount {
            font-size: 16px;
            font-weight: 600;
            text-align: right;
            flex-shrink: 0;
            color: var(--text-primary);
        }

        /* Style spécial pour la carte du graphique */
        .transaction-card-chart {
            background: transparent;
            border: none;
            margin-bottom: 16px;
            overflow: visible;
            position: relative;
            margin: 0 auto 16px auto;
            max-width: 350px !important;
        }

        /* Navigation bottom */
        .bottom-nav {
            position: fixed;
            bottom: 12px;
            left: 12px;
            right: 12px;
            z-index: 9999;
            height: 60px;
            padding: 0 12px;
            background: rgba(10, 10, 11, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 30px;
            /* ← CHANGÉ de 20px à 30px pour être plus arrondi */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transform: none !important;
            transition: none !important;
            box-sizing: border-box;
            width: auto;
            max-width: none;
            display: flex;
            align-items: center;
            transform: translateY(0);
            will-change: transform;
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
            /* ← Garde 100% */
            width: 100%;
            /* ← AJOUTÉ pour occuper toute la largeur */
            max-width: 500px;
            margin: 0 auto;
            gap: 4px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 10px 8px 4px 8px;
            /* ← CHANGÉ : plus de padding en haut (10px), moins en bas (4px) */
            border-radius: 16px;
            min-width: 50px;
            touch-action: manipulation;
            margin-top: 25px;
            /* ← AJOUTÉ : pousse les boutons vers le bas */
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 2px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .nav-item.active .nav-icon {
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .nav-label {
            font-size: 9px;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.3s ease;
            line-height: 1;
            /* ← AJOUTÉ pour meilleur alignement */
        }

        .nav-item.active .nav-label {
            color: var(--text-primary);
        }

        /* Boutons */
        .btn {
            background: var(--revolut-blue);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            margin-bottom: 12px;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(44, 44, 46, 0.8);
            color: var(--text-primary);
        }

        .btn-bitcoin {
            background: var(--bitcoin-orange);
        }

        .btn-green {
            background: var(--revolut-green);
        }

        .btn-red {
            background: var(--revolut-red);
        }

        .toggle-btn {
            background: rgba(44, 44, 46, 0.8);
            backdrop-filter: blur(20px);
            color: var(--text-primary);
            border: none;
            border-radius: 20px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 16px;
        }

        /* Bouton profil */
        .profile-button {
            width: 36px;
            /* Réduit de 40px à 36px */
            height: 36px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            /* Réduit de 20px à 18px */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .profile-button:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .profile-icon {
            width: 20px;
            height: 20px;
            color: var(--text-primary);
        }

        .profile-picture {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            /* Ajoute ça pour centrer l'image */
            border-radius: 18px;
        }

        .profile-picture-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(142, 142, 147, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .profile-picture-large:hover {
            background: rgba(142, 142, 147, 0.2);
        }

        .profile-picture-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            color: white;
        }

        .profile-picture-large:hover .upload-overlay {
            opacity: 1;
        }

        #authSubMenu .profile-menu-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 4px;
        }

        #authSubMenu .profile-menu-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Indicateur de connexion */
        .profile-button.connected::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: var(--revolut-green);
            border-radius: 50%;
            border: 1px solid var(--revolut-dark);
        }

        /* Formulaires */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            color: var(--text-primary);
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--revolut-blue);
            background: rgba(44, 44, 46, 0.9);
            box-shadow: 0 0 30px rgba(0, 122, 239, 0.2);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        /* Modales */

        /* Ajouter cette classe CSS */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* S'assurer que la modale peut scroller si nécessaire */
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            /* Permettre le scroll dans la modale si nécessaire */
            box-sizing: border-box;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            backdrop-filter: blur(10px);
            z-index: 10000;
            overflow-y: auto;
        }

        /* modal */
        /* Modal avec overlay noir */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            overflow-y: auto;
        }

        /* Conteneur de la modale avec fond noir */
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 10, 11, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
        }

        /* Styles pour les détails de transaction */
        .transaction-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .transaction-detail-item:last-child {
            border-bottom: none;
        }

        .transaction-detail-item strong {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 14px;
        }

        .transaction-detail-item span {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 16px;
        }

        /* Couleurs pour les montants */
        .transaction-detail-item span.positive {
            color: var(--revolut-green);
        }

        .transaction-detail-item span.negative {
            color: var(--revolut-red);
        }

        /* Couleurs pour les types */
        .transaction-detail-item span.income {
            color: var(--revolut-green);
        }

        .transaction-detail-item span.expense {
            color: var(--revolut-red);
        }

        /* Header de la modale */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            background: none;
            border: none;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .close:hover {
            background: rgba(44, 44, 46, 0.8);
            color: var(--text-primary);
        }

        /* Boutons dans les modales */
        .modal-content .btn {
            background: var(--revolut-blue);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            margin-bottom: 12px;
        }

        .modal-content .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .modal-content .btn-secondary {
            background: rgba(44, 44, 46, 0.8);
            color: var(--text-primary);
        }

        .modal-content .btn-red {
            background: var(--revolut-red);
        }

        .modal-content .btn-red:hover {
            background: #cc2e24;
        }

        /* Classe pour bloquer le scroll */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* Calendrier iOS Minimal */
        .calendar-container {
            padding: 20px 16px;
            /* Retire le padding horizontal */
            margin-bottom: 20px;
            max-width: 400px;
            margin: 0 auto 16px auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0 20px 0;
            margin-bottom: 15px;
            border-bottom: none;
        }

        .calendar-nav {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: none;
            color: var(--text-primary);
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .calendar-nav:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            padding: 12px 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            background: transparent;
            color: var(--text-primary);
            border: 1px solid transparent;
            font-size: 16px;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }

        .calendar-day.today {
            background: rgba(0, 122, 255, 0.8);
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
        }

        .calendar-day.other-month {
            opacity: 0.4;
            color: rgba(255, 255, 255, 0.5);
        }

        .calendar-day.has-transaction::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--revolut-green);
            border-radius: 50%;
        }

        /* Forcer le calendrier à rester dans les limites */
        .calendar-container .calendar-grid {
            border-radius: 16px;
            overflow: hidden;
            margin: 0;
        }

        .calendar-container .calendar-day {
            border-radius: 8px;
        }

        .calendar-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(0, 122, 239, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            border-radius: 24px;
        }



        .calendar-nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: none;
            color: var(--text-primary);
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .calendar-nav:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }

        .calendar-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            flex: 1;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            background: linear-gradient(135deg, rgba(48, 41, 86, 0.15), rgba(185, 119, 47, 0.2));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            padding: 8px 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 0;
            /* AJOUTE CETTE LIGNE */
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            position: relative;
            background: transparent;
            color: var(--text-primary);
            border: 1px solid transparent;
            min-width: 0;
            /* AJOUTE CETTE LIGNE */
            font-size: 14px;
            /* AJOUTE CETTE LIGNE pour mobile */
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .calendar-day.today {
            background: var(--revolut-blue);
            color: white;
            font-weight: 700;
        }

        .calendar-day.has-transaction::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--revolut-green);
            border-radius: 50%;
        }

        .calendar-day.future {
            opacity: 0.5;
            color: var(--text-secondary);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            color: var(--text-secondary);
        }

        /* Fix pour le calendrier sur mobile */
        @media (max-width: 768px) {
            .calendar-grid {
                gap: 3px;
                /* Réduit l'espace entre les cases */
                padding: 16px;
                /* Réduit le padding */
            }

            .calendar-day {
                font-size: 13px;
                /* Plus petit sur mobile */
                min-height: 36px;
                /* Hauteur minimum */
            }

            .day-header {
                font-size: 10px;
                /* Plus petit sur mobile */
                padding: 6px 2px;
                /* Réduit le padding */
            }
        }

        @media (max-width: 360px) {
            .calendar-grid {
                gap: 2px;
                /* Encore plus petit pour très petits écrans */
                padding: 12px;
            }

            .calendar-day {
                font-size: 12px;
                min-height: 32px;
            }

            .day-header {
                font-size: 9px;
                padding: 4px 1px;
            }
        }

        /* Stats du mois dans le calendrier */
        .calendar-month-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .calendar-stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .calendar-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .calendar-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-stat-value.positive {
            color: var(--revolut-green);
        }

        .calendar-stat-value.negative {
            color: var(--revolut-red);
        }

        .calendar-stat-value.bitcoin {
            color: var(--bitcoin-orange);
        }

        /* Graphique moderne avec glassmorphisme */
        .chart-container-modern {
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.04) 0%,
                    rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 40px;
            position: relative;
            overflow: visible;
            box-shadow:
                0 20px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .chart-container-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(0, 122, 239, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 149, 0, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .chart-header-modern {
            text-align: center;
            margin-bottom: 32px;
        }

        .chart-title-modern {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .chart-subtitle-modern {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Graphique donut moderne */
        .chart-donut-wrapper {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto 32px;
            overflow: visible;
            /* AJOUT */
            padding: -20px;
            /* AJOUT pour donner de l'espace */
        }

        .chart-donut {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.3));
        }


        .chart-segment-modern {
            fill: none;
            stroke-width: 40;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.9;
        }

        .chart-segment-modern:hover {
            stroke-width: 45;
            opacity: 1;
            filter: brightness(1.2);
        }

        /* Centre du donut */
        .chart-center-modern {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.15) 0%,
                    rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .chart-total-modern {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .chart-label-modern {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Légende moderne */
        .chart-legend-modern {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .legend-item-modern {
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.08) 0%,
                    rgba(255, 255, 255, 0.04) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .legend-item-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .legend-item-modern:hover {
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.12) 0%,
                    rgba(255, 255, 255, 0.08) 100%);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .legend-item-modern:hover::before {
            left: 100%;
        }

        .legend-color-modern {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .legend-color-modern::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            opacity: 0.7;
        }

        .legend-details-modern {
            flex: 1;
            min-width: 0;
        }

        .legend-name-modern {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            text-transform: capitalize;
        }

        .legend-amount-modern {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .legend-percentage-modern {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: right;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* État vide */
        .chart-empty-modern {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 280px;
            color: var(--text-secondary);
            text-align: center;
        }

        .chart-empty-icon-modern {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .chart-empty-text-modern {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .chart-empty-subtext-modern {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Animations */
        @keyframes drawChartModern {
            from {
                stroke-dasharray: 0 628;
            }

            to {
                stroke-dasharray: var(--dash-array) 628;
            }
        }

        .chart-segment-modern {
            animation: drawChartModern 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes fadeInUpModern {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .legend-item-modern {
            animation: fadeInUpModern 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Tooltip moderne */
        .chart-tooltip-modern {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-tooltip-modern.visible {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chart-container-modern {
                padding: 20px 16px;
            }

            .chart-donut-wrapper {
                width: 240px;
                height: 240px;
            }

            .chart-center-modern {
                width: 100px;
                height: 100px;
            }

            .chart-total-modern {
                font-size: 18px;
            }

            .chart-legend-modern {
                grid-template-columns: 1fr;
            }
        }

        /* Spécifiques */
        .bitcoin-card {
            background: linear-gradient(135deg, rgba(247, 147, 26, 0.05), rgba(255, 165, 0, 0.02));
            border: 1px solid rgba(247, 147, 26, 0.1);
        }

        .bitcoin-quantity-group {
            display: none;
            background: rgba(247, 147, 26, 0.05);
            border: 1px solid rgba(247, 147, 26, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            backdrop-filter: blur(20px);
        }

        /* Responsive mobile */
        @media (max-width: 768px) {
            .header {
                padding: 50px 16px 30px;
            }

            .balance-amount {
                font-size: 36px;
            }

            .quick-actions {
                padding: 0 16px 20px;
                justify-content: space-between;
            }

            .action-icon {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }

            .action-label {
                font-size: 11px;
                max-width: 70px;
            }

            .main-content {
                padding: 0 16px calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 20px);
            }

            .bottom-nav {
                padding: 8px 16px calc(8px + var(--safe-area-bottom));
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-number {
                font-size: 20px;
            }

            .modal-content {
                width: 95vw;
                max-width: 95vw;
            }

            .calendar-day {
                min-height: 40px;
                font-size: 14px;
                padding: 6px 4px;
            }

            .day-header {
                padding: 8px 4px;
                font-size: 10px;
            }
        }

        @media (max-width: 360px) {
            .balance-amount {
                font-size: 32px;
            }

            .action-icon {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }

            .main-content {
                padding: 0 12px calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 20px);
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
        }

        * {
            -webkit-overflow-scrolling: touch;
        }

        /* Touch action par défaut sauf pour le header carousel */
        body,
        .main-content,
        .page {
            touch-action: auto;
        }

        /* SAUF pour les inputs (éviter le zoom iOS) */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {

            select,
            textarea,
            input[type="text"],
            input[type="password"],
            input[type="email"],
            input[type="number"],
            input[type="tel"],
            input[type="url"] {
                font-size: 16px !important;
            }
        }

        /* Garder la barre de recherche visible sur la page all-transactions */
        body.all-transactions-active .search-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(10, 10, 11, 0.98);
            backdrop-filter: blur(30px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin: 0;
            padding: 20px;
        }

        /* Ajuster le contenu pour compenser la barre fixe */
        body.all-transactions-active .all-transactions-content {
            padding-top: 20px;
        }

        /* Masquer les autres barres de recherche sur all-transactions */
        body.all-transactions-active #all-transactions .search-container {
            display: none;
        }

        /* Styles pour la page Portfolio moderne */
        .main-stats-card-portfolio {
            background: transparent;
            backdrop-filter: none;
            border: none;
            border-radius: 20px;
            padding: 28px;
            position: relative;
            overflow: hidden;
            box-shadow: none;
            margin-bottom: 24px;
        }

        .main-stats-card-portfolio::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            pointer-events: none;
            z-index: -1;
        }

        .primary-stat-portfolio {
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .primary-number-portfolio {
            font-size: 32px;
            font-weight: 300;
            color: var(--revolut-blue);
            margin-bottom: 8px;
            text-shadow: 0 2px 12px rgba(59, 130, 246, 0.4);
            letter-spacing: -1px;
        }

        .primary-label-portfolio {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0;
        }

        .secondary-stats-portfolio {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .secondary-stat-portfolio {
            text-align: center;
            padding: 16px 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }

        .secondary-stat-portfolio:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-2px);
        }

        .secondary-number-portfolio {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .secondary-label-portfolio {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Graphique portfolio */
        .chart-container-portfolio {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            margin-bottom: 24px;
        }

        .chart-header-portfolio {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title-portfolio {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-period-portfolio {
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.08);
            padding: 6px 12px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Carte des actifs */
        .assets-card-portfolio {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .section-header-portfolio {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title-portfolio {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .add-asset-btn-portfolio {
            background: linear-gradient(135deg, var(--revolut-blue), #0056b3);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .add-asset-btn-portfolio:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
        }

        /* Éléments d'actifs modernes - VERSION SIMPLIFIÉE */
        .asset-item-portfolio {
            position: relative;
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.2s ease;
            border-radius: 12px;
        }

        .asset-item-portfolio:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .asset-item-portfolio:last-child {
            border-bottom: none;
        }

        .asset-content-portfolio {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .asset-icon-portfolio {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--revolut-blue), #0056b3);
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 12px;
            margin-right: 16px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        .asset-details-portfolio {
            flex: 1;
            min-width: 0;
            /* Permet au texte de se tronquer si nécessaire */
            margin-right: 16px;
        }

        .asset-name-portfolio {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .asset-meta-portfolio {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .asset-quantity-portfolio {
            color: var(--revolut-blue);
            font-weight: 600;
        }

        .asset-investment-portfolio {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .asset-price-portfolio {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            flex-shrink: 0;
        }

        .asset-value-portfolio {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .asset-pnl-portfolio {
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .asset-pnl-portfolio.positive {
            color: var(--revolut-green);
        }

        .asset-pnl-portfolio.negative {
            color: var(--revolut-red);
        }

        .asset-pnl-portfolio.neutral {
            color: var(--text-secondary);
        }

        /* Bouton modifier en position absolue */
        .asset-actions-portfolio {
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .asset-action-btn-portfolio {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: var(--text-primary);
            padding: 6px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .asset-action-btn-portfolio:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        /* Responsive pour mobile */
        @media (max-width: 768px) {
            .asset-meta-portfolio {
                font-size: 12px;
            }

            .asset-name-portfolio {
                font-size: 14px;
            }

            .asset-value-portfolio {
                font-size: 14px;
            }

            .asset-pnl-portfolio {
                font-size: 11px;
            }
        }

        /* Styles pour les débiteurs */
        .debtor-picture-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .debtor-picture-preview:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .debtor-item-modern {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            border-radius: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .debtor-item-modern:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
        }

        .debtor-info-modern {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .debtor-avatar-modern {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .debtor-avatar-modern img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .debtor-avatar-modern svg {
            width: 24px;
            height: 24px;
            color: var(--text-secondary);
        }

        .debtor-name-modern {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .debtor-usage-modern {
            font-size: 13px;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* Autocomplete suggestions */
        .transaction-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(28, 28, 30, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .suggestion-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .suggestion-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .suggestion-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Styles Budget */

        /* Conteneur unique pour toutes les catégories */
        .budget-categories-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            margin-bottom: 24px;
        }

        /* Carte de catégorie budget simplifiée */
        .category-budget-card-clean {
            padding: 20px;
            transition: all 0.2s ease;
            margin: 0;
            border-radius: 0;
            background: transparent;
            backdrop-filter: none;
            box-shadow: none;
            position: relative;
        }

        .category-budget-card-clean:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20px;
            right: 20px;
            height: 1px;
            background: rgba(255, 255, 255, 0.06);
        }

        .category-budget-card-clean:hover {
            background: rgba(255, 255, 255, 0.03);
            transform: none;
            box-shadow: none;
        }

        /* Styles modernes pour la page Gestion des Catégories */
        .categories-page-modern {
            max-width: 500px;
            margin: 0 auto;
            padding: 0;
        }

        .categories-header-modern {
            text-align: center;
            margin-bottom: 32px;
            padding: 20px 0;
        }

        .categories-title-modern {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .categories-subtitle-modern {
            font-size: 15px;
            color: var(--text-secondary);
            margin: 0;
            opacity: 0.8;
        }

        .categories-container-modern {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            margin-bottom: 24px;
        }

        .category-item-modern {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            transition: all 0.2s ease;
            position: relative;
        }

        .category-item-modern:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20px;
            right: 20px;
            height: 1px;
            background: rgba(255, 255, 255, 0.06);
        }

        .category-item-modern:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .category-info-modern {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .category-icon-modern {
            width: 44px;
            height: 44px;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .category-icon-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 50%;
        }

        .category-details-modern {
            flex: 1;
            min-width: 0;
        }

        .category-name-modern {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .category-usage-modern {
            font-size: 13px;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .category-actions-modern {
            display: flex;
            gap: 8px;
        }

        .category-action-btn-modern {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 70px;
            text-align: center;
        }

        .category-action-btn-modern:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .category-action-btn-modern.delete {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
            color: var(--revolut-red);
        }

        .category-action-btn-modern.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
        }

        .category-required-modern {
            background: rgba(142, 142, 147, 0.12);
            border: 1px solid rgba(142, 142, 147, 0.2);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .add-category-modern {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .add-category-header-modern {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .add-category-icon-modern {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--revolut-blue), #1d4ed8);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .add-category-title-modern {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .add-category-form-modern {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .form-group-modern {
            flex: 1;
        }

        .form-label-modern {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input-modern {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-input-modern:focus {
            outline: none;
            border-color: var(--revolut-blue);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .form-input-modern::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .add-btn-modern {
            background: linear-gradient(135deg, var(--revolut-blue), #1d4ed8);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .add-btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
        }

        /* Couleurs pour les icônes de catégories */
        .category-icon-modern.bitcoin {
            background: linear-gradient(135deg, var(--bitcoin-orange), #FFB84D);
        }

        .category-icon-modern.alimentation {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .category-icon-modern.transport {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .category-icon-modern.carburant {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .category-icon-modern.credit {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .category-icon-modern.loyer {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .category-icon-modern.loisirs {
            background: linear-gradient(135deg, #ec4899, #db2777);
        }

        .category-icon-modern.sante {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }

        .category-icon-modern.shopping {
            background: linear-gradient(135deg, #f97316, #ea580c);
        }

        .category-icon-modern.divers {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .category-icon-modern.investissement {
            background: linear-gradient(135deg, #10b981, #047857);
        }

        .category-icon-modern.remboursement {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        }

        /* Animation d'apparition */
        @keyframes fadeInCategory {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .category-item-modern {
            animation: fadeInCategory 0.4s ease forwards;
        }

        .category-item-modern:nth-child(1) {
            animation-delay: 0.1s;
        }

        .category-item-modern:nth-child(2) {
            animation-delay: 0.15s;
        }

        .category-item-modern:nth-child(3) {
            animation-delay: 0.2s;
        }

        .category-item-modern:nth-child(4) {
            animation-delay: 0.25s;
        }

        .category-item-modern:nth-child(5) {
            animation-delay: 0.3s;
        }

        .category-item-modern:nth-child(6) {
            animation-delay: 0.35s;
        }

        .category-item-modern:nth-child(7) {
            animation-delay: 0.4s;
        }

        .category-item-modern:nth-child(8) {
            animation-delay: 0.45s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .categories-page-modern {
                padding: 0 12px;
            }

            .category-item-modern {
                padding: 16px;
            }

            .category-icon-modern {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .add-category-form-modern {
                flex-direction: column;
                gap: 16px;
            }

            .add-btn-modern {
                width: 100%;
            }
        }

        /* Header simplifié */
        .budget-category-header-clean {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .budget-category-name-clean {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: capitalize;
        }

        /* Montants en une ligne */
        .budget-amounts-clean {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .budget-spent-clean {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .budget-total-clean {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .budget-remaining-clean {
            font-size: 14px;
            font-weight: 600;
        }

        .budget-remaining-clean.positive {
            color: var(--revolut-green);
        }

        .budget-remaining-clean.negative {
            color: var(--revolut-red);
        }

        /* Barre de progression épurée */
        .budget-progress-bar-clean {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .budget-progress-fill-clean {
            height: 100%;
            border-radius: 4px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .budget-progress-fill-clean.safe {
            background: linear-gradient(90deg, var(--revolut-green), #22c55e);
        }

        .budget-progress-fill-clean.warning {
            background: linear-gradient(90deg, var(--revolut-orange), #f59e0b);
        }

        .budget-progress-fill-clean.danger {
            background: linear-gradient(90deg, var(--revolut-red), #ef4444);
        }

        .budget-progress-fill-clean::after {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            width: calc(100% - 2px);
            height: calc(100% - 2px);
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.15), transparent);
            border-radius: 3px;
        }

        .budget-month-selector-modern {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .budget-nav-btn-modern {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-radius: 12px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .budget-nav-btn-modern:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .current-budget-month-modern {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            min-width: 160px;
            background: linear-gradient(135deg, rgba(88, 86, 214, 0.1), rgba(75, 0, 130, 0.05));
            padding: 12px 24px;
            border-radius: 16px;
            border: 1px solid rgba(88, 86, 214, 0.2);
            box-shadow: 0 4px 16px rgba(88, 86, 214, 0.1);
        }

        .budget-overview-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 28px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 24px;
            text-align: center;
        }

        .budget-overview-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(0, 122, 239, 0.08) 0%, transparent 60%);
            pointer-events: none;
            z-index: -1;
        }

        .budget-total-amount {
            font-size: 32px;
            font-weight: 300;
            color: var(--revolut-blue);
            margin-bottom: 8px;
            text-shadow: 0 2px 12px rgba(0, 122, 239, 0.4);
            letter-spacing: -1px;
        }

        .budget-status-text {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .category-budget-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .category-budget-card:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .budget-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .budget-category-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: capitalize;
        }

        .budget-edit-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: var(--text-primary);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .budget-edit-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .budget-progress-container {
            margin-bottom: 16px;
        }

        .budget-amounts {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .budget-spent {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .budget-total {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .budget-remaining {
            font-size: 14px;
            font-weight: 600;
        }

        .budget-remaining.positive {
            color: var(--revolut-green);
        }

        .budget-remaining.negative {
            color: var(--revolut-red);
        }

        .budget-progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .budget-progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .budget-progress-fill.safe {
            background: linear-gradient(90deg, var(--revolut-green), #22c55e);
        }

        .budget-progress-fill.warning {
            background: linear-gradient(90deg, var(--revolut-orange), #f59e0b);
        }

        .budget-progress-fill.danger {
            background: linear-gradient(90deg, var(--revolut-red), #ef4444);
        }

        .budget-progress-fill::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: calc(100% - 4px);
            height: calc(100% - 4px);
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 4px;
        }

        .budget-message {
            font-size: 14px;
            color: var(--text-secondary);
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid;
        }

        .budget-message.safe {
            border-left-color: var(--revolut-green);
        }

        .budget-message.warning {
            border-left-color: var(--revolut-orange);
        }

        .budget-message.danger {
            border-left-color: var(--revolut-red);
        }



        .budget-category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .budget-category-info {
            flex: 1;
        }

        .budget-category-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: capitalize;
            margin-bottom: 2px;
        }

        .budget-category-amount {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .budget-category-actions {
            display: flex;
            gap: 8px;
        }

        .budget-mini-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .budget-mini-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .budget-mini-btn.delete {
            color: var(--revolut-red);
        }

        .budget-mini-btn.delete:hover {
            background: rgba(255, 59, 48, 0.2);
        }

        .category-budget-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s ease;
        }

        .category-budget-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .category-budget-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: capitalize;
            min-width: 120px;
        }

        .category-budget-input {
            width: 120px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            text-align: right;
        }

        .category-budget-input:focus {
            outline: none;
            border-color: var(--revolut-blue);
            background: rgba(255, 255, 255, 0.08);
        }

        .category-budget-input::placeholder {
            color: var(--text-secondary);
            text-align: right;
        }

        .budget-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 12px;
            transition: all 0.2s ease;
        }

        .budget-status-indicator.active {
            background: var(--revolut-green);
            box-shadow: 0 0 8px rgba(48, 209, 88, 0.4);
        }

        .budget-status-indicator.inactive {
            background: var(--text-secondary);
            opacity: 0.3;
        }

        /* 🔥 SLIDE-UP TRANSACTION PAGE - Modern iOS Style */
        .slide-up-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 10001;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .slide-up-page.active {
            display: flex;
            opacity: 1;
        }

        .slide-up-content {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 95vh;
            background: linear-gradient(180deg, #1c1c1e 0%, #141416 100%);
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.6);
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .slide-up-page.active .slide-up-content {
            transform: translateY(0);
        }

        /* Header */
        .slide-up-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 20px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, #1c1c1e 0%, rgba(28, 28, 30, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 10;
        }

        .slide-up-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .slide-up-close:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }

        .slide-up-close:active {
            transform: scale(0.95);
        }

        .slide-up-title {
            font-size: 20px;
            font-weight: 600;
            color: white;
            margin: 0;
            letter-spacing: -0.5px;
        }

        /* Modern Form */
        .modern-form {
            padding: 24px 20px 40px;
        }

        .form-section {
            margin-bottom: 24px;
        }

        .modern-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modern-input {
            width: 100%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            color: white;
            font-size: 17px;
            font-weight: 400;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .modern-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(48, 209, 88, 0.5);
            box-shadow: 0 0 0 4px rgba(48, 209, 88, 0.1);
        }

        .modern-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        textarea.modern-input {
            resize: vertical;
            min-height: 80px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .input-hint {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 6px;
        }

        /* Transaction Type Selector */
        .transaction-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 32px;
        }

        .type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            color: rgba(255, 255, 255, 0.6);
            font-size: 15px;
            font-weight: 500;
            gap: 8px;
        }

        .type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .type-btn:active {
            transform: translateY(0);
        }

        .type-btn svg {
            transition: transform 0.3s ease;
        }

        .type-btn.active {
            border-color: transparent;
            color: white;
        }

        .type-btn-income.active {
            background: linear-gradient(135deg, #30d158 0%, #28a745 100%);
            box-shadow: 0 8px 24px rgba(48, 209, 88, 0.4);
        }

        .type-btn-expense.active {
            background: linear-gradient(135deg, #ff453a 0%, #d32f2f 100%);
            box-shadow: 0 8px 24px rgba(255, 69, 58, 0.4);
        }

        .type-btn.active svg {
            transform: scale(1.1);
        }

        /* Amount Input Special Styling */
        .amount-input-wrapper {
            position: relative;
        }

        .amount-input {
            padding-right: 50px;
            font-size: 32px;
            font-weight: 600;
            text-align: left;
        }

        .currency-symbol {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.4);
            pointer-events: none;
        }

        /* Toggle Switch */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            border-radius: 31px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 0;
            bottom: 0;
            background: white;
            transition: all 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #30d158 0%, #28a745 100%);
            border-color: transparent;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Submit Button */
        .modern-submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 32px;
            box-shadow: 0 8px 24px rgba(0, 122, 255, 0.3);
        }

        .modern-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 122, 255, 0.4);
        }

        .modern-submit-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
        }

        /* Animations */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .slide-up-content {
                max-height: 100vh;
                border-radius: 20px 20px 0 0;
            }

            .amount-input {
                font-size: 28px;
            }

            .currency-symbol {
                font-size: 20px;
            }
        }

        /* Smooth scrolling for the form */
        .slide-up-content {
            scroll-behavior: smooth;
        }

        /* Custom scrollbar for the slide-up page */
        .slide-up-content::-webkit-scrollbar {
            width: 8px;
        }

        .slide-up-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .slide-up-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .slide-up-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>

<body>

    <!-- Écran de chargement -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-text"> Movo</div>
    </div>

    <div class="app-container">

        <!-- Barre de recherche avec profil à gauche -->
        <div class="search-container">
            <button class="profile-button" onclick="toggleProfileMenu()" title="Menu Profil" id="profileButton">
                <svg class="profile-icon" viewBox="0 0 24 24" fill="none" id="profileIcon">
                    <path
                        d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <img class="profile-picture" id="profilePicture" style="display: none;" alt="Photo de profil">
            </button>

            <div style="position: relative; flex: 1;">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none">
                    <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" />
                    <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
                <input type="text" class="search-bar" placeholder="Rechercher" id="searchInput"
                    oninput="handleMainSearchInput(this.value)" onfocus="handleSearchFocus()">
                <div class="search-results" id="searchResults"></div>
            </div>

            <button class="chart-button" onclick="showModal('analyticsModal')" title="Analytics">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M22 12A10 10 0 0 0 12 2v10z" fill="currentColor" opacity="0.3" />
                </svg>
            </button>
        </div>

        <!-- Header avec carrousel -->
        <div class="header">
            <div class="header-carousel" id="headerCarousel">
                <div class="header-slides" id="headerSlides">
                    <!-- Slide 1: Solde Actuel -->
                    <div class="header-slide">
                        <div class="account-type">Personnel • Solde Actuel</div>
                        <div class="balance-amount" id="headerBalance">€0 | 0,00000000 BTC</div>

                    </div>

                    <!-- Slide 2: Total Actifs -->
                    <div class="header-slide">
                        <div class="account-type">Personnel • Total Actifs</div>
                        <div class="balance-amount" id="headerTotalAssets">€0 | 0,00000000 BTC</div>
                        <button class="balance-button" onclick="showPage('portfolio')">Voir Portefeuille</button>
                    </div>
                </div>
            </div>
            <div class="header-indicators">
                <div class="header-indicator active" onclick="goToHeaderSlide(0)"></div>
                <div class="header-indicator" onclick="goToHeaderSlide(1)"></div>
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="content">
            <!-- Page Dashboard -->
            <div id="dashboard" class="page active">
                <!-- Transactions récentes -->
                <div class="transaction-card">
                    <div id="recentTransactions">
                        <p style="text-align: center; color: var(--text-secondary); margin: 20px 0;">Aucune transaction
                        </p>
                    </div>
                    <button class="show-all-btn" onclick="showPage('all-transactions')">Tout afficher</button>
                </div>
            </div>

            <!-- Page Toutes Transactions -->
            <div id="all-transactions" class="page">
                <div class="search-container"
                    style="position: sticky; top: 0; z-index: 100; background: rgba(10, 10, 11, 0.95); backdrop-filter: blur(30px); padding: 16px 20px; margin: 0 -24px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                    <button class="profile-button" onclick="showPage('dashboard')" title="Retour"
                        style="margin-right: 12px;">
                        <svg viewBox="0 0 24 24" fill="none"
                            style="width: 20px; height: 20px; color: var(--text-primary);">
                            <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>

                    <div style="flex: 1; text-align: center;">
                        <h2 style="color: var(--text-primary); margin: 0; font-size: 18px; font-weight: 600;">
                            Toutes les transactions
                        </h2>
                    </div>

                    <div style="width: 36px;"></div> <!-- Spacer pour centrer le titre -->
                </div>

                <div class="month-selector-swipeable" id="monthSelectorSwipeable"
                    style="transform: translateY(-100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
                    <div class="month-pills-swipeable" id="monthPillsSwipeable"></div>
                </div>

                <!-- Sort Controls -->
                <div class="sort-controls-container">
                    <div class="sort-label">
                        <svg viewBox="0 0 24 24" fill="none" style="width: 16px; height: 16px;">
                            <path d="M3 6h18M7 12h10M11 18h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Trier par
                    </div>
                    <select id="transactionSortSelect" class="sort-select" onchange="applySortToTransactions()">
                        <option value="date-desc">Date (Plus récent)</option>
                        <option value="date-asc">Date (Plus ancien)</option>
                        <option value="amount-desc">Montant (Plus élevé)</option>
                        <option value="amount-asc">Montant (Plus faible)</option>
                        <option value="name-asc">Nom (A-Z)</option>
                        <option value="name-desc">Nom (Z-A)</option>
                    </select>
                </div>

                <div class="all-transactions-content" id="allTransactionsContent"
                    onscroll="handleAllTransactionsScroll()">
                    <div id="allTransactionsFiltered"></div>
                </div>
            </div>

            <!-- Page Calendrier -->
            <div id="calendar" class="page">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">‹</button>
                        <div class="calendar-title" id="calendarTitle">Calendrier Financier</div>
                        <button class="calendar-nav" onclick="changeMonth(1)">›</button>
                    </div>
                    <div id="calendarView"></div>

                    <!-- Stats du mois -->
                    <div class="calendar-month-stats" id="calendarMonthStats">
                        <div class="calendar-stat-item">
                            <div class="calendar-stat-value" id="monthEndBalance">€0 | 0,00000000 BTC</div>
                            <div class="calendar-stat-label">Solde fin de mois</div>
                        </div>
                        <div class="calendar-stat-item">
                            <div class="calendar-stat-value bitcoin" id="monthBitcoinStack">0 BTC</div>
                            <div class="calendar-stat-label">Bitcoin stacké</div>
                        </div>
                    </div>
                </div>

                <!-- Graphique moderne -->
                <div class="transaction-card-chart">
                    <div id="chart3D"></div>
                    <div id="chartLegend"></div>
                </div>

                <!-- Filtres et transactions -->
                <div class="transaction-card">
                    <div class="card-header">
                        <div class="card-title">Transactions du Mois</div>
                    </div>
                    <div id="monthTransactionsList"></div>
                </div>
            </div>

            <!-- Page Outils -->
            <div id="tools" class="page">
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 32px;">
                    <h1 style="font-size: 22px; font-weight: 600; color: var(--text-primary); margin: 0;">
                        Simulateurs
                    </h1>
                </div>

                <!-- Simulateur Intérêts Composés -->
                <div class="simulator-card">
                    <div class="simulator-header">
                        <div class="simulator-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                            <img src="icons/39382606-14da-4210-a397-d4c8674b1ff3.png" alt="Graphique exponentiel"
                                style="width: 30px; height: 30px; filter: brightness(0) invert(1);">
                        </div>
                        <div>
                            <h3>Intérêts Composés</h3>
                            <p>Simulez la croissance de votre capital</p>
                        </div>
                    </div>

                    <!-- Formulaire -->
                    <div class="simulator-form" id="compoundForm" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Capital initial (€)</label>
                                <input type="number" id="initialCapital" placeholder="10000" value="10000">
                            </div>
                            <div class="form-group">
                                <label>Versement mensuel (€)</label>
                                <input type="number" id="monthlyContribution" placeholder="500" value="500">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Taux annuel (%)</label>
                                <input type="number" id="interestRate" placeholder="7" value="7" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>Durée (années)</label>
                                <input type="number" id="years" placeholder="20" value="20">
                            </div>
                        </div>
                        <button class="simulator-btn" onclick="calculateCompoundInterest()">Calculer</button>
                    </div>

                    <!-- Résultats -->
                    <div class="simulator-results" id="compoundResults" style="display: none;">
                        <div class="chart-container" id="evolutionChart">
                            <h4>Évolution du Capital</h4>
                            <div class="chart-placeholder">Graphique ici</div>
                        </div>

                        <div class="results-grid">
                            <div class="result-card">
                                <div class="result-amount green" id="totalInvested">€130 | 0,00141 BTC 000</div>
                                <div class="result-label">Total Investi</div>
                            </div>
                            <div class="result-card">
                                <div class="result-amount blue" id="interestGained">€395 | 0,00428 BTC 522</div>
                                <div class="result-label">Intérêts Gagnés</div>
                            </div>
                        </div>

                        <div class="final-result">
                            <div class="final-amount" id="finalCapital">€395 | 0,00428 BTC 652 195,06</div>
                            <div class="final-label" id="finalLabel">Capital final après 20 ans</div>
                            <div class="final-gain" id="totalGain">Gain de 304247.8% sur l'investissement initial</div>
                        </div>

                        <button class="simulator-btn secondary" onclick="resetCompoundSimulator()">Nouveau
                            calcul</button>
                    </div>

                    <button class="simulator-btn" onclick="toggleCompoundSimulator()" id="compoundToggle">
                        Simuler
                    </button>
                </div>

                <!-- Simulateur FIRE -->
                <div class="simulator-card">
                    <div class="simulator-header">
                        <div class="simulator-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <svg viewBox="0 0 24 24" fill="none" style="width: 24px; height: 24px; color: white;">
                                <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div>
                            <h3>Indépendance Financière</h3>
                            <p>Calculez votre objectif FIRE</p>
                        </div>
                    </div>

                    <!-- Deux boutons côte à côte -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
                        <button class="simulator-btn" onclick="toggleFireForm('classic')"
                            style="margin: 0;">Simuler</button>
                        <button class="simulator-btn" onclick="toggleFireGoals()" style="margin: 0;">Objectifs</button>
                    </div>

                    <div id="classicFireForm" style="display: none; margin-top: 20px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Revenu mensuel souhaité (€)</label>
                                <input type="number" id="classicMonthlyIncome" placeholder="1500" value="1500">
                            </div>
                            <div class="form-group">
                                <label>Taux de retrait (%)</label>
                                <input type="number" id="classicWithdrawalRate" placeholder="4" value="4" step="0.1">
                            </div>
                        </div>
                        <button class="simulator-btn" onclick="calculateClassicFire()">Calculer</button>
                    </div>

                    <div id="classicFireResult" style="display: none;"></div>
                    <!-- Zone des objectifs FIRE -->
                    <div id="fireGoalsList" style="margin-top: 20px; display: none;"></div>
                </div>


            </div>

            <!-- Page Portefeuille -->
            <div id="portfolio" class="page">

                <!-- Carte de valeur totale moderne -->
                <div class="main-stats-card-portfolio">
                    <div class="primary-stat-portfolio">
                        <div class="primary-number-portfolio" id="portfolioTotalMain">€0</div>
                        <div class="primary-label-portfolio">Valeur totale du portefeuille</div>
                    </div>
                    <div class="secondary-stats-portfolio">
                        <div class="secondary-stat-portfolio">
                            <div class="secondary-number-portfolio" id="portfolioPnlAmount">€0</div>
                            <div class="secondary-label-portfolio">Gain/Perte</div>
                        </div>
                        <div class="secondary-stat-portfolio">
                            <div class="secondary-number-portfolio" id="portfolioPnlPercent">0%</div>
                            <div class="secondary-label-portfolio">Performance</div>
                        </div>
                    </div>
                </div>


                <!-- Liste des actifs moderne -->
                <div class="assets-card-portfolio">
                    <div class="section-header-portfolio">
                        <div class="section-title-portfolio">Mes Actifs</div>
                        <button class="add-asset-btn-portfolio" onclick="showModal('assetModal')">
                            <svg viewBox="0 0 24 24" fill="none" style="width: 16px; height: 16px;">
                                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" />
                            </svg>
                            Ajouter
                        </button>
                    </div>
                    <div id="assetsList"></div>
                </div>
            </div>

            <!-- Page Budget -->
            <div id="budget" class="page">
                <!-- Sélecteur de mois -->
                <div class="budget-month-selector-modern">
                    <button class="budget-nav-btn-modern" onclick="changeBudgetMonth(-1)">
                        <svg viewBox="0 0 24 24" fill="none" style="width: 16px; height: 16px;">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="current-budget-month-modern" id="currentBudgetMonth">Juin 2025</div>
                    <button class="budget-nav-btn-modern" onclick="changeBudgetMonth(1)">
                        <svg viewBox="0 0 24 24" fill="none" style="width: 16px; height: 16px;">
                            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>

                <!-- Vue d'ensemble du budget -->
                <div class="budget-overview-card">
                    <div class="budget-total-amount" id="budgetTotalAmount">€0</div>
                    <div class="budget-status-text" id="budgetStatusText">Budget mensuel • Configurez vos budgets</div>
                </div>

                <!-- Liste des catégories -->
                <div id="budgetCategoriesList"></div>

                <!-- Actions rapides -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 24px;">
                    <div class="action-card" onclick="openBudgetSettings()">
                        <div class="action-icon"
                            style="background: linear-gradient(135deg, var(--revolut-blue), #1d4ed8);">
                            <svg viewBox="0 0 24 24" fill="none" style="width: 20px; height: 20px; color: white;">
                                <path
                                    d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z"
                                    stroke="currentColor" stroke-width="2" />
                                <path
                                    d="M19.4 15C19.2669 15.3016 19.2272 15.6362 19.286 15.9606C19.3448 16.285 19.4995 16.5843 19.73 16.82L19.79 16.88C19.976 17.0657 20.1235 17.2863 20.2241 17.5291C20.3248 17.7719 20.3766 18.0322 20.3766 18.295C20.3766 18.5578 20.3248 18.8181 20.2241 19.0609C20.1235 19.3037 19.976 19.5243 19.79 19.71C19.6043 19.896 19.3837 20.0435 19.1409 20.1441C18.8981 20.2448 18.6378 20.2966 18.375 20.2966C18.1122 20.2966 17.8519 20.2448 17.6091 20.1441C17.3663 20.0435 17.1457 19.896 16.96 19.71L16.9 19.65C16.6643 19.4195 16.365 19.2648 16.0406 19.206C15.7162 19.1472 15.3816 19.1869 15.08 19.32C14.7842 19.4468 14.532 19.6572 14.3543 19.9255C14.1766 20.1938 14.0813 20.5082 14.08 20.83V21C14.08 21.5304 13.8693 22.0391 13.4942 22.4142C13.1191 22.7893 12.6104 23 12.08 23C11.5496 23 11.0409 22.7893 10.6658 22.4142C10.2907 22.0391 10.08 21.5304 10.08 21V20.91C10.0723 20.579 9.96512 20.258 9.77251 19.9887C9.5799 19.7194 9.31074 19.5143 9 19.4C8.69838 19.2669 8.36381 19.2272 8.03941 19.286C7.71502 19.3448 7.41568 19.4995 7.18 19.73L7.12 19.79C6.93425 19.976 6.71368 20.1235 6.47088 20.2241C6.22808 20.3248 5.96783 20.3766 5.705 20.3766C5.44217 20.3766 5.18192 20.3248 4.93912 20.2241C4.69632 20.1235 4.47575 19.976 4.29 19.79C4.10405 19.6043 3.95653 19.3837 3.85588 19.1409C3.75523 18.8981 3.70343 18.6378 3.70343 18.375C3.70343 18.1122 3.75523 17.8519 3.85588 17.6091C3.95653 17.3663 4.10405 17.1457 4.29 16.96L4.35 16.9C4.58054 16.6643 4.73519 16.365 4.794 16.0406C4.85282 15.7162 4.81312 15.3816 4.68 15.08C4.55324 14.7842 4.34276 14.532 4.07447 14.3543C3.80618 14.1766 3.49179 14.0813 3.17 14.08H3C2.46957 14.08 1.96086 13.8693 1.58579 13.4942C1.21071 13.1191 1 12.6104 1 12.08C1 11.5496 1.21071 11.0409 1.58579 10.6658C1.96086 10.2907 2.46957 10.08 3 10.08H3.09C3.42099 10.0723 3.742 9.96512 4.0113 9.77251C4.28059 9.5799 4.48572 9.31074 4.6 9C4.73312 8.69838 4.77282 8.36381 4.714 8.03941C4.65519 7.71502 4.50054 7.41568 4.27 7.18L4.21 7.12C4.02405 6.93425 3.87653 6.71368 3.77588 6.47088C3.67523 6.22808 3.62343 5.96783 3.62343 5.705C3.62343 5.44217 3.67523 5.18192 3.77588 4.93912C3.87653 4.69632 4.02405 4.47575 4.21 4.29C4.39575 4.10405 4.61632 3.95653 4.85912 3.85588C5.10192 3.75523 5.36217 3.70343 5.625 3.70343C5.88783 3.70343 6.14808 3.75523 6.39088 3.85588C6.63368 3.95653 6.85425 4.10405 7.04 4.29L7.1 4.35C7.33568 4.58054 7.63502 4.73519 7.95941 4.794C8.28381 4.85282 8.61838 4.81312 8.92 4.68H9C9.29577 4.55324 9.54802 4.34276 9.72569 4.07447C9.90337 3.80618 9.99872 3.49179 10 3.17V3C10 2.46957 10.2107 1.96086 10.5858 1.58579C10.9609 1.21071 11.4696 1 12 1C12.5304 1 13.0391 1.21071 13.4142 1.58579C13.7893 1.96086 14 2.46957 14 3V3.09C14.0013 3.41179 14.0966 3.72618 14.2743 3.99447C14.452 4.26276 14.7042 4.47324 15 4.6C15.3016 4.73312 15.6362 4.77282 15.9606 4.714C16.285 4.65519 16.5843 4.50054 16.82 4.27L16.88 4.21C17.0657 4.02405 17.2863 3.87653 17.5291 3.77588C17.7719 3.67523 18.0322 3.62343 18.295 3.62343C18.5578 3.62343 18.8181 3.67523 19.0609 3.77588C19.3037 3.87653 19.5243 4.02405 19.71 4.21C19.896 4.39575 20.0435 4.61632 20.1441 4.85912C20.2448 5.10192 20.2966 5.36217 20.2966 5.625C20.2966 5.88783 20.2448 6.14808 20.1441 6.39088C20.0435 6.63368 19.896 6.85425 19.71 7.04L19.65 7.1C19.4195 7.33568 19.2648 7.63502 19.206 7.95941C19.1472 8.28381 19.1869 8.61838 19.32 8.92V9C19.4468 9.29577 19.6572 9.54802 19.9255 9.72569C20.1938 9.90337 20.5082 9.99872 20.83 10H21C21.5304 10 22.0391 10.2107 22.4142 10.5858C22.7893 10.9609 23 11.4696 23 12C23 12.5304 22.7893 13.0391 22.4142 13.4142C22.0391 13.7893 21.5304 14 21 14H20.91C20.5882 14.0013 20.2738 14.0966 20.0055 14.2743C19.7372 14.452 19.5268 14.7042 19.4 15Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                        <h3>Configurer</h3>
                        <p>Budgets mensuels</p>
                    </div>
                    <div class="action-card" onclick="toggleBudgetEnabled()">
                        <div class="action-icon"
                            style="background: linear-gradient(135deg, var(--accent-purple), #7c3aed);">
                            <svg viewBox="0 0 24 24" fill="none" style="width: 20px; height: 20px; color: white;">
                                <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                                <path
                                    d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"
                                    stroke="currentColor" stroke-width="2" />
                            </svg>
                        </div>
                        <h3 id="budgetToggleText">Activer</h3>
                        <p>Suivi des budgets</p>
                    </div>
                </div>
            </div>

            <!-- Modal Configuration Budget -->
            <div id="budgetSettingsModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Configuration des Budgets</h3>
                        <span class="close" onclick="hideModal('budgetSettingsModal')">&times;</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Budget mensuel global (€)</label>
                        <input type="number" class="form-input" id="globalBudgetInput" placeholder="2500">
                    </div>

                    <!-- Liste de toutes les catégories -->
                    <div style="margin: 24px 0;">
                        <h4 style="color: var(--text-primary); margin: 0 0 16px 0; font-size: 16px;">Budgets par
                            catégorie</h4>
                        <div id="allCategoriesList"></div>
                    </div>

                    <button class="btn" onclick="saveBudgetSettings()">Sauvegarder</button>
                </div>
            </div>


            <!-- Page Bitcoin -->
            <div id="bitcoin" class="page">
                <div class="bitcoin-container-modern">
                    <!-- Stats principales -->
                    <div class="main-stats-card-bitcoin">
                        <div class="primary-stat-bitcoin">
                            <div class="primary-number-bitcoin" id="bitcoinStackMain">0.00000000</div>
                            <div class="primary-label-bitcoin">Bitcoin Stack Total</div>
                            <div class="rarity-text-bitcoin">
                                Seuls <span class="rarity-highlight-bitcoin" id="maxHolders">0</span> personnes max
                                pourraient avoir cette quantité (<span class="rarity-highlight-bitcoin"
                                    id="populationPercent">0%</span> de la population)
                            </div>
                        </div>
                        <div class="secondary-stats-bitcoin">
                            <div class="secondary-stat-bitcoin">
                                <div class="secondary-number-bitcoin value-color" id="bitcoinValueMain">€0 | 0,00000000
                                    BTC</div>
                                <div class="secondary-label-bitcoin">Valeur</div>
                            </div>
                            <div class="secondary-stat-bitcoin">
                                <div class="secondary-number-bitcoin price-color" id="bitcoinAvgPriceMain">€0 |
                                    0,00000000 BTC</div>
                                <div class="secondary-label-bitcoin">Prix Moyen</div>
                            </div>
                            <div class="secondary-stat-bitcoin">
                                <div class="secondary-number-bitcoin" id="bitcoinPnLMain">0%</div>
                                <div class="secondary-label-bitcoin">P&L</div>
                            </div>
                        </div>
                    </div>



                    <!-- Transactions Bitcoin -->
                    <div class="transactions-card-bitcoin">
                        <div class="section-header-bitcoin">
                            <div class="section-title-bitcoin">Transactions Bitcoin</div>
                            <div class="section-badge-bitcoin" id="bitcoinTransactionCount">0 transactions</div>
                        </div>
                        <div id="bitcoinTransactionsList"></div>
                        <button class="add-asset-btn-portfolio" onclick="showModal('bitcoinTransactionModal')"
                            style="background: linear-gradient(135deg, var(--bitcoin-orange), #FFB84D); margin-top: 16px;">
                            <svg viewBox="0 0 24 24" fill="none" style="width: 16px; height: 16px;">
                                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" />
                            </svg>
                            Ajouter Bitcoin
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal Modifier Transaction Bitcoin -->
            <div id="editBitcoinTransactionModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Modifier Transaction Bitcoin</h3>
                        <span class="close" onclick="hideModal('editBitcoinTransactionModal')">&times;</span>
                    </div>
                    <form id="editBitcoinTransactionForm">
                        <div class="form-group">
                            <label class="form-label">Type de transaction</label>
                            <select class="form-input" id="editBitcoinTransactionType" required>
                                <option value="add">Ajouter du Bitcoin</option>
                                <option value="remove">Retirer du Bitcoin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantité de Bitcoin</label>
                            <input type="number" class="form-input" id="editBitcoinTransactionQuantity"
                                step="0.00000001" placeholder="0.001" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="editBitcoinTransactionDescription"
                                placeholder="Ex: Transfer depuis Binance" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="editBitcoinTransactionDate" required>
                        </div>

                        <!-- Champs optionnels -->
                        <div class="form-group">
                            <label class="form-label">Adresse de départ (optionnel)</label>
                            <input type="text" class="form-input" id="editBitcoinFromAddress"
                                placeholder="Ex: 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Adresse de destination (optionnel)</label>
                            <input type="text" class="form-input" id="editBitcoinToAddress"
                                placeholder="Ex: bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh">
                        </div>

                        <div class="form-group">
                            <label class="form-label">ID de transaction (optionnel)</label>
                            <input type="text" class="form-input" id="editBitcoinTxId"
                                placeholder="Ex: a1075db55d416d3ca199f55b6084e2115b9345e16c5cf302fc80e9d5fbf5d48d">
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button type="submit" class="btn" style="flex: 1; background: var(--bitcoin-orange);">
                                Modifier
                            </button>
                            <button type="button" class="btn btn-red" style="flex: 1;"
                                onclick="deleteBitcoinTransactionFromEdit()">
                                Supprimer
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal Transaction Bitcoin Pure -->
            <div id="bitcoinTransactionModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Transaction Bitcoin</h3>
                        <span class="close" onclick="hideModal('bitcoinTransactionModal')">&times;</span>
                    </div>
                    <form id="bitcoinTransactionForm">
                        <div class="form-group">
                            <label class="form-label">Type de transaction</label>
                            <select class="form-input" id="bitcoinTransactionType" required>
                                <option value="add">Ajouter du Bitcoin</option>
                                <option value="remove">Retirer du Bitcoin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantité de Bitcoin</label>
                            <input type="number" class="form-input" id="bitcoinTransactionQuantity" step="0.00000001"
                                placeholder="0.001" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="bitcoinTransactionDescription"
                                placeholder="Ex: Transfer depuis Binance" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="bitcoinTransactionDate" required>
                        </div>

                        <!-- Nouveaux champs optionnels -->
                        <div class="form-group">
                            <label class="form-label">Adresse de départ (optionnel)</label>
                            <input type="text" class="form-input" id="bitcoinFromAddress"
                                placeholder="Ex: 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa">
                            <small style="opacity: 0.7; font-size: 0.8rem; margin-top: 5px; display: block;">
                                Adresse d'où proviennent les bitcoins
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Adresse de destination (optionnel)</label>
                            <input type="text" class="form-input" id="bitcoinToAddress"
                                placeholder="Ex: bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh">
                            <small style="opacity: 0.7; font-size: 0.8rem; margin-top: 5px; display: block;">
                                Adresse de réception des bitcoins
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ID de transaction (optionnel)</label>
                            <input type="text" class="form-input" id="bitcoinTxId"
                                placeholder="Ex: a1075db55d416d3ca199f55b6084e2115b9345e16c5cf302fc80e9d5fbf5d48d">
                            <small style="opacity: 0.7; font-size: 0.8rem; margin-top: 5px; display: block;">
                                Identifiant de la transaction sur la blockchain
                            </small>
                        </div>

                        <button type="submit" class="btn" style="background: var(--bitcoin-orange);">Ajouter la
                            transaction</button>
                    </form>
                </div>
            </div>

            <!-- Menu Profil -->
            <div id="profileMenu" class="profile-menu">
                <div class="profile-menu-container">
                    <!-- Header avec avatar et infos -->
                    <div class="profile-menu-header">
                        <div class="profile-menu-avatar" onclick="uploadProfilePicture()">
                            <img id="profileMenuPicture" style="display: none;" alt="Photo de profil">
                            <svg id="profileMenuIcon" viewBox="0 0 24 24" fill="none">
                                <path
                                    d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div class="profile-menu-name" id="profileMenuName">Utilisateur</div>
                        <div class="profile-menu-email" id="profileMenuEmail">Non connecté</div>
                    </div>

                    <!-- Liste des options -->
                    <div class="profile-menu-list">
                        <!-- Profil -->
                        <button class="profile-menu-item" onclick="openProfileSettings()">
                            <svg class="profile-menu-icon" viewBox="0 0 24 24" fill="none">
                                <path
                                    d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <span class="profile-menu-text">Profil</span>
                        </button>

                        <!-- Catégories -->
                        <button class="profile-menu-item" onclick="openCategoriesPage()">
                            <svg class="profile-menu-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <span class="profile-menu-text">Catégories</span>
                        </button>

                        <!-- Débiteurs -->
                        <button class="profile-menu-item" onclick="openDebtorsPage()">
                            <svg class="profile-menu-icon" viewBox="0 0 24 24" fill="none">
                                <path
                                    d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                                <path
                                    d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path
                                    d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            <span class="profile-menu-text">Débiteurs</span>
                        </button>

                        <!-- 🔥 NOUVEAU : Budget -->
                        <button class="profile-menu-item" onclick="openBudgetPage()">
                            <svg class="profile-menu-icon" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                                <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" />
                            </svg>
                            <span class="profile-menu-text">Budget</span>
                        </button>

                        <!-- 🔥 NOUVEAU : Outils -->
                        <button class="profile-menu-item" onclick="openToolsPage()">
                            <svg class="profile-menu-icon" viewBox="0 0 24 24" fill="none">
                                <rect x="4" y="2" width="16" height="20" rx="2" stroke="currentColor"
                                    stroke-width="2" />
                                <rect x="8" y="6" width="8" height="2" fill="currentColor" />
                                <rect x="8" y="10" width="8" height="2" fill="currentColor" />
                                <rect x="8" y="14" width="4" height="2" fill="currentColor" />
                                <rect x="14" y="14" width="2" height="2" fill="currentColor" />
                                <rect x="8" y="18" width="8" height="2" fill="currentColor" />
                            </svg>
                            <span class="profile-menu-text">Outils</span>
                        </button>

                        <!-- Gestion des données -->
                        <button class="profile-menu-item" onclick="openDataManagementPage()">
                            <svg class="profile-menu-icon" viewBox="0 0 24 24" fill="none">
                                <path
                                    d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M10 9H9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            <span class="profile-menu-text">Gestion des données</span>
                        </button>

                        <!-- Section Auth (conditionnelle) -->
                        <div id="authSection">
                            <!-- Un seul bouton qui ouvre un sous-menu -->
                            <button class="profile-menu-item" onclick="showAuthOptions()" id="authMenuBtn">
                                <svg class="profile-menu-icon" viewBox="0 0 24 24" fill="none">
                                    <path
                                        d="M15 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H15"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M10 17L15 12L10 7" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M15 12H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                                <span class="profile-menu-text">Se connecter</span>
                            </button>

                            <!-- Sous-menu qui apparaît -->
                            <div id="authSubMenu" style="display: none; padding-left: 36px; margin-top: 8px;">
                                <button class="profile-menu-item" onclick="openLoginFromMenu()"
                                    style="padding: 12px 20px; font-size: 14px;">
                                    <span class="profile-menu-text">J'ai déjà un compte</span>
                                </button>
                                <button class="profile-menu-item" onclick="openRegisterFromMenu()"
                                    style="padding: 12px 20px; font-size: 14px;">
                                    <span class="profile-menu-text">Créer un nouveau compte</span>
                                </button>
                            </div>
                        </div>

                        <!-- Section utilisateur connecté (conditionnelle) -->
                        <div id="userSection" style="display: none;">
                            <div class="profile-menu-separator"></div>

                            <!-- Synchroniser -->
                            <button class="profile-menu-item" onclick="syncDataFromMenu()">
                                <svg class="profile-menu-icon" viewBox="0 0 24 24" fill="none">
                                    <path
                                        d="M23 4V10H17M1 20V14H7M20.49 9C20.18 7.04 19.26 5.23 17.86 3.82C15.93 1.89 13.29 1 10.66 1.13C7.09 1.31 4.09 3.84 3.23 7.33M3.51 15C3.82 16.96 4.74 18.77 6.14 20.18C8.07 22.11 10.71 23 13.34 22.87C16.91 22.69 19.91 20.16 20.77 16.67"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                                <span class="profile-menu-text">Synchroniser</span>
                            </button>

                            <!-- Déconnexion -->
                            <button class="profile-menu-item logout" onclick="logoutFromMenu()">
                                <svg class="profile-menu-icon" viewBox="0 0 24 24" fill="none">
                                    <path
                                        d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M16 17L21 12L16 7" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                                <span class="profile-menu-text">Se déconnecter</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Paramètres -->
            <div id="settings" class="page">
                <div class="categories-page-modern">
                    <!-- Header moderne -->
                    <div class="categories-header-modern">
                        <h1 class="categories-title-modern">Gestion des Catégories</h1>
                        <p class="categories-subtitle-modern">Organisez vos transactions par catégories</p>
                    </div>

                    <!-- Liste des catégories -->
                    <div id="categoriesList"></div>

                    <!-- Formulaire d'ajout moderne -->
                    <div class="add-category-modern">
                        <div class="add-category-header-modern">
                            <div class="add-category-icon-modern">+</div>
                            <h3 class="add-category-title-modern">Ajouter une catégorie</h3>
                        </div>
                        <div class="add-category-form-modern">
                            <div class="form-group-modern">
                                <label class="form-label-modern">Nom de la catégorie</label>
                                <input type="text" id="newCategoryInput" placeholder="Ex: Voyages, Éducation..."
                                    class="form-input-modern">
                            </div>
                            <button class="add-btn-modern" onclick="addCategory()">Ajouter</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Débiteurs -->
            <div id="debtors" class="page">
                <div class="categories-page-modern">
                    <!-- Header moderne -->
                    <div class="categories-header-modern">
                        <h1 class="categories-title-modern">Gestion des Débiteurs</h1>
                        <p class="categories-subtitle-modern">Ajoutez vos débiteurs récurrents</p>
                    </div>

                    <!-- Liste des débiteurs -->
                    <div id="debtorsList"></div>

                    <!-- Formulaire d'ajout moderne -->
                    <div class="add-category-modern">
                        <div class="add-category-header-modern">
                            <div class="add-category-icon-modern">+</div>
                            <h3 class="add-category-title-modern">Ajouter un débiteur</h3>
                        </div>
                        <div class="add-category-form-modern" style="display: grid; gap: 16px;">
                            <!-- Photo de profil -->
                            <div style="text-align: center;">
                                <div class="debtor-picture-preview" id="debtorPicturePreview"
                                    onclick="document.getElementById('debtorPictureInput').click()"
                                    style="width: 80px; height: 80px; border-radius: 50%; background: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; cursor: pointer; border: 2px dashed rgba(255, 255, 255, 0.2); transition: all 0.3s ease;">
                                    <svg viewBox="0 0 24 24" fill="none"
                                        style="width: 32px; height: 32px; color: var(--text-secondary);">
                                        <path
                                            d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                        <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" />
                                        <path d="M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg>
                                </div>
                                <input type="file" id="debtorPictureInput" accept="image/*" style="display: none;"
                                    onchange="handleDebtorPicturePreview(event)">
                                <small style="color: var(--text-secondary); font-size: 12px;">Cliquez pour ajouter une
                                    photo</small>
                            </div>

                            <div class="form-group-modern">
                                <label class="form-label-modern">Nom du débiteur</label>
                                <input type="text" id="newDebtorInput" placeholder="Ex: Apple Music, Netflix..."
                                    class="form-input-modern">
                            </div>
                            <button class="add-btn-modern" onclick="addDebtor()">Ajouter</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Gestion des Données -->
            <div id="data-management" class="page">
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 24px;">
                    <h1 style="font-size: 22px; font-weight: 600; color: var(--text-primary); margin: 0;">
                        Données
                    </h1>
                </div>

                <!-- Actions principales -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px;">
                    <!-- Export -->
                    <div class="action-card" onclick="exportData()">
                        <div class="action-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <svg viewBox="0 0 24 24" fill="none" style="width: 20px; height: 20px; color: white;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                        <h3>Exporter</h3>
                        <p>Sauvegarder</p>
                    </div>

                    <!-- Import -->
                    <div class="action-card" onclick="document.getElementById('importFile').click()">
                        <div class="action-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                            <svg viewBox="0 0 24 24" fill="none" style="width: 20px; height: 20px; color: white;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                        <h3>Importer</h3>
                        <p>Restaurer</p>
                    </div>
                </div>

                <!-- 🔥 NOUVELLE SECTION BITCOIN -->
                <div style="margin-bottom: 32px;">
                    <h2
                        style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0 0 16px 0; text-align: center;">
                        Transactions Bitcoin
                    </h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <!-- Export Bitcoin -->
                        <div class="action-card" onclick="exportBitcoinOnly()">
                            <div class="action-icon"
                                style="background: linear-gradient(135deg, var(--bitcoin-orange), #FFB84D);">
                                <span style="color: white; font-size: 20px;">₿</span>
                            </div>
                            <h3>Exporter BTC</h3>
                            <p>Bitcoin seul</p>
                        </div>

                        <!-- Import Bitcoin -->
                        <div class="action-card" onclick="document.getElementById('importBitcoinFile').click()">
                            <div class="action-icon"
                                style="background: linear-gradient(135deg, var(--bitcoin-orange), #FFB84D);">
                                <span style="color: white; font-size: 20px;">₿</span>
                            </div>
                            <h3>Importer BTC</h3>
                            <p>Bitcoin seul</p>
                        </div>
                    </div>
                </div>

                <!-- Zone dangereuse -->
                <div class="danger-zone">
                    <div class="action-card danger" onclick="clearAllData()">
                        <div class="action-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <svg viewBox="0 0 24 24" fill="none" style="width: 20px; height: 20px; color: white;">
                                <path
                                    d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                        <h3>Effacer tout</h3>
                        <p>Irréversible</p>
                    </div>
                </div>

                <!-- Input caché pour l'import -->
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <!-- 🔥 NOUVEAU INPUT pour import Bitcoin -->
                <input type="file" id="importBitcoinFile" accept=".json" style="display: none;"
                    onchange="importBitcoinOnly(event)">
            </div>



            <!-- Navigation bottom -->
            <div class="bottom-nav">
                <div class="nav-items">
                    <div class="nav-item active" onclick="showPage('dashboard')">
                        <div class="nav-icon">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                                <path
                                    d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div class="nav-label">Accueil</div>
                    </div>
                    <div class="nav-item" onclick="showPage('calendar')">
                        <div class="nav-icon">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor"
                                    stroke-width="2" />
                                <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" />
                                <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" />
                                <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" />
                            </svg>
                        </div>
                        <div class="nav-label">Calendrier</div>
                    </div>

                    <!-- 🔥 BOUTON CENTRAL + -->
                    <div class="nav-item nav-item-add" onclick="showAddTransactionPage()">
                        <div class="nav-icon-add">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M12 5V19M5 12H19" stroke="white" stroke-width="2.5" stroke-linecap="round" />
                            </svg>
                        </div>
                    </div>

                    <div class="nav-item" onclick="showPage('bitcoin')">
                        <div class="nav-icon">₿</div>
                        <div class="nav-label">Bitcoin</div>
                    </div>
                    <div class="nav-item" onclick="showPage('portfolio')">
                        <div class="nav-icon">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                                <path
                                    d="M19 7H5C3.89543 7 3 7.89543 3 9V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V9C21 7.89543 20.1046 7 19 7Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path
                                    d="M16 21V5C16 4.46957 15.7893 3.96086 15.4142 3.58579C15.0391 3.21071 14.5304 3 14 3H10C9.46957 3 8.96086 3.21071 8.58579 3.58579C8.21071 3.96086 8 4.46957 8 5V21"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <line x1="12" y1="11" x2="12" y2="17" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" />
                                <line x1="9" y1="14" x2="15" y2="14" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" />
                            </svg>
                        </div>
                        <div class="nav-label">Actifs</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 🔥 ADD TRANSACTION PAGE (Slide-up) -->
        <div id="addTransactionPage" class="slide-up-page">
            <div class="slide-up-content">
                <!-- Header avec bouton fermer -->
                <div class="slide-up-header">
                    <button class="slide-up-close" onclick="hideAddTransactionPage()">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                            <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <h2 class="slide-up-title">Nouvelle Transaction</h2>
                    <div style="width: 28px;"></div> <!-- Spacer pour centrer le titre -->
                </div>

                <!-- Formulaire -->
                <form id="newTransactionForm" class="modern-form">
                    <!-- Type de transaction (Revenu / Dépense) -->
                    <div class="transaction-type-selector">
                        <button type="button" class="type-btn type-btn-income active" onclick="selectTransactionType('income')">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Revenu</span>
                        </button>
                        <button type="button" class="type-btn type-btn-expense" onclick="selectTransactionType('expense')">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M12 5v14M5 12l7 7 7-7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Dépense</span>
                        </button>
                    </div>
                    <input type="hidden" id="newTransactionType" value="income">

                    <!-- Montant -->
                    <div class="form-section">
                        <label class="modern-label">Montant</label>
                        <div class="amount-input-wrapper">
                            <input type="number" id="newTransactionAmount" class="modern-input amount-input" placeholder="0.00" step="0.01" required>
                            <span class="currency-symbol">€</span>
                        </div>
                    </div>

                    <!-- Nom de la transaction -->
                    <div class="form-section">
                        <label class="modern-label">Nom</label>
                        <input type="text" id="newTransactionName" class="modern-input" placeholder="Ex: Salaire, Courses..." required>
                    </div>

                    <!-- Catégorie -->
                    <div class="form-section">
                        <label class="modern-label">Catégorie</label>
                        <select id="newTransactionCategory" class="modern-input" onchange="toggleNewBitcoinQuantity()" required>
                            <option value="">Sélectionner une catégorie</option>
                        </select>
                    </div>

                    <!-- Quantité Bitcoin (conditionnel) -->
                    <div class="form-section" id="newBitcoinQuantityGroup" style="display: none;">
                        <label class="modern-label">Quantité de Bitcoin</label>
                        <input type="number" id="newBitcoinQuantity" class="modern-input" step="0.00000001" placeholder="0.001">
                        <small class="input-hint">Entrez la quantité de Bitcoin achetée</small>
                    </div>

                    <!-- Date -->
                    <div class="form-section">
                        <label class="modern-label">Date</label>
                        <input type="date" id="newTransactionDate" class="modern-input" required>
                    </div>

                    <!-- Toggle Récurrent -->
                    <div class="form-section">
                        <div class="toggle-row">
                            <div>
                                <label class="modern-label">Transaction récurrente</label>
                                <small class="input-hint">Répéter automatiquement cette transaction</small>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="newTransactionRecurring" onchange="toggleNewRecurringOptions()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Options récurrentes (conditionnel) -->
                    <div id="newRecurringOptions" style="display: none;">
                        <div class="form-section">
                            <label class="modern-label">Fréquence</label>
                            <select id="newRecurringFrequency" class="modern-input">
                                <option value="monthly">Mensuelle</option>
                                <option value="weekly">Hebdomadaire</option>
                                <option value="yearly">Annuelle</option>
                            </select>
                        </div>
                        <div class="form-section">
                            <label class="modern-label">Date de début</label>
                            <input type="date" id="newRecurringStartDate" class="modern-input">
                        </div>
                        <div class="form-section">
                            <label class="modern-label">Date de fin (optionnelle)</label>
                            <input type="date" id="newRecurringEndDate" class="modern-input">
                        </div>
                    </div>

                    <!-- Description (optionnelle) -->
                    <div class="form-section">
                        <label class="modern-label">Description (optionnel)</label>
                        <textarea id="newTransactionDescription" class="modern-input" rows="3" placeholder="Ajoutez des détails supplémentaires..."></textarea>
                    </div>

                    <!-- Bouton submit -->
                    <button type="submit" class="modern-submit-btn">
                        <span>Ajouter la transaction</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- Modales -->
        <div id="transactionModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="transactionModalTitle">Nouvelle Transaction</h3>
                    <span class="close" onclick="hideModal('transactionModal')">&times;</span>
                </div>
                <form id="transactionForm">
                    <div class="form-group">
                        <label class="form-label">Nom</label>
                        <input type="text" class="form-input" id="transactionName" required>
                    </div>

                    <!-- 🔥 NOUVEAU CHAMP DESCRIPTION -->
                    <div class="form-group">
                        <label class="form-label">Description (optionnel)</label>
                        <textarea class="form-input" id="transactionDescription"
                            placeholder="Ajoutez des détails supplémentaires..." rows="2"
                            style="resize: vertical; min-height: 60px;"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Montant (€)</label>
                        <input type="number" class="form-input" id="transactionAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-input" id="transactionType" required>
                            <option value="income">Revenu</option>
                            <option value="expense">Dépense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Catégorie</label>
                        <select class="form-input" id="transactionCategory" onchange="toggleBitcoinQuantity()" required>
                            <option value="">Sélectionner une catégorie</option>
                        </select>
                    </div>
                    <div class="bitcoin-quantity-group" id="bitcoinQuantityGroup">
                        <label class="form-label">Quantité de Bitcoin achetée</label>
                        <input type="number" class="form-input" id="bitcoinQuantity" step="0.00000001"
                            placeholder="0.001">
                        <small style="opacity: 0.7; margin-top: 5px; display: block;">
                            Entrez la quantité de Bitcoin achetée (ex: 0.001, 0.5, 1.2)
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="transactionDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Récurrente</label>
                        <select class="form-input" id="transactionRecurring" onchange="toggleRecurringOptions()">
                            <option value="no">Non</option>
                            <option value="yes">Oui</option>
                        </select>
                    </div>
                    <div class="form-group" id="recurringOptions" style="display: none;">
                        <label class="form-label">Fréquence</label>
                        <select class="form-input" id="recurringFrequency">
                            <option value="monthly">Mensuelle</option>
                            <option value="weekly">Hebdomadaire</option>
                            <option value="yearly">Annuelle</option>
                        </select>
                    </div>
                    <div class="form-group" id="recurringStartDateOptions" style="display: none;">
                        <label class="form-label">Date de début</label>
                        <input type="date" class="form-input" id="recurringStartDate">
                    </div>
                    <div class="form-group" id="recurringEndDateOptions" style="display: none;">
                        <label class="form-label">Date de fin (optionnelle)</label>
                        <input type="date" class="form-input" id="recurringEndDate">
                    </div>
                    <button type="submit" class="btn">Ajouter</button>
                </form>
            </div>
        </div>

        <div id="dateDetailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="dateDetailsTitle">Transactions du jour</h3>
                    <span class="close" onclick="hideModal('dateDetailsModal')">&times;</span>
                </div>
                <div id="dateTransactionsList"></div>
                <button class="btn" onclick="addTransactionForDate()" style="margin-top: 15px;">Ajouter une
                    transaction</button>
            </div>
        </div>

        <div id="assetModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="assetModalTitle">Nouvel Actif</h3>
                    <span class="close" onclick="hideModal('assetModal')">&times;</span>
                </div>
                <form id="assetForm">
                    <div class="form-group">
                        <label class="form-label">Nom de l'actif</label>
                        <input type="text" class="form-input" id="assetName" placeholder="ex: Bitcoin, Apple Inc."
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ticker / Symbole</label>
                        <input type="text" class="form-input" id="assetTicker" placeholder="ex: BTC, AAPL, MSTR"
                            required style="text-transform: uppercase;">
                        <small style="opacity: 0.7; font-size: 0.8rem; margin-top: 5px; display: block;">
                            Entrez le symbole (ex: BTC, ETH, AAPL, TSLA). Le prix actuel sera récupéré automatiquement.
                        </small>
                    </div>

                    <div class="form-group" id="bitcoinSyncOption" style="display: none;">
                        <label
                            style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--text-primary);">
                            <input type="checkbox" id="bitcoinAutoSync" style="margin: 0;">
                            <span>Synchroniser avec les transactions Bitcoin</span>
                        </label>
                        <small
                            style="opacity: 0.7; font-size: 0.8rem; margin-top: 5px; display: block; color: var(--text-secondary);">
                            Les quantités et montants seront automatiquement calculés depuis vos transactions Bitcoin
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Quantité détenue</label>
                        <input type="number" class="form-input" id="assetQuantity" step="0.00000001"
                            placeholder="ex: 0.5, 100" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Quantité détenue</label>
                        <input type="number" class="form-input" id="assetQuantity" step="0.00000001"
                            placeholder="ex: 0.5, 100" required>
                    </div>

                    <!-- NOUVEAU: Choix entre prix moyen ou capital investi -->
                    <div class="form-group">
                        <label class="form-label">Comment calculer votre investissement ?</label>
                        <select class="form-input" id="investmentType" onchange="toggleInvestmentInput()">
                            <option value="avgPrice">Prix moyen d'achat</option>
                            <option value="totalInvested">Capital total investi</option>
                        </select>
                    </div>

                    <div class="form-group" id="avgPriceGroup">
                        <label class="form-label">Prix moyen d'achat (€)</label>
                        <input type="number" class="form-input" id="assetAvgPrice" step="0.01"
                            placeholder="ex: 45000, 150.50">
                        <small style="opacity: 0.7; font-size: 0.8rem; margin-top: 5px; display: block;">
                            Le prix moyen auquel vous avez acheté cet actif
                        </small>
                    </div>

                    <div class="form-group" id="totalInvestedGroup" style="display: none;">
                        <label class="form-label">Capital total investi (€)</label>
                        <input type="number" class="form-input" id="assetTotalInvested" step="0.01"
                            placeholder="ex: 1000, 5000">
                        <small style="opacity: 0.7; font-size: 0.8rem; margin-top: 5px; display: block;">
                            Le montant total que vous avez investi dans cet actif
                        </small>
                    </div>

                    <button type="submit" class="btn" id="assetSubmitBtn">Ajouter avec Prix Auto</button>
                </form>
            </div>
        </div>

        <div class="form-group" id="bitcoinSyncOption" style="display: none;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--text-primary);">
                <input type="checkbox" id="bitcoinAutoSync" style="margin: 0;">
                <span>Synchroniser avec les transactions Bitcoin</span>
            </label>
            <small
                style="opacity: 0.7; font-size: 0.8rem; margin-top: 5px; display: block; color: var(--text-secondary);">
                Les quantités et montants seront automatiquement calculés depuis vos transactions Bitcoin
            </small>
        </div>

        <!-- Modal Modifier Actif -->
        <div id="editAssetModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Modifier l'actif</h3>
                    <span class="close" onclick="hideModal('editAssetModal')">&times;</span>
                </div>

                <form id="editAssetForm">
                    <!-- Affichage des infos non modifiables -->
                    <div
                        style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--revolut-blue), #0056b3); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 12px;"
                                id="editAssetIcon">BTC</div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 16px;"
                                    id="editAssetName">Bitcoin</div>
                                <div style="color: var(--text-secondary); font-size: 14px;" id="editAssetTicker">BTC
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Quantité détenue</label>
                        <input type="number" class="form-input" id="editAssetQuantity" step="0.00000001" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Comment calculer votre investissement ?</label>
                        <select class="form-input" id="editInvestmentType" onchange="toggleEditInvestmentInput()">
                            <option value="avgPrice">Prix moyen d'achat</option>
                            <option value="totalInvested">Capital total investi</option>
                        </select>
                    </div>

                    <div class="form-group" id="editAvgPriceGroup">
                        <label class="form-label">Prix moyen d'achat (€)</label>
                        <input type="number" class="form-input" id="editAssetAvgPrice" step="0.01">
                        <small style="opacity: 0.7; font-size: 0.8rem; margin-top: 5px; display: block;">
                            Le prix moyen auquel vous avez acheté cet actif
                        </small>
                    </div>

                    <div class="form-group" id="editTotalInvestedGroup" style="display: none;">
                        <label class="form-label">Capital total investi (€)</label>
                        <input type="number" class="form-input" id="editAssetTotalInvested" step="0.01">
                        <small style="opacity: 0.7; font-size: 0.8rem; margin-top: 5px; display: block;">
                            Le montant total que vous avez investi dans cet actif
                        </small>
                    </div>
                </form>

                <!-- Boutons en dehors du formulaire -->
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="button" class="btn" style="flex: 1;" onclick="saveAssetEdit()">
                        Modifier l'actif
                    </button>
                    <button type="button" class="btn btn-red" style="flex: 1;" onclick="deleteAssetFromEdit()">
                        Supprimer
                    </button>
                </div>
            </div>
        </div>


        <!-- Page Analytics -->
        <div id="analyticsModal" class="modal">
            <div class="modal-content analytics-modal">
                <div class="modal-header">
                    <h3 class="modal-title">Analytics</h3>
                    <span class="close" onclick="hideModal('analyticsModal')">&times;</span>
                </div>

                <!-- NOUVEAU : Sélecteur de mois moderne centré -->
                <div class="analytics-month-selector-modern">
                    <button class="month-nav-btn-modern" onclick="changeAnalyticsMonth(-1)">
                        <svg viewBox="0 0 24 24" fill="none" style="width: 16px; height: 16px;">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="current-month-modern" id="currentAnalyticsMonth">Juin 2025</div>
                    <button class="month-nav-btn-modern" onclick="changeAnalyticsMonth(1)">
                        <svg viewBox="0 0 24 24" fill="none" style="width: 16px; height: 16px;">
                            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>

                <!-- Indicateurs de variation avec Bitcoin -->
                <div class="analytics-section">
                    <div class="analytics-indicators-grid">
                        <div class="balance-variation-card" id="balanceVariationCard">
                            <div class="variation-amount" id="balanceVariation">+€0 | 0,00000000 BTC</div>
                            <div class="variation-label">Variation du solde</div>
                            <div class="variation-breakdown" id="variationBreakdown">
                                <span class="income-part">+€0 | 0,00000000 BTC revenus</span>
                                <span class="expense-part">-€0 | 0,00000000 BTC dépenses</span>
                            </div>
                        </div>

                        <div class="bitcoin-stacked-card" id="bitcoinStackedCard">
                            <div class="bitcoin-amount" id="bitcoinStackedAmount">0 BTC</div>
                            <div class="bitcoin-label">Bitcoin stacké</div>
                            <div class="bitcoin-value" id="bitcoinStackedValue">€0 | 0,00000000 BTC</div>
                        </div>
                    </div>
                </div>

                <!-- Graphique moderne -->
                <div class="analytics-section">
                    <div class="analytics-title">Répartition des dépenses</div>
                    <div id="analyticsChart3D"></div>
                    <div id="analyticsChartLegend"></div>
                </div>

                <div class="analytics-section">
                    <div class="analytics-title">Transactions du mois</div>
                    <div id="monthlyTransactionsList" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Modal Profil -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Mon Profil</h3>
                    <span class="close" onclick="hideModal('profileModal')">&times;</span>
                </div>

                <div style="text-align: center; margin-bottom: 24px;">
                    <div class="profile-picture-large" onclick="uploadProfilePicture()">
                        <img id="profilePictureLarge" style="display: none;" alt="Photo de profil">
                        <svg id="profileIconLarge" viewBox="0 0 24 24" fill="none"
                            style="width: 40px; height: 40px; color: var(--text-secondary);">
                            <path
                                d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                        <div class="upload-overlay">
                            <svg viewBox="0 0 24 24" fill="none" style="width: 20px; height: 20px;">
                                <path
                                    d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                    </div>
                    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;"
                        onchange="handleProfilePictureUpload(event)">
                    <h3 id="userName" style="color: var(--text-primary); margin: 16px 0 8px 0;">Utilisateur</h3>
                    <p id="userEmail" style="color: var(--text-secondary); margin: 0;">Non connecté</p>
                </div>

                <div id="authButtons" style="margin-bottom: 24px;">
                    <button class="btn" onclick="showModal('loginModal'); hideModal('profileModal')">Se
                        connecter</button>
                    <button class="btn btn-secondary"
                        onclick="showModal('registerModal'); hideModal('profileModal')">Créer
                        un compte</button>
                </div>

                <div id="userActions" style="display: none; margin-bottom: 24px;">
                    <button class="btn btn-secondary" onclick="syncData()">Synchroniser les données</button>
                    <button class="btn btn-red" onclick="logout()">Se déconnecter</button>
                </div>

                <div style="border-top: 1px solid var(--border-color); padding-top: 20px;">
                    <button class="btn btn-secondary" onclick="showPage('settings'); hideModal('profileModal')">⚙️
                        Paramètres</button>
                </div>
            </div>
        </div>

        <!-- Modal Connexion -->
        <div id="loginModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Connexion</h3>
                    <span class="close" onclick="hideModal('loginModal')">&times;</span>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" class="form-input" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn">Se connecter</button>
                </form>
            </div>
        </div>

        <!-- Modal Inscription -->
        <div id="registerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Créer un compte</h3>
                    <span class="close" onclick="hideModal('registerModal')">&times;</span>
                </div>
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label">Nom</label>
                        <input type="text" class="form-input" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" class="form-input" id="registerPassword" required>
                    </div>
                    <button type="submit" class="btn">Créer le compte</button>
                </form>
            </div>
        </div>

        <script>

            let lastScrollTop = 0;
            let scrollTimeout = null;
            const bottomNav = document.querySelector('.bottom-nav');
            const scrollThreshold = 5; // Seuil minimal de scroll pour déclencher l'animation

            // Fonction pour gérer le scroll et l'affichage de la nav bar
            function handleNavBarScroll() {
                const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;

                // Clearner le timeout précédent
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }

                // Éviter les micro-mouvements
                if (Math.abs(currentScrollTop - lastScrollTop) < scrollThreshold) {
                    return;
                }

                const bottomNav = document.querySelector('.bottom-nav');
                if (!bottomNav) return;

                // Scroll vers le bas = masquer la nav bar
                if (currentScrollTop > lastScrollTop && currentScrollTop > 100) {
                    bottomNav.style.transform = 'translateY(calc(100% + 20px))';
                    bottomNav.style.opacity = '0';
                } 
                // Scroll vers le haut = afficher la nav bar
                else if (currentScrollTop < lastScrollTop) {
                    bottomNav.style.transform = 'translateY(0)';
                    bottomNav.style.opacity = '1';
                }

                // Afficher la nav bar après 1.5 secondes d'inactivité
                scrollTimeout = setTimeout(() => {
                    bottomNav.style.transform = 'translateY(0)';
                    bottomNav.style.opacity = '1';
                }, 1500);

                lastScrollTop = currentScrollTop <= 0 ? 0 : currentScrollTop;
            }

            // page outils 
            // Fonction pour ouvrir la page Outils depuis le menu
            function openToolsPage() {
                hideProfileMenu();
                showPage('tools');
            }

            // Et dans la section des fonctions globales :
            window.openToolsPage = openToolsPage;


            // Fonctions pour le simulateur d'intérêts composés
            function toggleCompoundSimulator() {
                const form = document.getElementById('compoundForm');
                const toggle = document.getElementById('compoundToggle');
                const results = document.getElementById('compoundResults');

                if (form.style.display === 'none') {
                    form.style.display = 'block';
                    toggle.textContent = 'Masquer';
                    results.style.display = 'none';
                } else {
                    form.style.display = 'none';
                    toggle.textContent = 'Simuler';
                }
            }

            function calculateCompoundInterest() {
                const initial = parseFloat(document.getElementById('initialCapital').value) || 0;
                const monthly = parseFloat(document.getElementById('monthlyContribution').value) || 0;
                const annualRate = parseFloat(document.getElementById('interestRate').value) / 100 || 0;
                const years = parseInt(document.getElementById('years').value) || 0;

                if (initial <= 0 || years <= 0) {
                    alert('Veuillez entrer des valeurs valides');
                    return;
                }

                // CORRECTION CRUCIALE : Taux mensuel équivalent, pas division par 12
                const monthlyRate = Math.pow(1 + annualRate, 1 / 12) - 1;
                const totalMonths = years * 12;

                console.log(`Taux annuel: ${annualRate}`);
                console.log(`Taux mensuel équivalent: ${monthlyRate}`);

                // Simulation mois par mois avec le bon taux
                let capital = initial;
                const chartData = [{year: 0, capital: initial, contributions: initial, interests: 0}];

                for (let month = 1; month <= totalMonths; month++) {
                    // Appliquer les intérêts mensuels
                    capital = capital * (1 + monthlyRate);

                    // Ajouter le versement mensuel
                    capital = capital + monthly;

                    // Enregistrer les données annuelles
                    if (month % 12 === 0) {
                        const year = month / 12;
                        const totalContributed = initial + (monthly * month);
                        const totalInterests = capital - totalContributed;

                        chartData.push({
                            year: year,
                            capital: capital,
                            contributions: totalContributed,
                            interests: totalInterests
                        });
                    }
                }

                const totalContributions = initial + (monthly * totalMonths);
                const interestEarned = capital - totalContributions;
                const gainPercentage = ((capital - initial) / initial * 100).toFixed(1);

                // Mettre à jour l'affichage
                document.getElementById('totalInvested').textContent = `€${Math.round(totalContributions).toLocaleString()}`;
                document.getElementById('interestGained').textContent = `€${Math.round(interestEarned).toLocaleString()}`;
                document.getElementById('finalCapital').textContent = `€${Math.round(capital).toLocaleString()}`;
                document.getElementById('totalGain').textContent = `Gain de ${gainPercentage}% sur l'investissement initial`;

                // Générer le graphique
                generateCompoundChart(chartData);

                // Afficher les résultats
                document.getElementById('compoundForm').style.display = 'none';
                document.getElementById('compoundResults').style.display = 'block';
                document.getElementById('compoundToggle').style.display = 'none';
                document.getElementById('finalLabel').textContent = `Capital final après ${years} an${years > 1 ? 's' : ''}`;
            }

            function generateCompoundChart(data) {
                const chartContainer = document.getElementById('evolutionChart');
                const width = 300;
                const height = 120;
                const padding = 40;

                if (data.length < 2) return;

                const maxValue = Math.max(...data.map(d => d.capital));
                const maxYear = data[data.length - 1].year;

                let svg = `
                <svg viewBox="0 0 ${width} ${height}" style="width: 100%; height: 120px;">
                    <defs>
                        <linearGradient id="capitalGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#10b981;stop-opacity:0.8" />
                            <stop offset="50%" style="stop-color:#10b981;stop-opacity:0.4" />
                            <stop offset="100%" style="stop-color:#10b981;stop-opacity:0.1" />
                        </linearGradient>
                        <linearGradient id="contributionsGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.6" />
                            <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0.1" />
                        </linearGradient>
                    </defs>
            `;

                // Grille de fond
                for (let i = 1; i <= 4; i++) {
                    const y = padding + (i * (height - 2 * padding) / 5);
                    svg += `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>`;
                }

                // Calculer les points
                const capitalPoints = data.map((d, i) => {
                    const x = padding + (i / (data.length - 1)) * (width - 2 * padding);
                    const y = height - padding - (d.capital / maxValue) * (height - 2 * padding);
                    return `${x},${y}`;
                });

                const contributionPoints = data.map((d, i) => {
                    const x = padding + (i / (data.length - 1)) * (width - 2 * padding);
                    const y = height - padding - (d.contributions / maxValue) * (height - 2 * padding);
                    return `${x},${y}`;
                });

                // Aire des contributions
                const contributionsArea = `M ${padding} ${height - padding} L ${contributionPoints.join(' L ')} L ${width - padding} ${height - padding} Z`;
                svg += `<path d="${contributionsArea}" fill="url(#contributionsGradient)"/>`;

                // Aire du capital total
                const capitalArea = `M ${padding} ${height - padding} L ${capitalPoints.join(' L ')} L ${width - padding} ${height - padding} Z`;
                svg += `<path d="${capitalArea}" fill="url(#capitalGradient)"/>`;

                // Ligne des contributions
                const contributionsLine = `M ${contributionPoints.join(' L ')}`;
                svg += `<path d="${contributionsLine}" fill="none" stroke="#3b82f6" stroke-width="2"/>`;

                // Ligne du capital total
                const capitalLine = `M ${capitalPoints.join(' L ')}`;
                svg += `<path d="${capitalLine}" fill="none" stroke="#10b981" stroke-width="3"/>`;

                // Labels sur l'axe X (années)
                for (let i = 0; i < data.length; i += Math.max(1, Math.floor(data.length / 5))) {
                    const x = padding + (i / (data.length - 1)) * (width - 2 * padding);
                    svg += `<text x="${x}" y="${height - 10}" text-anchor="middle" fill="var(--text-secondary)" font-size="10px">${data[i].year}a</text>`;
                }

                // Labels sur l'axe Y (montants)
                for (let i = 1; i <= 3; i++) {
                    const value = (maxValue * i / 4);
                    const y = height - padding - (i * (height - 2 * padding) / 4);
                    const label = value > 1000 ? `${(value / 1000).toFixed(0)}k` : value.toFixed(0);
                    svg += `<text x="${padding - 10}" y="${y + 3}" text-anchor="end" fill="var(--text-secondary)" font-size="9px">€${label}</text>`;
                }

                svg += '</svg>';

                // Légende
                const legend = `
                <div style="display: flex; justify-content: center; gap: 20px; margin-top: 12px; font-size: 12px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 12px; height: 3px; background: #10b981; border-radius: 2px;"></div>
                        <span style="color: var(--text-secondary);">Capital total</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 12px; height: 3px; background: #3b82f6; border-radius: 2px;"></div>
                        <span style="color: var(--text-secondary);">Contributions</span>
                    </div>
                </div>
            `;

                chartContainer.innerHTML = `
                <h4>Évolution du Capital</h4>
                ${svg}
                ${legend}
            `;
            }

            function resetCompoundSimulator() {
                document.getElementById('compoundResults').style.display = 'none';
                document.getElementById('compoundForm').style.display = 'block';
                document.getElementById('compoundToggle').style.display = 'block';
                document.getElementById('compoundToggle').textContent = 'Masquer';
            }

            // Version instantanée (sans animation)
            document.addEventListener('DOMContentLoaded', function () {
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.addEventListener('click', function () {
                        window.scrollTo(0, 0);
                    });
                });

                // Gestion de l'écran de chargement
                const loadingScreen = document.getElementById('loadingScreen');
                const appContainer = document.querySelector('.app-container');

                // Séparer les lettres pour l'animation de vague
                const loadingText = document.querySelector('.loading-text');
                const text = loadingText.textContent;
                console.log('Texte original:', text, 'Longueur:', text.length);
                loadingText.innerHTML = '';

                for (let i = 0; i < text.length; i++) {
                    const span = document.createElement('span');
                    span.className = 'letter';
                    span.textContent = text[i];
                    span.style.animationDelay = `${(i + 1) * 0.1}s`;
                    loadingText.appendChild(span);
                    console.log('Lettre', i + 1, ':', text[i]);
                }

                loadingText.classList.add('letters-ready');

                setTimeout(() => {
                    loadingScreen.classList.add('fade-out');

                    setTimeout(() => {
                        appContainer.classList.add('loaded');
                        loadingScreen.remove();
                    }, 800);
                }, 1500);

                // 🔥 TEST SIMPLE - CACHE LA NAV AU SCROLL
                let lastScroll = 0;

                window.addEventListener('scroll', function() {
                    const currentScroll = window.scrollY;
                    const nav = document.querySelector('.bottom-nav');

                    console.log('Scroll:', currentScroll, 'Diff:', currentScroll - lastScroll); // DEBUG

                    if (currentScroll > lastScroll && currentScroll > 100) {
                        // Scroll down
                        console.log('CACHE LA NAV'); // DEBUG
                        nav.style.transform = 'translateY(120px)';
                    } else if (currentScroll < lastScroll) {
                        // Scroll up
                        console.log('AFFICHE LA NAV'); // DEBUG
                        nav.style.transform = 'translateY(0)';
                    }

                    lastScroll = currentScroll;
                });
            });

            // 🔥 Fonction pour vérifier et réparer les données au chargement
            function verifyDataIntegrity() {
                if (!appData.debtors) {
                    console.warn('⚠️ debtors manquant, réinitialisation');
                    appData.debtors = [];
                }
                if (!appData.transactions) {
                    console.warn('⚠️ transactions manquant, réinitialisation');
                    appData.transactions = [];
                }
                if (!appData.assets) {
                    console.warn('⚠️ assets manquant, réinitialisation');
                    appData.assets = [];
                }
                if (!appData.fireGoals) {
                    console.warn('⚠️ fireGoals manquant, réinitialisation');
                    appData.fireGoals = [];
                }
                if (!appData.categories) {
                    console.warn('⚠️ categories manquant, réinitialisation');
                    appData.categories = ['Bitcoin', 'Alimentation', 'Transport', 'Carburant', 'Crédit', 'Loyer', 'Loisirs', 'Santé', 'Shopping', 'Divers', 'Investissement', 'Remboursement'];
                }

                console.log('✅ Vérification des données terminée:', {
                    debtors: appData.debtors.length,
                    transactions: appData.transactions.length,
                    assets: appData.assets.length
                });
            }

            // Ajouter ces fonctions pour la page Bitcoin
            function displayBitcoinSummary() {
                const stats = calculateBitcoinStats();
                const summaryEl = document.getElementById('bitcoinSummary');

                if (stats.totalStack === 0) {
                    summaryEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun achat Bitcoin enregistré</p>';
                    return;
                }

                const pnlColor = stats.pnl >= 0 ? 'var(--revolut-green)' : 'var(--revolut-red)';
                const pnlSign = stats.pnl >= 0 ? '+' : '';

                summaryEl.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px;">
                    <div style="text-align: center;">
                        <div style="color: var(--bitcoin-orange); font-weight: bold; font-size: 1.2rem;">
                            ${stats.totalStack.toFixed(8)}
                        </div>
                        <small style="color: var(--text-secondary);">Total BTC</small>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: ${pnlColor}; font-weight: bold; font-size: 1.2rem;">
                            ${pnlSign}€${Math.abs(stats.pnl).toFixed(0)}
                        </div>
                        <small style="color: var(--text-secondary);">P&L (${pnlSign}${stats.pnlPercentage.toFixed(1)}%)</small>
                    </div>
                </div>
            `;
            }

            // Variables globales pour les débiteurs
            let currentDebtorPicture = null;
            let selectedDebtor = null;

            // Fonction pour ouvrir la page des débiteurs
            function openDebtorsPage() {
                hideProfileMenu();
                showPage('debtors');
                displayDebtors();
            }

            async function handleDebtorPicturePreview(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        // 🔥 Compresser l'image avant de la stocker
                        const compressedImage = await compressImage(e.target.result, 200, 0.6);
                        currentDebtorPicture = compressedImage;

                        const preview = document.getElementById('debtorPicturePreview');
                        preview.innerHTML = `<img src="${compressedImage}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                        preview.style.border = '2px solid var(--revolut-blue)';

                        console.log('✅ Image compressée:', {
                            original: Math.round(e.target.result.length / 1024) + 'KB',
                            compressed: Math.round(compressedImage.length / 1024) + 'KB'
                        });
                    } catch (error) {
                        console.error('❌ Erreur compression:', error);
                        // En cas d'erreur, utiliser l'image originale (pas idéal mais fallback)
                        currentDebtorPicture = e.target.result;
                    }
                };
                reader.readAsDataURL(file);
            }

            // Fonction pour ajouter un débiteur
            function addDebtor() {
                const input = document.getElementById('newDebtorInput');
                const name = input.value.trim();

                if (!name) {
                    alert('Veuillez entrer un nom de débiteur');
                    return;
                }

                if (!appData.debtors) {
                    appData.debtors = [];
                }

                if (appData.debtors.some(d => d.name.toLowerCase() === name.toLowerCase())) {
                    alert('Ce débiteur existe déjà');
                    return;
                }

                const debtor = {
                    id: Date.now(),
                    name: name,
                    picture: currentDebtorPicture,
                    createdDate: new Date().toISOString(),
                    usageCount: 0
                };

                appData.debtors.push(debtor);
                saveData();

                // 🔥 SYNC AUTOMATIQUE
                if (currentUser && supabase) {
                    syncDataSilently();
                }

                // Réinitialiser le formulaire
                input.value = '';
                currentDebtorPicture = null;
                document.getElementById('debtorPicturePreview').innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" style="width: 32px; height: 32px; color: var(--text-secondary);">
                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `;
                document.getElementById('debtorPicturePreview').style.border = '2px dashed rgba(255, 255, 255, 0.2)';

                displayDebtors();
                alert('Débiteur ajouté avec succès !');
            }

            // Fonction pour afficher les débiteurs
            function displayDebtors() {
                const container = document.getElementById('debtorsList');
                if (!container) return;

                let html = '';

                // 🔥 Section débiteurs prédéfinis
                if (DEFAULT_DEBTORS.length > 0) {
                    html += '<div class="categories-container-modern">';
                    html += '<h3 style="color: var(--text-primary); margin: 0 0 16px 0; font-size: 16px; opacity: 0.8;">Débiteurs populaires</h3>';

                    DEFAULT_DEBTORS.forEach((debtor, index) => {
                        html += `
                            <div class="debtor-item-modern" style="animation-delay: ${index * 0.05}s; opacity: 0.7;">
                                <div class="debtor-info-modern">
                                    <div class="debtor-avatar-modern">
                                        <img src="${debtor.picture}" alt="${debtor.name}">
                                    </div>
                                    <div>
                                        <div class="debtor-name-modern">${debtor.name}</div>
                                        <div class="debtor-usage-modern">Débiteur par défaut</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // 🔥 Section débiteurs personnalisés
                if (appData.debtors && appData.debtors.length > 0) {
                    html += '<h3 style="color: var(--text-primary); margin: 32px 0 16px 0; font-size: 16px;">Mes débiteurs personnalisés</h3>';
                    html += '<div class="categories-container-modern">';

                    appData.debtors
                        .sort((a, b) => b.usageCount - a.usageCount)
                        .forEach((debtor, index) => {
                            const usageText = debtor.usageCount === 0 ? 'Jamais utilisé' :
                                debtor.usageCount === 1 ? '1 transaction' :
                                    `${debtor.usageCount} transactions`;

                            html += `
                                <div class="debtor-item-modern" style="animation-delay: ${index * 0.05}s">
                                    <div class="debtor-info-modern">
                                        <div class="debtor-avatar-modern">
                                            ${debtor.picture ?
                                    `<img src="${debtor.picture}" alt="${debtor.name}">` :
                                    `<svg viewBox="0 0 24 24" fill="none">
                                                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>`
                                }
                                        </div>
                                        <div>
                                            <div class="debtor-name-modern">${debtor.name}</div>
                                            <div class="debtor-usage-modern">${usageText}</div>
                                        </div>
                                    </div>
                                    <div class="category-actions-modern">
                                        <button class="category-action-btn-modern delete" onclick="deleteDebtor(${debtor.id})">Supprimer</button>
                                    </div>
                                </div>
                            `;
                        });
                    html += '</div>';
                }

                if (!appData.debtors || appData.debtors.length === 0) {
                    html += '<div style="text-align: center; color: var(--text-secondary); padding: 20px; margin-top: 16px;">Vous n\'avez pas encore de débiteurs personnalisés</div>';
                }

                container.innerHTML = html;
            }

            // Fonction pour supprimer un débiteur
            function deleteDebtor(id) {
                const debtor = appData.debtors.find(d => d.id === id);
                if (!debtor) return;

                if (confirm(`Supprimer le débiteur "${debtor.name}" ?`)) {
                    appData.debtors = appData.debtors.filter(d => d.id !== id);
                    saveData();
                    displayDebtors();
                }
            }

            // Fonction pour l'autocomplétion dans le champ nom de transaction
            function setupTransactionNameAutocomplete() {
                const nameInput = document.getElementById('transactionName');
                if (!nameInput) return;

                // Créer le conteneur de suggestions s'il n'existe pas
                let suggestionsContainer = document.getElementById('transactionSuggestions');
                if (!suggestionsContainer) {
                    suggestionsContainer = document.createElement('div');
                    suggestionsContainer.id = 'transactionSuggestions';
                    suggestionsContainer.className = 'transaction-suggestions';
                    suggestionsContainer.style.display = 'none';
                    nameInput.parentElement.style.position = 'relative';
                    nameInput.parentElement.appendChild(suggestionsContainer);
                }

                // Event listener pour l'input
                nameInput.addEventListener('input', function () {
                    const query = this.value.trim().toLowerCase();

                    if (query.length === 0) {
                        suggestionsContainer.style.display = 'none';
                        selectedDebtor = null;
                        return;
                    }

                    // 🔥 Récupérer TOUS les débiteurs (prédéfinis + utilisateur)
                    const allDebtors = getAllDebtors();

                    if (allDebtors.length === 0) {
                        suggestionsContainer.style.display = 'none';
                        return;
                    }

                    // Filtrer les débiteurs qui correspondent
                    const matches = allDebtors.filter(debtor =>
                        debtor.name.toLowerCase().startsWith(query)
                    );

                    if (matches.length === 0) {
                        suggestionsContainer.style.display = 'none';
                        selectedDebtor = null;
                        return;
                    }

                    // Afficher les suggestions
                    let html = '';
                    matches.forEach(debtor => {
                        const badge = debtor.isDefault ? 
                            '<span style="background: rgba(0, 122, 239, 0.2); color: var(--revolut-blue); font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Par défaut</span>' : 
                            '';

                        html += `
                            <div class="suggestion-item" onclick="selectDebtorFromList('${debtor.name.replace(/'/g, "\\'")}', ${debtor.isDefault})">
                                <div class="suggestion-avatar">
                                    <img src="${debtor.picture}" alt="${debtor.name}">
                                </div>
                                <div style="flex: 1;">
                                    <div class="suggestion-name">${debtor.name}${badge}</div>
                                </div>
                            </div>
                        `;
                    });

                    suggestionsContainer.innerHTML = html;
                    suggestionsContainer.style.display = 'block';
                });

                // Fermer les suggestions en cliquant ailleurs
                document.addEventListener('click', function (e) {
                    if (!nameInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                        suggestionsContainer.style.display = 'none';
                    }
                });
            }

            // Fonction pour sélectionner un débiteur depuis les suggestions
            function selectDebtorFromList(debtorName, isDefault = false) {
                // Chercher dans TOUS les débiteurs
                const allDebtors = getAllDebtors();
                const debtor = allDebtors.find(d => d.name === debtorName);

                if (!debtor) return;

                selectedDebtor = debtor;

                const nameInput = document.getElementById('transactionName');
                if (nameInput) {
                    nameInput.value = debtor.name;
                }

                const suggestionsContainer = document.getElementById('transactionSuggestions');
                if (suggestionsContainer) {
                    suggestionsContainer.style.display = 'none';
                }
            }

            // Modifier la fonction addTransaction pour prendre en compte le débiteur
            const originalAddTransaction = addTransaction;
            function addTransaction() {
                // Appeler la fonction originale
                originalAddTransaction();

                // Si un débiteur était sélectionné, incrémenter son compteur et l'associer à la transaction
                if (selectedDebtor) {
                    const debtor = appData.debtors.find(d => d.id === selectedDebtor.id);
                    if (debtor) {
                        debtor.usageCount++;

                        // Ajouter le débiteur à la dernière transaction ajoutée
                        if (appData.transactions.length > 0) {
                            const lastTransaction = appData.transactions[appData.transactions.length - 1];
                            lastTransaction.debtor = {
                                id: debtor.id,
                                name: debtor.name,
                                picture: debtor.picture
                            };
                        }

                        saveData();
                    }
                    selectedDebtor = null;
                }
            }

            // Modifier getCategoryIcon pour utiliser l'avatar du débiteur si disponible
            const originalGetCategoryIcon = getCategoryIcon;
            function getCategoryIcon(transaction) {
                // Si la transaction a un débiteur avec une photo, l'utiliser
                if (transaction.debtor && transaction.debtor.picture) {
                    return `<img src="${transaction.debtor.picture}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                }

                // Sinon, utiliser l'icône de catégorie normale
                return originalGetCategoryIcon(transaction);
            }

            // Ajouter les fonctions globales
            window.openDebtorsPage = openDebtorsPage;
            window.openBudgetPage = openBudgetPage;
            window.handleDebtorPicturePreview = handleDebtorPicturePreview;
            window.addDebtor = addDebtor;
            window.deleteDebtor = deleteDebtor;
            window.selectDebtorFromList = selectDebtorFromList;
            window.getAllDebtors = getAllDebtors;

            //calendrier

            // Fonction manquante pour les interactions du graphique - AJOUT
            function highlightChartSegment(element) {
                // Cette fonction était référencée mais manquante
                if (element && element.style) {
                    element.style.filter = 'brightness(1.3)';
                    element.style.transform = element.style.transform + ' translateZ(15px)';
                }
            }

            function unhighlightChartSegment(element) {
                // Cette fonction était référencée mais manquante
                if (element && element.style) {
                    element.style.filter = '';
                    element.style.transform = element.style.transform.replace(' translateZ(15px)', '');
                }
            }

            // Variables pour le calendrier amélioré
            let currentTransactionFilter = 'all';
            let currentMonthTransactions = [];

            // Modifier la fonction generateCalendar existante
            function generateCalendar() {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();

                const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                    'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

                document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;

                let calendarHTML = '<div class="calendar-grid">';

                // CHANGÉ : Lundi en premier
                const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                dayNames.forEach(day => {
                    calendarHTML += `<div class="day-header">${day}</div>`;
                });

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();

                // CHANGÉ : Convertir pour que lundi = 0
                const startingDayOfWeek = (firstDay.getDay() + 6) % 7;

                for (let i = 0; i < startingDayOfWeek; i++) {
                    calendarHTML += '<div class="calendar-day other-month"></div>';
                }

                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const hasTransaction = appData.transactions.some(t => t.date === dateStr);
                    const currentDate = new Date(year, month, day);
                    const isToday = dateStr === todayStr;
                    const isFuture = currentDate > today;

                    let dayClasses = 'calendar-day';
                    if (hasTransaction) dayClasses += ' has-transaction';
                    if (isToday) dayClasses += ' today';
                    if (isFuture) dayClasses += ' future';

                    calendarHTML += `<div class="${dayClasses}" onclick="selectDate('${dateStr}')">${day}</div>`;
                }

                const totalCells = Math.ceil((startingDayOfWeek + daysInMonth) / 7) * 7;
                const remainingCells = totalCells - (startingDayOfWeek + daysInMonth);

                for (let i = 0; i < remainingCells; i++) {
                    calendarHTML += '<div class="calendar-day other-month"></div>';
                }

                calendarHTML += '</div>';

                const calendarView = document.getElementById('calendarView');
                if (calendarView) {
                    calendarView.innerHTML = calendarHTML;
                }

                // Calculer et afficher les stats du mois
                calculateMonthStats();

                // Générer le graphique 3D
                generate3DChart();

                // Afficher les transactions du mois
                displayMonthTransactions();
            }

            // Calculer les stats du mois
            function calculateMonthStats() {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();

                // Filtrer les transactions du mois
                const monthTransactions = appData.transactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    return transactionDate.getMonth() === month &&
                        transactionDate.getFullYear() === year &&
                        !transaction.isPureBitcoin &&
                        transaction.type !== 'bitcoin_only';
                });

                currentMonthTransactions = monthTransactions;

                // Calculer le solde de fin de mois
                let monthIncome = 0;
                let monthExpenses = 0;
                let bitcoinStacked = 0;

                monthTransactions.forEach(transaction => {
                    if (transaction.type === 'income') {
                        monthIncome += transaction.amount;
                    } else {
                        monthExpenses += transaction.amount;
                        if (transaction.category === 'bitcoin' && transaction.bitcoinQuantity) {
                            bitcoinStacked += transaction.bitcoinQuantity;
                        }
                    }
                });

                // Calculer le solde du mois précédent
                const prevMonth = new Date(year, month - 1, 1);
                const prevMonthTransactions = appData.transactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    return transactionDate < new Date(year, month, 1);
                });

                let prevBalance = appData.settings.currentBalance;
                prevMonthTransactions.forEach(transaction => {
                    prevBalance += transaction.type === 'income' ? transaction.amount : -transaction.amount;
                });

                const monthEndBalance = prevBalance + monthIncome - monthExpenses;

                // Mettre à jour l'affichage
                const balanceEl = document.getElementById('monthEndBalance');
                const bitcoinEl = document.getElementById('monthBitcoinStack');

                if (balanceEl) {
                    balanceEl.textContent = `€${monthEndBalance.toLocaleString()}`;
                    balanceEl.className = 'calendar-stat-value ' + (monthEndBalance >= 0 ? 'positive' : 'negative');
                }

                if (bitcoinEl) {
                    bitcoinEl.textContent = `${bitcoinStacked.toFixed(8)} BTC`;
                }
            }

            // Fonction principale pour générer le graphique moderne
            function generate3DChart() {
                const chartContainer = document.getElementById('chart3D');
                const legendContainer = document.getElementById('chartLegend');

                if (!chartContainer || !legendContainer) return;

                // Calculer les dépenses par catégorie
                const expensesByCategory = {};
                let totalExpenses = 0;

                currentMonthTransactions.forEach(transaction => {
                    if (transaction.type === 'expense') {
                        const category = transaction.category || 'Divers';
                        expensesByCategory[category] = (expensesByCategory[category] || 0) + transaction.amount;
                        totalExpenses += transaction.amount;
                    }
                });

                if (totalExpenses === 0) {
                    renderEmptyChartState(chartContainer, legendContainer);
                    return;
                }

                // Couleurs modernes
                const colors = [
                    '#6366f1', '#ec4899', '#f97316', '#10b981',
                    '#f59e0b', '#8b5cf6', '#06b6d4', '#ef4444'
                ];

                // Trier les catégories par montant
                const sortedCategories = Object.entries(expensesByCategory)
                    .sort(([, a], [, b]) => b - a);

                // Remplacer le contenu du conteneur par le nouveau graphique
                chartContainer.className = 'chart-container-modern';
                chartContainer.innerHTML = `
                <div class="chart-header-modern">
                    <div class="chart-title-modern">Répartition des Dépenses</div>
                    <div class="chart-subtitle-modern">Analyse des catégories du mois</div>
                </div>
                <div class="chart-donut-wrapper">
                    <svg class="chart-donut" viewBox="0 0 200 200" id="modernChartSvg">
                    </svg>
                    <div class="chart-center-modern">
                        <div class="chart-total-modern">€${totalExpenses.toLocaleString()}</div>
                        <div class="chart-label-modern">Total</div>
                    </div>
                </div>
            `;

                // Générer le graphique SVG
                renderModernDonutChart(sortedCategories, totalExpenses, colors);

                // Générer la légende moderne
                renderModernLegend(sortedCategories, totalExpenses, colors, legendContainer);

                // Créer le tooltip s'il n'existe pas
                createModernTooltip();
            }

            // Fonction pour créer un segment de donut SVG
            function createDonutSegment(startAngle, endAngle, radius = 80) {
                const centerX = 100;
                const centerY = 100;

                // Cas spécial : si c'est un cercle complet (360°), créer un cercle parfait
                if (Math.abs(endAngle - startAngle) >= 359) {
                    // Créer un cercle complet en tant que path pour être cohérent avec les autres segments
                    return `M ${centerX + radius} ${centerY} A ${radius} ${radius} 0 1 1 ${centerX - radius} ${centerY} A ${radius} ${radius} 0 1 1 ${centerX + radius} ${centerY}`;
                }

                const x1 = centerX + radius * Math.cos(startAngle * Math.PI / 180);
                const y1 = centerY + radius * Math.sin(startAngle * Math.PI / 180);
                const x2 = centerX + radius * Math.cos(endAngle * Math.PI / 180);
                const y2 = centerY + radius * Math.sin(endAngle * Math.PI / 180);

                const largeArc = endAngle - startAngle > 180 ? 1 : 0;

                const pathData = [
                    `M ${x1} ${y1}`,
                    `A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`
                ].join(' ');

                return pathData;
            }

            // Rendre le graphique donut moderne
            function renderModernDonutChart(sortedCategories, totalExpenses, colors) {
                const svg = document.getElementById('modernChartSvg');
                if (!svg) return;

                let currentAngle = 0;

                sortedCategories.forEach(([category, amount], index) => {
                    const percentage = (amount / totalExpenses) * 100;
                    const angle = (amount / totalExpenses) * 360;
                    const color = colors[index % colors.length];

                    // Créer le segment SVG
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const pathData = createDonutSegment(currentAngle, currentAngle + angle);

                    path.setAttribute('d', pathData);
                    path.setAttribute('stroke', color);
                    path.setAttribute('class', 'chart-segment-modern');
                    path.style.setProperty('--dash-array', (angle / 360) * 628);

                    // Ajouter les événements pour le tooltip
                    path.addEventListener('mouseenter', (e) => {
                        showModernTooltip(e, category, amount, percentage.toFixed(1));
                    });

                    path.addEventListener('mouseleave', hideModernTooltip);

                    path.addEventListener('mousemove', (e) => {
                        updateModernTooltipPosition(e);
                    });

                    // Ajouter l'événement de clic pour filtrer
                    path.addEventListener('click', () => {
                        filterByCategory(category);
                    });

                    svg.appendChild(path);
                    currentAngle += angle;
                });
            }

            // Rendre la légende moderne
            function renderModernLegend(sortedCategories, totalExpenses, colors, container) {
                container.className = 'chart-legend-modern';

                const legendHTML = sortedCategories.map(([category, amount], index) => {
                    const percentage = (amount / totalExpenses) * 100;
                    const color = colors[index % colors.length];

                    return `
                    <div class="legend-item-modern" onclick="filterByCategory('${category}')" style="animation-delay: ${index * 0.1}s">
                        <div class="legend-color-modern" style="background: ${color}"></div>
                        <div class="legend-details-modern">
                            <div class="legend-name-modern">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                            <div class="legend-amount-modern">€${amount.toLocaleString()}</div>
                        </div>
                        <div class="legend-percentage-modern">${percentage.toFixed(1)}%</div>
                    </div>
                `;
                }).join('');

                container.innerHTML = legendHTML;
            }

            // État vide pour le graphique
            function renderEmptyChartState(chartContainer, legendContainer) {
                chartContainer.className = 'chart-container-modern';
                chartContainer.innerHTML = `
                <div class="chart-header-modern">
                    <div class="chart-title-modern">Répartition des Dépenses</div>
                    <div class="chart-subtitle-modern">Analyse des catégories du mois</div>
                </div>
                <div class="chart-empty-modern">
                    <svg class="chart-empty-icon-modern" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <div class="chart-empty-text-modern">Aucune donnée</div>
                    <div class="chart-empty-subtext-modern">Aucune dépense ce mois</div>
                </div>
            `;

                legendContainer.innerHTML = '';
            }

            // Créer le tooltip moderne
            function createModernTooltip() {
                if (!document.getElementById('modernChartTooltip')) {
                    const tooltip = document.createElement('div');
                    tooltip.id = 'modernChartTooltip';
                    tooltip.className = 'chart-tooltip-modern';
                    document.body.appendChild(tooltip);
                }
            }

            // Afficher le tooltip moderne
            function showModernTooltip(event, category, amount, percentage) {
                const tooltip = document.getElementById('modernChartTooltip');
                if (!tooltip) return;

                tooltip.innerHTML = `${category}: €${amount.toLocaleString()} (${percentage}%)`;
                tooltip.style.left = (event.clientX + 10) + 'px';
                tooltip.style.top = (event.clientY - 30) + 'px';
                tooltip.classList.add('visible');
            }

            // Masquer le tooltip moderne
            function hideModernTooltip() {
                const tooltip = document.getElementById('modernChartTooltip');
                if (tooltip) {
                    tooltip.classList.remove('visible');
                }
            }

            // Mettre à jour la position du tooltip
            function updateModernTooltipPosition(event) {
                const tooltip = document.getElementById('modernChartTooltip');
                if (tooltip && tooltip.classList.contains('visible')) {
                    tooltip.style.left = (event.clientX + 10) + 'px';
                    tooltip.style.top = (event.clientY - 30) + 'px';
                }
            }


            // Gestion des filtres de transactions
            function setTransactionFilter(filterType) {
                currentTransactionFilter = filterType;

                // Mettre à jour les boutons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');

                displayMonthTransactions();
            }

            function displayMonthTransactions() {
                const container = document.getElementById('monthTransactionsList');
                if (!container) return;

                let transactions = [...currentMonthTransactions];

                // Appliquer le filtre
                switch (currentTransactionFilter) {
                    case 'date':
                        transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                        break;
                    case 'amount':
                        transactions.sort((a, b) => b.amount - a.amount);
                        break;
                    case 'category':
                        transactions.sort((a, b) => (a.category || 'Divers').localeCompare(b.category || 'Divers'));
                        break;
                    default:
                        transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                }

                if (transactions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune transaction ce mois</p>';
                    return;
                }

                let html = '';
                transactions.forEach(transaction => {
                    const isBitcoin = transaction.category === 'bitcoin';
                    const iconType = transaction.type === 'income' ? 'income' : (isBitcoin ? 'bitcoin' : 'expense');
                    const icon = getCategoryIcon(transaction);
                    const amountColor = transaction.type === 'income' ? 'var(--revolut-green)' : 'var(--text-primary)';

                    html += `
                    <div class="transaction-item" onclick="showTransactionDetails(${transaction.id})" style="cursor: pointer;">
                        <div class="transaction-icon ${iconType}">${icon}</div>
                        <div class="transaction-details">
                            <div class="transaction-name">${transaction.name}</div>
                            <div class="transaction-meta">${transaction.date} • ${transaction.category || 'Sans catégorie'}</div>
                        </div>
                        <div class="transaction-amount" style="color: ${amountColor};">
                            ${transaction.type === 'income' ? '+' : '-'}€${Math.abs(transaction.amount).toFixed(2)}
                        </div>
                    </div>
                `;
                });

                container.innerHTML = html;
            }

            function filterByCategory(category) {
                // Filtrer les transactions par catégorie depuis le graphique
                const filteredTransactions = currentMonthTransactions.filter(t =>
                    t.category === category && t.type === 'expense'
                );

                const container = document.getElementById('monthTransactionsList');
                if (!container) return;

                let html = '';
                filteredTransactions.forEach(transaction => {
                    const isBitcoin = transaction.category === 'bitcoin';
                    const iconType = transaction.type === 'income' ? 'income' : (isBitcoin ? 'bitcoin' : 'expense');

                    // 🔥 UTILISER getCategoryIcon() pour afficher le bon icône
                    const icon = getCategoryIcon(transaction);
                    const amountColor = transaction.type === 'income' ? 'var(--revolut-green)' : 'var(--text-primary)';

                    html += `
                        <div class="transaction-item" onclick="showTransactionDetails(${transaction.id})" style="cursor: pointer;">
                            <div class="transaction-icon ${iconType}">${icon}</div>
                            <div class="transaction-details">
                                <div class="transaction-name">${transaction.name}</div>
                                <div class="transaction-meta">${transaction.date} • ${transaction.category}</div>
                            </div>
                            <div class="transaction-amount" style="color: ${amountColor};">
                                -€${transaction.amount.toFixed(2)}
                            </div>
                        </div>
                    `;
                });

                if (html === '') {
                    html = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune transaction dans cette catégorie</p>';
                }

                container.innerHTML = `
                    <div style="margin-bottom: 16px; padding: 12px; background: transparent; border-radius: 8px; text-align: center;">
                        <strong>Filtré par: ${category.charAt(0).toUpperCase() + category.slice(1)}</strong>
                        <button onclick="displayMonthTransactions()" style="background: none; border: none; color: white; margin-left: 16px; cursor: pointer; text-decoration: underline;">Voir tout</button>
                    </div>
                    ${html}
                `;
            }

            // 🔥 Fonction pour compresser les images avant sauvegarde
            function compressImage(base64Image, maxWidth = 300, quality = 0.7) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = function () {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Redimensionner si trop grand
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convertir en base64 compressé
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    };
                    img.src = base64Image;
                });
            }

            // Ajouter les fonctions globales
            window.setTransactionFilter = setTransactionFilter;
            window.filterByCategory = filterByCategory;
            window.highlightChartSegment = highlightChartSegment;
            window.unhighlightChartSegment = unhighlightChartSegment;
            window.changeCategoryEmoji = changeCategoryEmoji;


            // Ajouter cette fonction pour s'assurer que le scroll fonctionne
            function ensureScrollability() {
                const pages = document.querySelectorAll('.page');
                pages.forEach(page => {
                    const content = page.querySelector('.main-content, .all-transactions-content');
                    if (content) {
                        // Forcer la hauteur minimum pour permettre le scroll
                        const minHeight = window.innerHeight + 100;
                        if (content.scrollHeight < minHeight) {
                            content.style.minHeight = minHeight + 'px';
                        }
                    }
                });
            }

            // Appeler cette fonction après le chargement et lors du redimensionnement
            window.addEventListener('resize', ensureScrollability);
            window.addEventListener('orientationchange', ensureScrollability);


            document.addEventListener('DOMContentLoaded', function () {

                setTimeout(ensureScrollability, 500);
            });

            // Variables pour la page toutes transactions
            let selectedMonthFilter = null;
            let currentFilteredTransactions = [];

            // Fonction pour afficher toutes les transactions
            function displayAllTransactionsPage() {
                const today = new Date();
                today.setHours(23, 59, 59, 999);

                // Exclure les transactions Bitcoin pures (transfers)
                currentFilteredTransactions = appData.transactions
                    .filter(transaction => {
                        const transactionDate = new Date(transaction.date);
                        return transactionDate <= today &&
                            !transaction.isPureBitcoin &&
                            transaction.type !== 'bitcoin_only';
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                generateMonthPills();
                renderFilteredTransactions(currentFilteredTransactions);

                // Set sort dropdown to current sort option
                const sortSelect = document.getElementById('transactionSortSelect');
                if (sortSelect) {
                    sortSelect.value = currentSortOption;
                }
            }

            // Générer les pills des mois
            function generateMonthPills() {
                const container = document.getElementById('monthPillsSwipeable');
                const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                    'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

                // Obtenir tous les mois uniques des transactions
                const months = new Set();
                currentFilteredTransactions.forEach(transaction => {
                    const date = new Date(transaction.date);
                    const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                    months.add(monthKey);
                });

                const sortedMonths = Array.from(months).sort((a, b) => {
                    const [yearA, monthA] = a.split('-').map(Number);
                    const [yearB, monthB] = b.split('-').map(Number);

                    if (yearA !== yearB) return yearB - yearA;
                    return monthB - monthA;
                });

                let html = `
                <div class="month-pill-swipeable ${!selectedMonthFilter ? 'active' : ''}" onclick="filterByMonth(null)">
                    Tous
                </div>
            `;

                sortedMonths.forEach(monthKey => {
                    const [year, month] = monthKey.split('-').map(Number);
                    const monthName = monthNames[month];
                    const displayText = year === new Date().getFullYear() ? monthName : `${monthName} ${year}`;

                    html += `
                    <div class="month-pill-swipeable ${selectedMonthFilter === monthKey ? 'active' : ''}" onclick="filterByMonth('${monthKey}')">
                        ${displayText}
                    </div>
                `;
                });

                container.innerHTML = html;
            }



            // Filtrer par mois
            function filterByMonth(monthKey) {
                selectedMonthFilter = monthKey;

                let filteredTransactions = currentFilteredTransactions;

                if (monthKey) {
                    const [year, month] = monthKey.split('-').map(Number);
                    filteredTransactions = currentFilteredTransactions.filter(transaction => {
                        const date = new Date(transaction.date);
                        return date.getFullYear() === year && date.getMonth() === month;
                    });
                }

                renderFilteredTransactions(filteredTransactions);
                generateMonthPills(); // Regénérer pour mettre à jour les classes actives
            }

            // Fonction de recherche pour toutes les transactions
            function filterAllTransactions(query) {
                const searchQuery = query.toLowerCase().trim();

                // Exclure les transactions Bitcoin pures de la base
                let baseTransactions = currentFilteredTransactions.filter(transaction =>
                    !transaction.isPureBitcoin && transaction.type !== 'bitcoin_only'
                );

                // Appliquer le filtre de mois si sélectionné
                if (selectedMonthFilter) {
                    const [year, month] = selectedMonthFilter.split('-').map(Number);
                    baseTransactions = baseTransactions.filter(transaction => {
                        const date = new Date(transaction.date);
                        return date.getFullYear() === year && date.getMonth() === month;
                    });
                }

                // Appliquer le filtre de recherche
                let filteredTransactions = baseTransactions;
                if (searchQuery) {
                    filteredTransactions = baseTransactions.filter(transaction =>
                        transaction.name.toLowerCase().includes(searchQuery) ||
                        transaction.amount.toString().includes(searchQuery) ||
                        transaction.date.includes(searchQuery) ||
                        (transaction.category && transaction.category.toLowerCase().includes(searchQuery))
                    );
                }

                // Le reste de la fonction reste identique...
                const container = document.getElementById('allTransactionsFiltered');
                let searchIndicator = '';

                if (searchQuery) {
                    searchIndicator = `
                    <div style="background: transparent; padding: 12px 20px; margin: 0 -24px 20px; text-align: center; color: white; font-weight: 600;">
                        Recherche: "${query}" • ${filteredTransactions.length} résultat${filteredTransactions.length > 1 ? 's' : ''}
                        <button onclick="clearAllTransactionsSearch()" style="background: none; border: none; color: white; margin-left: 16px; cursor: pointer; text-decoration: underline;">Effacer</button>
                    </div>
                `;
                }

                if (filteredTransactions.length === 0) {
                    container.innerHTML = searchIndicator + `
                    <div style="text-align: center; color: var(--text-secondary); padding: 60px 20px;">
                        <svg viewBox="0 0 24 24" fill="none" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="m9 12 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <p style="font-size: 18px; margin: 0;">Aucune transaction trouvée</p>
                    </div>
                `;
                    return;
                }

                // Grouper par date et afficher
                const groupedTransactions = {};
                filteredTransactions.forEach(transaction => {
                    const date = new Date(transaction.date);
                    const today = new Date();
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);

                    let dateKey;
                    if (date.toDateString() === today.toDateString()) {
                        dateKey = 'Aujourd\'hui';
                    } else if (date.toDateString() === yesterday.toDateString()) {
                        dateKey = 'Hier';
                    } else {
                        const day = date.getDate();
                        const month = date.toLocaleDateString('fr-FR', {month: 'long'});
                        dateKey = `${day} ${month}`;
                    }

                    if (!groupedTransactions[dateKey]) {
                        groupedTransactions[dateKey] = [];
                    }
                    groupedTransactions[dateKey].push(transaction);
                });

                let html = searchIndicator;
                Object.keys(groupedTransactions).forEach(dateGroup => {
                    html += `
                    <div class="transaction-group">
                        <div class="date-group-header-main">${dateGroup}</div>
                `;

                    groupedTransactions[dateGroup].forEach(transaction => {
                        const isBitcoin = transaction.category === 'bitcoin';
                        const iconType = transaction.type === 'income' ? 'income' : (isBitcoin ? 'bitcoin' : 'expense');
                        const icon = getCategoryIcon(transaction);
                        const amountColor = transaction.type === 'income' ? 'var(--revolut-green)' : 'var(--text-primary)';

                        html += `
                        <div class="transaction-card-glassmorphism" onclick="showTransactionDetails(${transaction.id})" style="cursor: pointer;">
                            <div class="transaction-item" style="border-bottom: none;">
                                <div class="transaction-icon ${iconType}">${icon}</div>
                                <div class="transaction-details">
                                    <div class="transaction-name">${transaction.name}</div>
                                    <div class="transaction-meta">${new Date(transaction.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})} • ${transaction.category || 'Sans catégorie'}</div>
                                </div>
                                <div class="transaction-amount" style="color: ${amountColor};">
                                    ${transaction.type === 'income' ? '+' : '-'}€${Math.abs(transaction.amount).toFixed(2)}
                                </div>
                            </div>
                        </div>
                    `;
                    });

                    html += '</div>';
                });

                container.innerHTML = html;
            }

            function clearAllTransactionsSearch() {
                // Vider les deux champs
                const mainInput = document.getElementById('searchInput');
                const allTransactionsInput = document.getElementById('allTransactionsSearchInput');

                if (mainInput) mainInput.value = '';
                if (allTransactionsInput) allTransactionsInput.value = '';

                // Réafficher toutes les transactions
                displayAllTransactionsPage();
            }

            // Rendre les transactions filtrées
            function renderFilteredTransactions(transactions) {
                const container = document.getElementById('allTransactionsFiltered');

                if (transactions.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 60px 20px;">
                            <svg viewBox="0 0 24 24" fill="none" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <path d="m9 12 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p style="font-size: 18px; margin: 0;">Aucune transaction trouvée</p>
                        </div>
                    `;
                    return;
                }

                // Apply sorting before grouping
                const sortedTransactions = sortTransactions(transactions, currentSortOption);

                // Grouper par date
                const groupedTransactions = {};
                sortedTransactions.forEach(transaction => {
                    const date = new Date(transaction.date);
                    const today = new Date();
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);

                    let dateKey;
                    if (date.toDateString() === today.toDateString()) {
                        dateKey = 'Aujourd\'hui';
                    } else if (date.toDateString() === yesterday.toDateString()) {
                        dateKey = 'Hier';
                    } else {
                        const day = date.getDate();
                        const month = date.toLocaleDateString('fr-FR', {month: 'long'});
                        dateKey = `${day} ${month}`;
                    }

                    if (!groupedTransactions[dateKey]) {
                        groupedTransactions[dateKey] = [];
                    }
                    groupedTransactions[dateKey].push(transaction);
                });

                let html = '';
                Object.keys(groupedTransactions).forEach(dateGroup => {
                    html += `
                        <div class="transaction-group">
                            <div class="date-group-header-main">${dateGroup}</div>
                    `;

                    groupedTransactions[dateGroup].forEach(transaction => {
                        const isBitcoin = transaction.category === 'bitcoin';
                        const iconType = transaction.type === 'income' ? 'income' : (isBitcoin ? 'bitcoin' : 'expense');

                        // 🔥 UTILISER getCategoryIcon() au lieu de juste afficher le signe
                        const icon = getCategoryIcon(transaction);
                        const amountColor = transaction.type === 'income' ? 'var(--revolut-green)' : 'var(--text-primary)';

                        html += `
                            <div class="transaction-card-glassmorphism" onclick="showTransactionDetails(${transaction.id})" style="cursor: pointer;">
                                <div class="transaction-item" style="border-bottom: none;">
                                    <div class="transaction-icon ${iconType}">${icon}</div>
                                    <div class="transaction-details">
                                        <div class="transaction-name">${transaction.name}</div>
                                        <div class="transaction-meta">${new Date(transaction.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})} • ${transaction.category || 'Sans catégorie'}</div>
                                    </div>
                                    <div class="transaction-amount" style="color: ${amountColor};">
                                        ${transaction.type === 'income' ? '+' : '-'}€${Math.abs(transaction.amount).toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                });

                container.innerHTML = html;
            }

            // Sort transactions based on selected option
            function sortTransactions(transactions, sortOption) {
                const sorted = [...transactions]; // Create a copy to avoid mutating original

                switch (sortOption) {
                    case 'date-desc': // Newest first
                        sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
                        break;
                    case 'date-asc': // Oldest first
                        sorted.sort((a, b) => new Date(a.date) - new Date(b.date));
                        break;
                    case 'amount-desc': // Highest first
                        sorted.sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount));
                        break;
                    case 'amount-asc': // Lowest first
                        sorted.sort((a, b) => Math.abs(a.amount) - Math.abs(b.amount));
                        break;
                    case 'name-asc': // A-Z
                        sorted.sort((a, b) => a.name.localeCompare(b.name, 'fr'));
                        break;
                    case 'name-desc': // Z-A
                        sorted.sort((a, b) => b.name.localeCompare(a.name, 'fr'));
                        break;
                    default:
                        sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
                }

                return sorted;
            }

            // Apply sort when dropdown changes
            function applySortToTransactions() {
                const selectElement = document.getElementById('transactionSortSelect');
                currentSortOption = selectElement.value;

                // Re-display transactions with new sort order
                displayAllTransactionsPage();
            }

            // Gérer le scroll pour afficher/masquer le sélecteur de mois
            function handleAllTransactionsScroll() {
                const container = document.getElementById('allTransactionsContent');
                const monthSelector = document.getElementById('monthSelectorSwipeable');

                if (container.scrollTop > 100) {
                    monthSelector.style.transform = 'translateY(0)';
                } else {
                    monthSelector.style.transform = 'translateY(-100%)';
                }
            }

            // Variables globales
            let appData = {
                transactions: [],
                assets: [],
                fireGoals: [],
                debtors: [],
                categories: ['Bitcoin', 'Alimentation', 'Transport', 'Carburant', 'Crédit', 'Loyer', 'Loisirs', 'Santé', 'Shopping', 'Divers', 'Investissement', 'Remboursement'],
                settings: {
                    currentBalance: 0
                },
                budgetSettings: {
                    enabled: false,
                    global: 0,
                    categories: {
                        bitcoin: 0,
                        alimentation: 0,
                        loisirs: 0,
                        shopping: 0,
                        divers: 0
                    },
                    alerts: {
                        threshold80: true,
                        threshold100: true
                    }
                },
                budgetAlerts: {}
            };

            let currentCalendarDate = new Date();
            let headerSlideIndex = 0;
            let priceUpdateInterval = null;
            let currentBudgetDate = new Date();
            let currentSortOption = 'date-desc'; // Default sort: newest first

            // Débiteurs prédéfinis
            // 🔥 DÉBITEURS PAR DÉFAUT
            const DEFAULT_DEBTORS = [
                { name: "Netflix", picture: "assets/debiteurs/netflix.png", category: "abonnement", isDefault: true },
                { name: "Amazon", picture: "assets/debiteurs/amazon-a.png", category: "abonnement", isDefault: true, },
                { name: "Apple", picture: "assets/debiteurs/apple.png", category: "loyer", isDefault: true },
                { name: "Free", picture: "assets/debiteurs/free.png", category: "abonnement", isDefault: true },
                { name: "Orange", picture: "assets/debiteurs/orange.png", category: "internet", isDefault: true },
                { name: "SFR", picture: "assets/debiteurs/sfr.png", category: "internet", isDefault: true },
                { name: "Bouygues", picture: "assets/debiteurs/bouygues-telecom.png", category: "internet", isDefault: true },
                { name: "AirBNB", picture: "assets/debiteurs/airbnb.png", category: "loisir", isDefault: true },
                { name: "EDF", picture: "assets/debiteurs/edf.png", category: "loyer", isDefault: true },
                { name: "Apple Music", picture: "assets/debiteurs/apple music.png", category: "loyer", isDefault: true },
                { name: "Auchan", picture: "assets/debiteurs/auchan.png", category: "loyer", isDefault: true },
                { name: "Basic Fit", picture: "assets/debiteurs/basic-fit.png", category: "loyer", isDefault: true },
                { name: "Deezer", picture: "assets/debiteurs/deezer.png", category: "loyer", isDefault: true },
                { name: "Spotify", picture: "assets/debiteurs/spotify-y.png", category: "abonnement", isDefault: true, },
                { name: "Disney +", picture: "assets/debiteurs/disney+.jpeg", category: "loyer", isDefault: true },
                { name: "Axa", picture: "assets/debiteurs/axa.png", category: "loyer", isDefault: true },
                { name: "Burger King", picture: "assets/debiteurs/burger-king.png", category: "loyer", isDefault: true },
                { name: "Canal +", picture: "assets/debiteurs/canal.png", category: "loyer", isDefault: true },
                { name: "Prime Video", picture: "assets/debiteurs/prime-video.png", category: "loyer", isDefault: true },
                { name: "Claude", picture: "assets/debiteurs/claude.png", category: "loyer", isDefault: true },
                { name: "Leclerc", picture: "assets/debiteurs/eleclerc.png", category: "loyer", isDefault: true },
                { name: "Fitness Park", picture: "assets/debiteurs/fitness-park.png", category: "loyer", isDefault: true },
                { name: "Bitcoin", picture: "assets/debiteurs/bitcoin.png", category: "bitcoin", isDefault: true },
                { name: "iCloud", picture: "assets/debiteurs/icloud.png", category: "loyer", isDefault: true },
                { name: "KFC", picture: "assets/debiteurs/KFC-C.png", category: "loyer", isDefault: true },
                { name: "L'Olivier", picture: "assets/debiteurs/l-olivier.png", category: "loyer", isDefault: true },
                { name: "Intermarché", picture: "assets/debiteurs/intermarché.jpg", category: "loyer", isDefault: true },
                { name: "Macif", picture: "assets/debiteurs/macif.png", category: "loyer", isDefault: true },
                { name: "Mc Donald's", picture: "assets/debiteurs/mcdonald.png", category: "loyer", isDefault: true },
                { name: "OpenAI", picture: "assets/debiteurs/openai.png", category: "loyer", isDefault: true },
                { name: "Playstation", picture: "assets/debiteurs/playstation.png", category: "loyer", isDefault: true },
                { name: "Starbucks", picture: "assets/debiteurs/starbucks.png", category: "loyer", isDefault: true },
                { name: "Subway", picture: "assets/debiteurs/subway.png", category: "loyer", isDefault: true },
                { name: "Uber", picture: "assets/debiteurs/uber.png", category: "loyer", isDefault: true },
                { name: "Uber Eats", picture: "assets/debiteurs/uber-eats.png", category: "loyer", isDefault: true },
                { name: "X", picture: "assets/debiteurs/x.png", category: "abonnement", isDefault: true },
                { name: "Xbox", picture: "assets/debiteurs/xbox.png", category: "loyer", isDefault: true },
                { name: "Youtube", picture: "assets/debiteurs/youtube.png", category: "loyer", isDefault: true },
                { name: "Google One", picture: "assets/debiteurs/google-one.png", category: "loyer", isDefault: true },
                { name: "ADN", picture: "assets/debiteurs/adn.png", category: "loyer", isDefault: true },
                { name: "LCL", picture: "assets/debiteurs/lcl.png", category: "loyer", isDefault: true },
                { name: "CGR", picture: "assets/debiteurs/cgr-cinema.png", category: "loyer", isDefault: true },
                { name: "Crunchyroll", picture: "assets/debiteurs/crunchyroll.png", category: "loyer", isDefault: true },
                { name: "Revolut", picture: "assets/debiteurs/revolut.png", category: "loyer", isDefault: true },
                { name: "Office", picture: "assets/debiteurs/office.png", category: "loyer", isDefault: true },
                { name: "Ameli", picture: "assets/debiteurs/ameli.png", category: "loyer", isDefault: true },
                { name: "Pathé", picture: "assets/debiteurs/pathé.png", category: "loyer", isDefault: true },
                { name: "Engie", picture: "assets/debiteurs/engie.png", category: "loyer", isDefault: true }
            ];

            // Fonction pour obtenir tous les débiteurs (prédéfinis + utilisateur)
            function getAllDebtors() {
                const userDebtors = appData.debtors || [];
                return [...DEFAULT_DEBTORS, ...userDebtors];
            }

            function applyDebtorsToExistingTransactions() {
                let updatedCount = 0;

                appData.transactions.forEach(transaction => {
                    // Si la transaction n'a pas déjà un débiteur
                    if (!transaction.debtor) {
                        // Chercher un débiteur correspondant au nom de la transaction
                        const allDebtors = getAllDebtors();
                        const matchingDebtor = allDebtors.find(debtor => 
                            transaction.name.toLowerCase().includes(debtor.name.toLowerCase()) ||
                            debtor.name.toLowerCase().includes(transaction.name.toLowerCase())
                        );

                        if (matchingDebtor) {
                            transaction.debtor = {
                                name: matchingDebtor.name,
                                picture: matchingDebtor.picture,
                                isDefault: matchingDebtor.isDefault || false
                            };
                            updatedCount++;
                        }
                    }
                });

                if (updatedCount > 0) {
                    saveData();
                    console.log(`✅ ${updatedCount} transactions mises à jour avec des débiteurs`);
                    return updatedCount;
                }

                return 0;
            }

            // Classe pour gérer les prix des actifs
            class AssetPriceManager {
                constructor() {
                    this.cryptoIds = new Map([
                        ['BTC', 'bitcoin'],
                        ['ETH', 'ethereum'],
                        ['ADA', 'cardano'],
                        ['DOT', 'polkadot'],
                        ['LINK', 'chainlink'],
                        ['LTC', 'litecoin'],
                        ['XRP', 'ripple'],
                        ['SOL', 'solana'],
                        ['AVAX', 'avalanche-2'],
                        ['MATIC', 'matic-network'],
                        ['UNI', 'uniswap'],
                        ['ATOM', 'cosmos'],
                        ['ALGO', 'algorand'],
                        ['XLM', 'stellar'],
                        ['VET', 'vechain'],
                        ['ICP', 'internet-computer'],
                        ['FIL', 'filecoin'],
                        ['THETA', 'theta-token'],
                        ['AAVE', 'aave'],
                        ['COMP', 'compound-governance-token'],
                        ['MKR', 'maker'],
                        ['SNX', 'havven'],
                        ['SUSHI', 'sushi'],
                        ['CRV', 'curve-dao-token'],
                        ['YFI', 'yearn-finance'],
                        ['BAL', 'balancer'],
                        ['REN', 'republic-protocol'],
                        ['ZRX', '0x'],
                        ['KNC', 'kyber-network-crystal'],
                        ['LRC', 'loopring'],
                        ['DOGE', 'dogecoin'],
                        ['SHIB', 'shiba-inu'],
                        ['MSTR', 'microstrategy']
                    ]);

                    this.lastUpdate = {};
                    this.updateInterval = 10 * 60 * 1000; // 10 minutes
                }

                isCrypto(ticker) {
                    return this.cryptoIds.has(ticker.toUpperCase());
                }

                getCryptoId(ticker) {
                    return this.cryptoIds.get(ticker.toUpperCase());
                }

                async fetchCryptoPrice(ticker) {
                    try {
                        const cryptoId = this.getCryptoId(ticker);
                        if (!cryptoId) {
                            throw new Error(`Crypto ${ticker} non supportée`);
                        }

                        const response = await fetch(
                            `https://api.coingecko.com/api/v3/simple/price?ids=${cryptoId}&vs_currencies=eur&include_24hr_change=true`,
                            {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json',
                                }
                            }
                        );

                        if (!response.ok) {
                            throw new Error(`Erreur API CoinGecko: ${response.status}`);
                        }

                        const data = await response.json();
                        const priceData = data[cryptoId];

                        if (!priceData) {
                            throw new Error(`Données non trouvées pour ${ticker}`);
                        }

                        return {
                            price: priceData.eur,
                            change24h: priceData.eur_24h_change || 0,
                            source: 'coingecko',
                            lastUpdate: Date.now()
                        };
                    } catch (error) {
                        console.error(`Erreur lors de la récupération du prix de ${ticker}:`, error);
                        throw error;
                    }
                }

                async fetchStockPrice(ticker) {
                    try {
                        const response = await fetch(
                            `https://query1.finance.yahoo.com/v8/finance/chart/${ticker.toUpperCase()}?interval=1d&range=1d`,
                            {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json',
                                }
                            }
                        );

                        if (!response.ok) {
                            throw new Error(`Erreur API Yahoo Finance: ${response.status}`);
                        }

                        const data = await response.json();
                        const result = data.chart.result[0];

                        if (!result || !result.meta) {
                            throw new Error(`Action ${ticker} non trouvée`);
                        }

                        const currentPrice = result.meta.regularMarketPrice;
                        const previousClose = result.meta.previousClose;
                        const change24h = previousClose ? ((currentPrice - previousClose) / previousClose) * 100 : 0;

                        const usdToEur = 0.92;
                        const priceInEur = currentPrice * usdToEur;

                        return {
                            price: priceInEur,
                            change24h: change24h,
                            source: 'yahoo',
                            currency: result.meta.currency,
                            lastUpdate: Date.now()
                        };
                    } catch (error) {
                        console.error(`Erreur lors de la récupération du prix de ${ticker}:`, error);
                        throw error;
                    }
                }

                async fetchAssetPrice(ticker) {
                    const upperTicker = ticker.toUpperCase();

                    try {
                        let priceData;

                        if (this.isCrypto(upperTicker)) {
                            priceData = await this.fetchCryptoPrice(upperTicker);
                        } else {
                            priceData = await this.fetchStockPrice(upperTicker);
                        }

                        const cacheKey = `price_${upperTicker}`;
                        localStorage.setItem(cacheKey, JSON.stringify(priceData));

                        return priceData;
                    } catch (error) {
                        const cacheKey = `price_${upperTicker}`;
                        const cached = localStorage.getItem(cacheKey);

                        if (cached) {
                            const cachedData = JSON.parse(cached);
                            console.warn(`Utilisation du prix en cache pour ${ticker}:`, cachedData);
                            return cachedData;
                        }

                        throw error;
                    }
                }

                getCachedPrice(ticker) {
                    const cacheKey = `price_${ticker.toUpperCase()}`;
                    const cached = localStorage.getItem(cacheKey);
                    return cached ? JSON.parse(cached) : null;
                }

                isCacheValid(ticker) {
                    const cached = this.getCachedPrice(ticker);
                    if (!cached) return false;

                    const age = Date.now() - cached.lastUpdate;
                    return age < this.updateInterval;
                }

                async updateAllAssetPrices() {
                    if (!appData.assets || appData.assets.length === 0) return;

                    console.log('Mise à jour des prix des actifs...');

                    for (const asset of appData.assets) {
                        if (asset.ticker) {
                            try {
                                const priceData = await this.fetchAssetPrice(asset.ticker);
                                asset.currentPrice = priceData.price;
                                asset.change24h = priceData.change24h;
                                asset.lastPriceUpdate = priceData.lastUpdate;
                                console.log(`Prix mis à jour pour ${asset.ticker}: €${priceData.price.toFixed(2)}`);
                            } catch (error) {
                                console.error(`Erreur mise à jour ${asset.ticker}:`, error);
                            }
                        }
                    }

                    saveData();

                    if (document.querySelector('#portfolio.active')) {
                        displayAssets();
                    }

                    updateDisplay();
                }

                startAutomaticUpdates() {
                    this.updateAllAssetPrices();

                    if (priceUpdateInterval) {
                        clearInterval(priceUpdateInterval);
                    }

                    priceUpdateInterval = setInterval(() => {
                        this.updateAllAssetPrices();
                    }, this.updateInterval);

                    console.log('Mises à jour automatiques démarrées (toutes les 10 minutes)');
                }

                stopAutomaticUpdates() {
                    if (priceUpdateInterval) {
                        clearInterval(priceUpdateInterval);
                        priceUpdateInterval = null;
                        console.log('Mises à jour automatiques arrêtées');
                    }
                }
            }

            // Instance globale du gestionnaire de prix
            const priceManager = new AssetPriceManager();

            // Fonction pour naviguer entre les pages
            function showPage(pageName) {
                // Si on quitte all-transactions, vider la recherche
                if (document.querySelector('#all-transactions.active') && pageName !== 'all-transactions') {
                    const mainInput = document.getElementById('searchInput');
                    const allTransactionsInput = document.getElementById('allTransactionsSearchInput');

                    if (mainInput) mainInput.value = '';
                    if (allTransactionsInput) allTransactionsInput.value = '';
                }

                // Nettoyer les classes du body
                document.body.classList.remove('all-transactions-active');

                // Masquer toutes les pages
                document.querySelectorAll('.page').forEach(page => {
                    page.style.display = 'none';
                    page.classList.remove('active');
                });

                // Retirer la classe active de tous les boutons de navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Afficher la page demandée
                const targetPage = document.getElementById(pageName);
                if (targetPage) {
                    targetPage.style.display = 'block';
                    targetPage.classList.add('active');
                }

                // Mapper les pages aux index de navigation (en tenant compte du bouton central +)
                const navMapping = {
                    'dashboard': 0,
                    'calendar': 1,
                    'bitcoin': 3,      // Après le bouton central
                    'portfolio': 4     // Dernier bouton
                };

                const navItems = document.querySelectorAll('.nav-item');
                const navIndex = navMapping[pageName];

                if (navIndex !== undefined && navItems[navIndex]) {
                    navItems[navIndex].classList.add('active');
                }

                // Gestion de l'affichage du header/carrousel
                const header = document.querySelector('.header');
                const appContainer = document.querySelector('.app-container');

                if (pageName === 'dashboard') {
                    header.classList.remove('hidden');
                    appContainer.classList.remove('header-hidden');
                } else {
                    header.classList.add('hidden');
                    appContainer.classList.add('header-hidden');
                }

                // Ajouter classe spéciale pour all-transactions
                if (pageName === 'all-transactions') {
                    document.body.classList.add('all-transactions-active');
                }

                // Logique spécifique aux pages
                if (pageName === 'calendar') {
                    generateCalendar();
                    calculateMonthStats();
                    generate3DChart();
                    displayMonthTransactions();
                } else if (pageName === 'portfolio') {
                    displayAssets();
                } else if (pageName === 'tools') {
                    displayFireGoals();
                } else if (pageName === 'bitcoin') {
                    displayBitcoinPage();
                } else if (pageName === 'settings') {
                    displayCategories();
                } else if (pageName === 'dashboard') {
                    displayRecentTransactions();
                } else if (pageName === 'all-transactions') {
                    displayAllTransactionsPage();
                } else if (pageName === 'budget') {
                    updateBudgetDisplay();
                }
            }

            // Fonctions pour le carrousel du header
            function goToHeaderSlide(index) {
                const slides = document.getElementById('headerSlides');
                const indicators = document.querySelectorAll('.header-indicator');

                headerSlideIndex = index;
                slides.style.transform = `translateX(-${index * 100}%)`;

                indicators.forEach((indicator, i) => {
                    indicator.classList.toggle('active', i === index);
                });
            }

            function setupHeaderSwipe() {
                const carousel = document.getElementById('headerCarousel');
                if (!carousel) {
                    console.warn('Header carousel non trouvé');
                    return;
                }

                let startX = 0;
                let startY = 0;
                let isDragging = false;
                let isHorizontalSwipe = false;

                carousel.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    isDragging = true;
                    isHorizontalSwipe = false;
                }, {passive: false});

                carousel.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;

                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;
                    const diffX = Math.abs(currentX - startX);
                    const diffY = Math.abs(currentY - startY);

                    if (diffX > diffY && diffX > 10) {
                        isHorizontalSwipe = true;
                        e.preventDefault();
                    }
                }, {passive: false});

                carousel.addEventListener('touchend', (e) => {
                    if (!isDragging || !isHorizontalSwipe) {
                        isDragging = false;
                        return;
                    }

                    isDragging = false;
                    const endX = e.changedTouches[0].clientX;
                    const diffX = startX - endX;

                    if (Math.abs(diffX) > 50) {
                        if (diffX > 0 && headerSlideIndex < 1) {
                            goToHeaderSlide(headerSlideIndex + 1);
                        } else if (diffX < 0 && headerSlideIndex > 0) {
                            goToHeaderSlide(headerSlideIndex - 1);
                        }
                    }
                }, {passive: false});

                carousel.addEventListener('mousedown', (e) => {
                    startX = e.clientX;
                    isDragging = true;
                    e.preventDefault();
                });

                carousel.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                });

                carousel.addEventListener('mouseup', (e) => {
                    if (!isDragging) return;
                    isDragging = false;

                    const endX = e.clientX;
                    const diffX = startX - endX;

                    if (Math.abs(diffX) > 50) {
                        if (diffX > 0 && headerSlideIndex < 1) {
                            goToHeaderSlide(headerSlideIndex + 1);
                        } else if (diffX < 0 && headerSlideIndex > 0) {
                            goToHeaderSlide(headerSlideIndex - 1);
                        }
                    }
                });

                carousel.addEventListener('mouseleave', () => {
                    isDragging = false;
                });
            }

            // Fonctions Bitcoin
            function getBitcoinTransactions() {
                return appData.transactions.filter(t =>
                    t.category === 'bitcoin' || t.type === 'bitcoin_only'
                );
            }

            function calculateBitcoinStats() {
                const bitcoinTxs = getBitcoinTransactions();

                if (bitcoinTxs.length === 0) {
                    return {
                        totalStack: 0,
                        totalInvested: 0,
                        avgPrice: 0,
                        currentValue: 0,
                        pnl: 0,
                        pnlPercentage: 0
                    };
                }

                const totalStack = bitcoinTxs.reduce((sum, tx) => sum + (tx.bitcoinQuantity || 0), 0);
                const totalInvested = bitcoinTxs.reduce((sum, tx) => sum + tx.amount, 0);
                const avgPrice = totalInvested / totalStack;

                const btcPriceData = priceManager.getCachedPrice('BTC');
                const currentBtcPrice = btcPriceData ? btcPriceData.price : 0;
                const currentValue = totalStack * currentBtcPrice;
                const pnl = currentValue - totalInvested;
                const pnlPercentage = totalInvested > 0 ? (pnl / totalInvested) * 100 : 0;

                return {
                    totalStack,
                    totalInvested,
                    avgPrice,
                    currentValue,
                    pnl,
                    pnlPercentage,
                    currentBtcPrice
                };
            }

            function displayBitcoinSummary() {
                const stats = calculateBitcoinStats();
                const summaryEl = document.getElementById('bitcoinSummary');

                if (stats.totalStack === 0) {
                    summaryEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun achat Bitcoin enregistré</p>';
                    return;
                }

                const pnlColor = stats.pnl >= 0 ? 'var(--revolut-green)' : 'var(--revolut-red)';
                const pnlSign = stats.pnl >= 0 ? '+' : '';

                summaryEl.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px;">
                    <div style="text-align: center;">
                        <div style="color: var(--bitcoin-orange); font-weight: bold; font-size: 1.2rem;">
                            ${stats.totalStack.toFixed(8)}
                        </div>
                        <small style="color: var(--text-secondary);">Total BTC</small>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: ${pnlColor}; font-weight: bold; font-size: 1.2rem;">
                            ${pnlSign}€${Math.abs(stats.pnl).toFixed(0)}
                        </div>
                        <small style="color: var(--text-secondary);">P&L (${pnlSign}${stats.pnlPercentage.toFixed(1)}%)</small>
                    </div>
                </div>
            `;
            }

            function displayBitcoinPage() {
                const stats = calculateBitcoinStats();

                // Mettre à jour les stats principales
                document.getElementById('bitcoinStackMain').textContent = `${stats.totalStack.toFixed(8)}`;
                document.getElementById('bitcoinValueMain').textContent = `€${stats.currentValue.toFixed(0)}`;
                document.getElementById('bitcoinAvgPriceMain').textContent = `€${stats.avgPrice.toFixed(0)}`;

                const pnlEl = document.getElementById('bitcoinPnLMain');
                const pnlColor = stats.pnl >= 0 ? 'var(--revolut-green)' : 'var(--revolut-red)';
                const pnlSign = stats.pnl >= 0 ? '+' : '';
                pnlEl.textContent = `${pnlSign}${stats.pnlPercentage.toFixed(1)}%`;
                pnlEl.style.color = pnlColor;
                pnlEl.className = `secondary-number-bitcoin ${stats.pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}`;

                // Calculer et afficher les métriques de rareté
                updateBitcoinRarityMetrics(stats.totalStack);


                // Afficher les transactions
                displayBitcoinTransactionsModern();
            }

            // Fonction pour calculer et afficher les métriques de rareté
            function updateBitcoinRarityMetrics(totalStack) {
                if (totalStack === 0) {
                    document.getElementById('maxHolders').textContent = '0';
                    document.getElementById('populationPercent').textContent = '0%';
                    return;
                }

                const totalBitcoin = 21000000; // 21 millions de Bitcoin max
                const worldPopulation = 8000000000; // 8 milliards

                const maxHolders = Math.floor(totalBitcoin / totalStack);
                const populationPercent = ((maxHolders / worldPopulation) * 100).toFixed(2);

                document.getElementById('maxHolders').textContent = maxHolders.toLocaleString();
                document.getElementById('populationPercent').textContent = `${populationPercent}%`;
            }



            // Fonction pour afficher les transactions Bitcoin modernes
            function displayBitcoinTransactionsModern() {
                const bitcoinTxs = getBitcoinTransactions().sort((a, b) => new Date(b.date) - new Date(a.date));
                const container = document.getElementById('bitcoinTransactionsList');

                // Mettre à jour le badge de comptage
                document.getElementById('bitcoinTransactionCount').textContent = `${bitcoinTxs.length} transactions`;

                if (bitcoinTxs.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune transaction Bitcoin</p>';
                    return;
                }

                let html = '';
                bitcoinTxs.forEach(tx => {
                    const btcQuantity = tx.bitcoinQuantity || 0;
                    const date = new Date(tx.date);
                    const time = date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
                    const dateStr = date.toLocaleDateString('fr-FR', {day: 'numeric', month: 'short'});

                    // Déterminer le type d'affichage selon la transaction
                    let displayInfo = '';
                    let amountDisplay = '';

                    if (tx.isPureBitcoin || tx.type === 'bitcoin_only') {
                        // Transaction Bitcoin pure
                        if (btcQuantity > 0) {
                            displayInfo = `<span class="transaction-btc-bitcoin">+${btcQuantity.toFixed(8)} BTC</span>`;
                            amountDisplay = '<div class="transaction-price-bitcoin" style="color: var(--bitcoin-orange);">Transfer</div>';
                        } else {
                            displayInfo = `<span class="transaction-btc-bitcoin" style="color: var(--revolut-red);">${btcQuantity.toFixed(8)} BTC</span>`;
                            amountDisplay = '<div class="transaction-price-bitcoin" style="color: var(--bitcoin-orange);">Transfer</div>';
                        }
                    } else {
                        // Transaction Bitcoin classique (achat/vente)
                        if (tx.type === 'expense') {
                            displayInfo = `<span class="transaction-btc-bitcoin">+${btcQuantity.toFixed(8)} BTC</span>`;
                            amountDisplay = `<div class="transaction-price-bitcoin">€${tx.amount.toFixed(2)}</div>`;
                        } else {
                            displayInfo = `<span class="transaction-btc-bitcoin" style="color: var(--revolut-red);">${Math.abs(btcQuantity).toFixed(8)} BTC</span>`;
                            amountDisplay = `<div class="transaction-price-bitcoin" style="color: var(--revolut-green);">+€${tx.amount.toFixed(2)}</div>`;
                        }
                    }

                    html += `
                    <div class="transaction-item-bitcoin" onclick="showTransactionDetails(${tx.id})" style="cursor: pointer;">
                        <div class="transaction-icon-bitcoin">₿</div>
                        <div class="transaction-details-bitcoin">
                            <div class="transaction-name-bitcoin">${tx.name}</div>
                            <div class="transaction-meta-bitcoin">
                                ${displayInfo}
                                <span>•</span>
                                <span>${dateStr}</span>
                            </div>
                        </div>
                        <div class="transaction-amount-bitcoin">
                            ${amountDisplay}
                            <div class="transaction-date-bitcoin">${time}</div>
                        </div>
                    </div>
                `;
                });

                container.innerHTML = html;
            }

            function displayBitcoinTransactions() {
                const bitcoinTxs = getBitcoinTransactions().sort((a, b) => new Date(b.date) - new Date(a.date));
                const container = document.getElementById('bitcoinTransactions');

                if (bitcoinTxs.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun achat Bitcoin</p>';
                    return;
                }

                let html = '';
                bitcoinTxs.forEach(tx => {
                    const btcQuantity = tx.bitcoinQuantity || 0;

                    html += `
                    <div class="transaction-item">
                        <div class="transaction-icon bitcoin">₿</div>
                        <div class="transaction-details">
                            <div class="transaction-name">${tx.name}</div>
                            <div class="transaction-meta">${tx.date} • ${btcQuantity.toFixed(8)} BTC</div>
                        </div>
                        <div class="transaction-amount bitcoin">€${tx.amount.toFixed(2)}</div>
                    </div>
                `;
                });

                container.innerHTML = html;
            }

            // Fonction pour ouvrir la page Budget depuis le menu
            function openBudgetPage() {
                hideProfileMenu();
                showPage('budget');
            }

            // Fonctions pour les catégories
            function loadCategories() {
                const categorySelect = document.getElementById('transactionCategory');
                if (!categorySelect) return;

                categorySelect.innerHTML = '<option value="">Sélectionner une catégorie</option>';

                appData.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    if (category === 'bitcoin') {
                        option.textContent = 'Bitcoin';
                    }
                    categorySelect.appendChild(option);
                });
            }

            function displayCategories() {
                const container = document.getElementById('categoriesList');
                if (!container) return;

                // Calculer l'utilisation de chaque catégorie
                const categoryUsage = {};
                appData.transactions.forEach(transaction => {
                    const category = transaction.category || 'divers';
                    categoryUsage[category] = (categoryUsage[category] || 0) + 1;
                });

                let html = '<div class="categories-container-modern">';

                appData.categories.forEach((category, index) => {
                    const displayName = category === 'bitcoin' ? 'Bitcoin' : category.charAt(0).toUpperCase() + category.slice(1);
                    const canDelete = category !== 'bitcoin';
                    const usage = categoryUsage[category] || 0;
                    const usageText = usage === 0 ? 'Jamais utilisée' :
                        usage === 1 ? '1 transaction' :
                            `${usage} transactions`;

                    // Obtenir l'icône (emoji personnalisé ou par défaut)
                    const mockTransaction = {category: category, type: 'expense'};
                    const categoryIcon = getCategoryIcon(mockTransaction);
                    const iconClass = category.toLowerCase().replace(/[^a-z]/g, '');

                    html += `
                    <div class="category-item-modern" style="animation-delay: ${index * 0.05}s">
                        <div class="category-info-modern">
                            <div class="category-icon-modern ${iconClass}" onclick="changeCategoryEmoji('${category}')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                ${categoryIcon}
                            </div>
                            <div class="category-details-modern">
                                <div class="category-name-modern">${displayName}</div>
                                <div class="category-usage-modern">${usageText}</div>
                            </div>
                        </div>
                        <div class="category-actions-modern">
                            ${canDelete ?
                            `<button class="category-action-btn-modern delete" onclick="deleteCategory('${category}')">Supprimer</button>` :
                            `<div class="category-required-modern">Obligatoire</div>`
                        }
                        </div>
                    </div>
                `;
                });

                html += '</div>';

                container.innerHTML = html;
            }

            function changeCategoryEmoji(category) {
                const currentEmoji = appData.categoryEmojis && appData.categoryEmojis[category]
                    ? appData.categoryEmojis[category]
                    : getCategoryIcon({category: category, type: 'expense'});

                const newEmoji = prompt(
                    `Choisissez un emoji pour "${category}"\n\n` +
                    `Emoji actuel : ${currentEmoji}\n\n` +
                    `Entrez un nouvel emoji (ou laissez vide pour réinitialiser) :`,
                    currentEmoji
                );

                // Si l'utilisateur annule, ne rien faire
                if (newEmoji === null) return;

                // Initialiser categoryEmojis si nécessaire
                if (!appData.categoryEmojis) {
                    appData.categoryEmojis = {};
                }

                // Si vide, supprimer l'emoji personnalisé (revenir au défaut)
                if (newEmoji.trim() === '') {
                    delete appData.categoryEmojis[category];
                    console.log(`✅ Emoji réinitialisé pour ${category}`);
                } else {
                    // Vérifier que c'est bien un emoji (1 à 4 caractères max)
                    if (newEmoji.length > 4) {
                        alert('⚠️ Veuillez entrer un seul emoji (max 4 caractères)');
                        return;
                    }
                    appData.categoryEmojis[category] = newEmoji.trim();
                    console.log(`✅ Emoji changé pour ${category} : ${newEmoji}`);
                }

                // Sauvegarder et rafraîchir l'affichage
                saveData();
                displayCategories();

                // Rafraîchir aussi l'affichage des transactions si on est sur une page qui les affiche
                if (document.querySelector('#dashboard.active')) {
                    displayRecentTransactions();
                }
                if (document.querySelector('#all-transactions.active')) {
                    displayAllTransactionsPage();
                }
            }

            // Fonction pour obtenir l'icône d'affichage des catégories
            function getCategoryIconForDisplay(category) {
                // 🔥 Vérifier d'abord les emojis personnalisés
                if (appData.categoryEmojis && appData.categoryEmojis[category]) {
                    return appData.categoryEmojis[category];
                }

                // Emojis par défaut
                const emojiMap = {
                    'bitcoin': '₿',
                    'alimentation': '🍽️',
                    'transport': '🚗',
                    'carburant': '⛽',
                    'crédit': '💳',
                    'loyer': '🏠',
                    'loisirs': '🎮',
                    'santé': '⚕️',
                    'shopping': '🛍️',
                    'investissement': '📈',
                    'remboursement': '💰',
                    'divers': '📝'
                };

                return emojiMap[category] || '📝';
            }

            function addCategory() {
                const input = document.getElementById('newCategoryInput');
                const newCategory = input.value.trim().toLowerCase();

                if (!newCategory) {
                    alert('Veuillez entrer un nom de catégorie');
                    return;
                }

                if (appData.categories.includes(newCategory)) {
                    alert('Cette catégorie existe déjà');
                    return;
                }

                appData.categories.push(newCategory);
                saveData();
                input.value = '';
                displayCategories();
                loadCategories();
            }

            function deleteCategory(category) {
                if (category === 'bitcoin') {
                    alert('La catégorie Bitcoin ne peut pas être supprimée');
                    return;
                }

                if (confirm(`Supprimer la catégorie "${category}" ?`)) {
                    appData.categories = appData.categories.filter(c => c !== category);

                    appData.transactions.forEach(tx => {
                        if (tx.category === category) {
                            tx.category = 'divers';
                        }
                    });

                    saveData();
                    displayCategories();
                    loadCategories();
                }
            }

            function toggleBitcoinQuantity() {
                const categorySelect = document.getElementById('transactionCategory');
                const bitcoinGroup = document.getElementById('bitcoinQuantityGroup');
                const typeSelect = document.getElementById('transactionType');

                if (categorySelect.value === 'bitcoin') {
                    bitcoinGroup.style.display = 'block';

                    // Changer le texte selon le type
                    const label = bitcoinGroup.querySelector('label');
                    if (typeSelect.value === 'income') {
                        label.textContent = 'Quantité de Bitcoin vendue';
                    } else {
                        label.textContent = 'Quantité de Bitcoin achetée';
                    }
                } else {
                    bitcoinGroup.style.display = 'none';
                    document.getElementById('bitcoinQuantity').value = '';
                }
            }

            // Fonction pour calculer les données Bitcoin depuis les transactions
            function getBitcoinDataFromTransactions() {
                const bitcoinTxs = appData.transactions.filter(t => t.category === 'bitcoin' && t.bitcoinQuantity);

                const totalQuantity = bitcoinTxs.reduce((sum, tx) => sum + (tx.bitcoinQuantity || 0), 0);
                const totalInvested = bitcoinTxs.reduce((sum, tx) => sum + tx.amount, 0);
                const avgPrice = totalQuantity > 0 ? totalInvested / totalQuantity : 0;

                return {
                    quantity: totalQuantity,
                    totalInvested: totalInvested,
                    avgPrice: avgPrice
                };
            }

            // Fonction pour vérifier si c'est Bitcoin et afficher l'option
            function checkBitcoinSync() {
                const ticker = document.getElementById('assetTicker').value.toUpperCase();
                const syncOption = document.getElementById('bitcoinSyncOption');

                if (ticker === 'BTC') {
                    const bitcoinData = getBitcoinDataFromTransactions();

                    if (bitcoinData.quantity > 0) {
                        syncOption.style.display = 'block';
                    } else {
                        syncOption.style.display = 'none';
                    }
                } else {
                    syncOption.style.display = 'none';
                    document.getElementById('bitcoinAutoSync').checked = false;
                }
            }

            // Fonction pour mettre à jour automatiquement Bitcoin lors de nouvelles transactions
            function updateBitcoinAssetFromTransactions() {
                const bitcoinAsset = appData.assets.find(asset => asset.ticker === 'BTC' && asset.autoSyncBitcoin);

                if (bitcoinAsset) {
                    const bitcoinData = getBitcoinDataFromTransactions();

                    bitcoinAsset.quantity = bitcoinData.quantity;
                    bitcoinAsset.totalInvested = bitcoinData.totalInvested;
                    bitcoinAsset.avgPrice = bitcoinData.avgPrice;

                    saveData();

                    // Mettre à jour l'affichage si on est sur la page portfolio
                    if (document.querySelector('#portfolio.active')) {
                        displayAssets();
                        updateDisplay();
                    }

                    console.log('✅ Actif Bitcoin mis à jour automatiquement');
                }
            }

            function toggleEditInvestmentInput() {
                const investmentType = document.getElementById('editInvestmentType').value;
                const avgPriceGroup = document.getElementById('editAvgPriceGroup');
                const totalInvestedGroup = document.getElementById('editTotalInvestedGroup');

                if (investmentType === 'avgPrice') {
                    avgPriceGroup.style.display = 'block';
                    totalInvestedGroup.style.display = 'none';
                    document.getElementById('editAssetTotalInvested').value = '';
                } else {
                    avgPriceGroup.style.display = 'none';
                    totalInvestedGroup.style.display = 'block';
                    document.getElementById('editAssetAvgPrice').value = '';
                }
            }

            function toggleInvestmentInput() {
                const investmentType = document.getElementById('investmentType').value;
                const avgPriceGroup = document.getElementById('avgPriceGroup');
                const totalInvestedGroup = document.getElementById('totalInvestedGroup');

                if (investmentType === 'avgPrice') {
                    avgPriceGroup.style.display = 'block';
                    totalInvestedGroup.style.display = 'none';
                    document.getElementById('assetTotalInvested').value = '';
                } else {
                    avgPriceGroup.style.display = 'none';
                    totalInvestedGroup.style.display = 'block';
                    document.getElementById('assetAvgPrice').value = '';
                }
            }



            function changeMonth(direction) {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
                generateCalendar();
            }

            function selectDate(dateStr) {
                window.selectedDateForTransaction = dateStr;
                const dayTransactions = appData.transactions.filter(t => t.date === dateStr);

                const date = new Date(dateStr);
                const options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                };
                const formattedDate = date.toLocaleDateString('fr-FR', options);

                document.getElementById('dateDetailsTitle').textContent = `Transactions du ${formattedDate}`;

                let html = '';
                if (dayTransactions.length === 0) {
                    html = '<p style="text-align: center; color: var(--text-secondary); margin: 20px 0;">Aucune transaction pour cette date</p>';
                } else {
                    dayTransactions.forEach(transaction => {
                        const isBitcoin = transaction.category === 'bitcoin';
                        const iconType = transaction.type === 'income' ? 'income' : (isBitcoin ? 'bitcoin' : 'expense');
                        const icon = getCategoryIcon(transaction);
                        const amountColor = transaction.type === 'income' ? 'var(--revolut-green)' : 'var(--text-primary)';

                        html += `
                        <div class="transaction-item" onclick="showTransactionDetails(${transaction.id})" style="cursor: pointer;">
                            <div class="transaction-icon ${iconType}">${icon}</div>
                            <div class="transaction-details">
                                <div class="transaction-name">${transaction.name}</div>
                                <div class="transaction-meta">${transaction.category || 'Sans catégorie'}</div>
                            </div>
                            <div class="transaction-amount" style="color: ${amountColor};">
                                ${transaction.type === 'income' ? '+' : '-'}€${Math.abs(transaction.amount).toFixed(2)}
                            </div>
                        </div>
                    `;
                    });
                }

                document.getElementById('dateTransactionsList').innerHTML = html;
                showModal('dateDetailsModal');
            }

            function addTransactionForDate() {
                if (window.selectedDateForTransaction) {
                    document.getElementById('transactionDate').value = window.selectedDateForTransaction;
                }
                hideModal('dateDetailsModal');
                showModal('transactionModal');
            }

            // Fonctions pour les modales
            function showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    // Bloquer le scroll du body
                    document.body.classList.add('modal-open');

                    modal.style.display = 'block';
                    setTimeout(() => {
                        modal.style.opacity = '1';
                    }, 10);

                    if (modalId === 'transactionModal' && !window.editingTransactionId) {
                        // Sauvegarder temporairement la date sélectionnée
                        const savedDate = window.selectedDateForTransaction;

                        resetTransactionModal();
                        loadCategories();
                        setupTransactionNameAutocomplete();

                        // Restaurer la date si elle était définie
                        if (savedDate) {
                            document.getElementById('transactionDate').value = savedDate;
                        }
                    } else if (modalId === 'analyticsModal') {
                        updateAnalyticsDisplay();
                    } else if (modalId === 'bitcoinTransactionModal') {
                        initBitcoinTransactionModal();
                    }
                }
            }

            function hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.opacity = '0';
                    setTimeout(() => {
                        modal.style.display = 'none';
                        // Réactiver le scroll du body
                        document.body.classList.remove('modal-open');
                    }, 300);
                }
            }

            // 🔥 NOUVELLE PAGE DE TRANSACTION SLIDE-UP
            function showAddTransactionPage() {
                const page = document.getElementById('addTransactionPage');
                if (page) {
                    // Bloquer le scroll du body
                    document.body.classList.add('modal-open');

                    // Réinitialiser le formulaire
                    resetNewTransactionForm();

                    // Charger les catégories
                    loadNewCategories();

                    // Définir la date du jour par défaut
                    setNewTodayDate();

                    // Afficher la page avec animation
                    page.style.display = 'flex';
                    setTimeout(() => {
                        page.classList.add('active');
                    }, 10);
                }
            }

            function hideAddTransactionPage() {
                const page = document.getElementById('addTransactionPage');
                if (page) {
                    page.classList.remove('active');
                    setTimeout(() => {
                        page.style.display = 'none';
                        document.body.classList.remove('modal-open');
                    }, 500);
                }
            }

            function selectTransactionType(type) {
                // Mettre à jour le champ hidden
                document.getElementById('newTransactionType').value = type;

                // Mettre à jour les boutons
                const incomeBtn = document.querySelector('.type-btn-income');
                const expenseBtn = document.querySelector('.type-btn-expense');

                if (type === 'income') {
                    incomeBtn.classList.add('active');
                    expenseBtn.classList.remove('active');
                } else {
                    expenseBtn.classList.add('active');
                    incomeBtn.classList.remove('active');
                }
            }

            function toggleNewBitcoinQuantity() {
                const category = document.getElementById('newTransactionCategory').value;
                const bitcoinGroup = document.getElementById('newBitcoinQuantityGroup');

                if (category && category.toLowerCase() === 'bitcoin') {
                    bitcoinGroup.style.display = 'block';
                } else {
                    bitcoinGroup.style.display = 'none';
                    document.getElementById('newBitcoinQuantity').value = '';
                }
            }

            function toggleNewRecurringOptions() {
                const isRecurring = document.getElementById('newTransactionRecurring').checked;
                const recurringOptions = document.getElementById('newRecurringOptions');

                if (isRecurring) {
                    recurringOptions.style.display = 'block';
                    // Définir la date de début par défaut
                    if (!document.getElementById('newRecurringStartDate').value) {
                        document.getElementById('newRecurringStartDate').value = document.getElementById('newTransactionDate').value;
                    }
                } else {
                    recurringOptions.style.display = 'none';
                }
            }

            function loadNewCategories() {
                const categorySelect = document.getElementById('newTransactionCategory');
                categorySelect.innerHTML = '<option value="">Sélectionner une catégorie</option>';

                appData.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }

            function setNewTodayDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('newTransactionDate').value = today;
            }

            function resetNewTransactionForm() {
                // Réinitialiser le formulaire
                document.getElementById('newTransactionForm').reset();

                // Réinitialiser le type à "income"
                document.getElementById('newTransactionType').value = 'income';
                selectTransactionType('income');

                // Cacher les options conditionnelles
                document.getElementById('newBitcoinQuantityGroup').style.display = 'none';
                document.getElementById('newRecurringOptions').style.display = 'none';
                document.getElementById('newTransactionRecurring').checked = false;
            }

            function addNewTransaction() {
                const isRecurring = document.getElementById('newTransactionRecurring').checked;
                const category = document.getElementById('newTransactionCategory').value;
                const type = document.getElementById('newTransactionType').value;
                const bitcoinQuantity = category.toLowerCase() === 'bitcoin' ? parseFloat(document.getElementById('newBitcoinQuantity').value) || 0 : 0;

                // Pour Bitcoin, gérer la quantité selon le type (achat/vente)
                let actualBitcoinQuantity = 0;
                if (category.toLowerCase() === 'bitcoin' && bitcoinQuantity > 0) {
                    if (type === 'expense') {
                        actualBitcoinQuantity = bitcoinQuantity;
                    } else {
                        actualBitcoinQuantity = -bitcoinQuantity;
                    }
                }

                const transactionData = {
                    name: document.getElementById('newTransactionName').value,
                    description: document.getElementById('newTransactionDescription').value.trim() || null,
                    amount: parseFloat(document.getElementById('newTransactionAmount').value),
                    type: type,
                    category: category,
                    bitcoinQuantity: actualBitcoinQuantity,
                    date: document.getElementById('newTransactionDate').value,
                    recurring: isRecurring,
                    frequency: isRecurring ? document.getElementById('newRecurringFrequency').value : null,
                    startDate: isRecurring ? document.getElementById('newRecurringStartDate').value : null,
                    endDate: isRecurring ? document.getElementById('newRecurringEndDate').value || null : null
                };

                // Nouvelle transaction
                const transaction = {
                    id: Date.now(),
                    ...transactionData
                };

                // Ajouter le débiteur si un débiteur était sélectionné
                if (selectedDebtor) {
                    transaction.debtor = {
                        name: selectedDebtor.name,
                        picture: selectedDebtor.picture,
                        isDefault: selectedDebtor.isDefault || false
                    };

                    if (!selectedDebtor.isDefault) {
                        const debtor = appData.debtors.find(d => d.name === selectedDebtor.name);
                        if (debtor) {
                            debtor.usageCount++;
                        }
                    }

                    selectedDebtor = null;
                }

                if (isRecurring) {
                    addRecurringTransactions(transaction);
                } else {
                    appData.transactions.push(transaction);
                }

                // Sauvegarder et mettre à jour
                saveData();

                // Sync automatique (si connecté)
                if (currentUser && supabase) {
                    syncDataSilently();
                }

                // Mettre à jour Bitcoin si nécessaire
                if (transactionData.category.toLowerCase() === 'bitcoin') {
                    updateBitcoinAssetFromTransactions();
                    if (document.querySelector('#bitcoin.active')) {
                        displayBitcoinPage();
                    }
                }

                // Mettre à jour l'affichage
                updateDisplay();
                displayRecentTransactions();

                // Mettre à jour la page all-transactions si elle est active
                if (document.querySelector('#all-transactions.active')) {
                    displayAllTransactionsPage();
                }

                updateAnalyticsDisplay();

                // Fermer la page
                hideAddTransactionPage();
            }

            // Fonction pour ajouter une transaction Bitcoin pure (sans impact euro)
            function addPureBitcoinTransaction() {
                const type = document.getElementById('bitcoinTransactionType').value;
                const quantity = parseFloat(document.getElementById('bitcoinTransactionQuantity').value);
                const description = document.getElementById('bitcoinTransactionDescription').value;
                const date = document.getElementById('bitcoinTransactionDate').value;

                // Nouveaux champs optionnels
                const fromAddress = document.getElementById('bitcoinFromAddress').value.trim();
                const toAddress = document.getElementById('bitcoinToAddress').value.trim();
                const txId = document.getElementById('bitcoinTxId').value.trim();

                if (!quantity || quantity <= 0) {
                    alert('Veuillez entrer une quantité valide');
                    return;
                }

                if (!description.trim()) {
                    alert('Veuillez entrer une description');
                    return;
                }

                // Créer une transaction spéciale qui n'affecte que le Bitcoin
                const bitcoinQuantityToAdd = type === 'add' ? quantity : -quantity;

                const transaction = {
                    id: Date.now(),
                    name: description,
                    amount: 0, // Montant euro = 0 pour ne pas affecter le portefeuille
                    type: 'bitcoin_only', // Type spécial pour identifier ces transactions
                    category: 'bitcoin',
                    bitcoinQuantity: bitcoinQuantityToAdd,
                    date: date,
                    recurring: false,
                    isPureBitcoin: true, // Flag pour identifier les transactions Bitcoin pures
                    // Nouveaux champs optionnels
                    fromAddress: fromAddress || null,
                    toAddress: toAddress || null,
                    transactionId: txId || null
                };

                // Ajouter la transaction
                appData.transactions.push(transaction);

                // Sauvegarder et mettre à jour
                saveData();

                // Mettre à jour Bitcoin
                updateBitcoinAssetFromTransactions();
                if (document.querySelector('#bitcoin.active')) {
                    displayBitcoinPage();
                }

                updateDisplay();

                // Fermer la modal et réinitialiser
                hideModal('bitcoinTransactionModal');
                resetBitcoinTransactionModal();

                // Notification de succès
                const actionText = type === 'add' ? 'ajouté' : 'retiré';
                alert(`${quantity} BTC ${actionText} avec succès !`);
            }

            // Fonction pour réinitialiser la modal Bitcoin
            function resetBitcoinTransactionModal() {
                document.getElementById('bitcoinTransactionForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('bitcoinTransactionDate').value = today;

                // Vider les nouveaux champs optionnels
                document.getElementById('bitcoinFromAddress').value = '';
                document.getElementById('bitcoinToAddress').value = '';
                document.getElementById('bitcoinTxId').value = '';
            }

            // Event listener pour le formulaire Bitcoin
            function setupBitcoinTransactionListener() {
                const bitcoinForm = document.getElementById('bitcoinTransactionForm');
                if (bitcoinForm) {
                    bitcoinForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        addPureBitcoinTransaction();
                    });
                }
            }

            // Fonction pour initialiser la date d'aujourd'hui dans la modal Bitcoin
            function initBitcoinTransactionModal() {
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('bitcoinTransactionDate');
                if (dateInput) {
                    dateInput.value = today;
                }
            }

            // Fonction pour les transactions
            function addTransaction() {
                const isRecurring = document.getElementById('transactionRecurring').value === 'yes';
                const category = document.getElementById('transactionCategory').value;
                const type = document.getElementById('transactionType').value;
                const bitcoinQuantity = category === 'bitcoin' ? parseFloat(document.getElementById('bitcoinQuantity').value) || 0 : 0;

                // Pour Bitcoin, gérer la quantité selon le type (achat/vente)
                let actualBitcoinQuantity = 0;
                if (category === 'bitcoin' && bitcoinQuantity > 0) {
                    if (type === 'expense') {
                        actualBitcoinQuantity = bitcoinQuantity;
                    } else {
                        actualBitcoinQuantity = -bitcoinQuantity;
                    }
                }

                const transactionData = {
                    name: document.getElementById('transactionName').value,
                    description: document.getElementById('transactionDescription').value.trim() || null,
                    amount: parseFloat(document.getElementById('transactionAmount').value),
                    type: type,
                    category: category,
                    bitcoinQuantity: actualBitcoinQuantity,
                    date: document.getElementById('transactionDate').value,
                    recurring: isRecurring,
                    frequency: isRecurring ? document.getElementById('recurringFrequency').value : null,
                    startDate: isRecurring ? document.getElementById('recurringStartDate').value : null,
                    endDate: isRecurring ? document.getElementById('recurringEndDate').value || null : null
                };

                if (window.editingTransactionId) {
                    // Modification d'une transaction existante
                    const transactionIndex = appData.transactions.findIndex(t => t.id === window.editingTransactionId);
                    if (transactionIndex !== -1) {
                        appData.transactions[transactionIndex] = {
                            ...appData.transactions[transactionIndex],
                            ...transactionData
                        };
                    }
                } else {
                    // Nouvelle transaction
                    const transaction = {
                        id: Date.now(),
                        ...transactionData
                    };

                    // 🔥 MODIFICATION ICI : Ajouter le débiteur si un débiteur était sélectionné
                    if (selectedDebtor) {
                        transaction.debtor = {
                            name: selectedDebtor.name,
                            picture: selectedDebtor.picture,
                            isDefault: selectedDebtor.isDefault || false // Marquer si c'est un débiteur par défaut
                        };

                        // 🔥 Incrémenter SEULEMENT si c'est un débiteur créé par l'utilisateur
                        if (!selectedDebtor.isDefault) {
                            const debtor = appData.debtors.find(d => d.name === selectedDebtor.name);
                            if (debtor) {
                                debtor.usageCount++;
                            }
                        }

                        selectedDebtor = null; // Réinitialiser
                    }

                    if (isRecurring) {
                        addRecurringTransactions(transaction);
                    } else {
                        appData.transactions.push(transaction);
                    }
                }

                // Sauvegarder et mettre à jour
                saveData();

                // 🔥 SYNC AUTOMATIQUE (si connecté)
                if (currentUser && supabase) {
                    syncDataSilently();
                }

                // Mettre à jour Bitcoin si nécessaire
                if (transactionData.category === 'bitcoin') {
                    updateBitcoinAssetFromTransactions();
                    if (document.querySelector('#bitcoin.active')) {
                        displayBitcoinPage();
                    }
                }

                // Mettre à jour l'affichage
                updateDisplay();
                displayRecentTransactions();

                // Mettre à jour la page all-transactions si elle est active
                if (document.querySelector('#all-transactions.active')) {
                    displayAllTransactionsPage();
                }

                updateAnalyticsDisplay();

                // Fermer la modal et réinitialiser
                hideModal('transactionModal');
                setTimeout(() => {
                    resetTransactionModal();
                }, 100);
            }

            function addRecurringTransactions(transaction) {
                const startDate = new Date(transaction.startDate);
                const endDate = transaction.endDate ? new Date(transaction.endDate) : null;
                let currentDate = new Date(startDate);
                let counter = 0;
                let createdCount = 0; // 🔥 Compteur de transactions créées
                const maxRecurring = 120; // 🔥 Limite à 120 transactions (10 ans de mensuel)

                while (true) {
                    if (endDate && currentDate > endDate) break;
                    if (createdCount >= maxRecurring) {
                        console.warn(`⚠️ Limite de ${maxRecurring} transactions récurrentes atteinte`);
                        break;
                    }

                    const transactionCopy = {
                        ...transaction,
                        id: Date.now() + counter,
                        date: currentDate.toISOString().split('T')[0]
                    };

                    // Copier explicitement le débiteur si présent
                    if (transaction.debtor) {
                        transactionCopy.debtor = {
                            id: transaction.debtor.id,
                            name: transaction.debtor.name,
                            picture: transaction.debtor.picture
                        };
                    }

                    appData.transactions.push(transactionCopy);
                    counter++;
                    createdCount++; // 🔥 Incrémenter le compteur

                    if (transaction.frequency === 'monthly') {
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    } else if (transaction.frequency === 'weekly') {
                        currentDate.setDate(currentDate.getDate() + 7);
                    } else if (transaction.frequency === 'yearly') {
                        currentDate.setFullYear(currentDate.getFullYear() + 1);
                    }

                    if (currentDate > new Date('2100-01-01')) break;
                }

                console.log(`✅ ${createdCount} transactions récurrentes créées`);
            }



            function toggleRecurringOptions() {
                const recurringSelect = document.getElementById('transactionRecurring');
                const recurringOptions = document.getElementById('recurringOptions');
                const recurringStartDateOptions = document.getElementById('recurringStartDateOptions');
                const recurringEndDateOptions = document.getElementById('recurringEndDateOptions');

                if (recurringSelect.value === 'yes') {
                    recurringOptions.style.display = 'block';
                    recurringStartDateOptions.style.display = 'block';
                    recurringEndDateOptions.style.display = 'block';
                } else {
                    recurringOptions.style.display = 'none';
                    recurringStartDateOptions.style.display = 'none';
                    recurringEndDateOptions.style.display = 'none';
                }
            }

            // Fonctions pour les actifs
            function addAsset() {
                const assetName = document.getElementById('assetName').value;
                const assetTicker = document.getElementById('assetTicker').value.toUpperCase();
                const investmentType = document.getElementById('investmentType').value;
                const isBitcoinSync = document.getElementById('bitcoinAutoSync') && document.getElementById('bitcoinAutoSync').checked;

                let assetQuantity, avgPrice, totalInvested;

                if (isBitcoinSync && assetTicker === 'BTC') {
                    const bitcoinData = getBitcoinDataFromTransactions();
                    assetQuantity = bitcoinData.quantity;
                    avgPrice = bitcoinData.avgPrice;
                    totalInvested = bitcoinData.totalInvested;
                } else {
                    assetQuantity = parseFloat(document.getElementById('assetQuantity').value);

                    if (investmentType === 'avgPrice') {
                        avgPrice = parseFloat(document.getElementById('assetAvgPrice').value);
                        totalInvested = avgPrice * assetQuantity;
                    } else {
                        totalInvested = parseFloat(document.getElementById('assetTotalInvested').value);
                        avgPrice = totalInvested / assetQuantity;
                    }
                }

                const asset = {
                    id: Date.now(),
                    name: assetName,
                    ticker: assetTicker,
                    quantity: assetQuantity,
                    avgPrice: avgPrice,
                    totalInvested: totalInvested,
                    autoSyncBitcoin: isBitcoinSync && assetTicker === 'BTC',
                    currentPrice: 0,
                    change24h: 0,
                    lastPriceUpdate: null,
                    isAutoPrice: true
                };

                priceManager.fetchAssetPrice(assetTicker)
                    .then(priceData => {
                        asset.currentPrice = priceData.price;
                        asset.change24h = priceData.change24h;
                        asset.lastPriceUpdate = priceData.lastUpdate;

                        appData.assets.push(asset);
                        saveData();

                        // 🔥 SYNC AUTOMATIQUE
                        if (currentUser && supabase) {
                            syncDataSilently();
                        }

                        displayAssets();
                        updateDisplay();
                        hideModal('assetModal');
                        resetAssetModal();
                    })
                    .catch(error => {
                        const useManual = confirm(
                            `Impossible de récupérer le prix automatique pour ${assetTicker}.\n` +
                            `Erreur: ${error.message}\n\n` +
                            `Voulez-vous ajouter cet actif avec un prix manuel ?`
                        );

                        if (useManual) {
                            const manualPrice = prompt('Entrez le prix manuel en euros:', '1.00');
                            if (manualPrice && !isNaN(manualPrice)) {
                                asset.currentPrice = parseFloat(manualPrice);
                                asset.isAutoPrice = false;

                                appData.assets.push(asset);
                                saveData();

                                // 🔥 SYNC AUTOMATIQUE
                                if (currentUser && supabase) {
                                    syncDataSilently();
                                }

                                displayAssets();
                                updateDisplay();
                                hideModal('assetModal');
                                resetAssetModal();
                            }
                        }
                    });
            }

            function resetAssetModal() {
                document.getElementById('assetModalTitle').textContent = 'Nouvel Actif';
                document.getElementById('assetForm').reset();
                document.getElementById('assetSubmitBtn').textContent = 'Ajouter avec Prix Auto';
                document.getElementById('investmentType').value = 'avgPrice';
                document.getElementById('bitcoinSyncOption').style.display = 'none';
                toggleInvestmentInput();
                window.editingAssetId = null;
            }

            function displayAssets() {
                let html = '';
                let totalValue = 0;
                let totalInvested = 0;
                let totalChange24h = 0;
                let lastUpdate = null;

                if (appData.assets.length === 0) {
                    html = '<div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;"><svg viewBox="0 0 24 24" fill="none" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><p style="font-size: 16px; margin: 0;">Aucun actif dans votre portefeuille</p><p style="font-size: 14px; margin: 8px 0 0 0; opacity: 0.7;">Ajoutez vos premiers investissements</p></div>';
                } else {
                    appData.assets.forEach(asset => {
                        const currentPrice = asset.currentPrice || asset.avgPrice || 0;
                        const currentValue = asset.quantity * currentPrice;
                        const invested = asset.totalInvested || (asset.avgPrice * asset.quantity);
                        const pnl = currentValue - invested;
                        const pnlPercent = invested > 0 ? (pnl / invested) * 100 : 0;

                        totalValue += currentValue;
                        totalInvested += invested;

                        const change24h = asset.change24h || 0;
                        totalChange24h += (currentValue * change24h / 100);

                        if (asset.lastPriceUpdate) {
                            const assetUpdate = new Date(asset.lastPriceUpdate);
                            if (!lastUpdate || assetUpdate > lastUpdate) {
                                lastUpdate = assetUpdate;
                            }
                        }

                        const pnlClass = pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : 'neutral';
                        const pnlSign = pnl > 0 ? '+' : '';

                        // DÉCLARER syncIndicator ICI, après tous les autres calculs
                        const syncIndicator = asset.autoSyncBitcoin ?
                            `<span style="color: var(--bitcoin-orange); font-size: 10px; margin-left: 4px; font-weight: 600;">🔄 Auto</span>` : '';

                        // MAINTENANT générer le HTML
                        html += `
                        <div class="asset-item-portfolio">
                            <div class="asset-actions-portfolio">
                                <button class="asset-action-btn-portfolio" onclick="editAsset(${asset.id})" title="Modifier">
                                    <svg viewBox="0 0 24 24" fill="none" style="width: 14px; height: 14px;">
                                        <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M18.5 2.50023C18.8978 2.1024 19.4374 1.87891 20 1.87891C20.5626 1.87891 21.1022 2.1024 21.5 2.50023C21.8978 2.89805 22.1213 3.43762 22.1213 4.00023C22.1213 4.56284 21.8978 5.1024 21.5 5.50023L12 15.0002L8 16.0002L9 12.0002L18.5 2.50023Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="asset-content-portfolio">
                                <div class="asset-icon-portfolio">${asset.ticker}</div>
                                <div class="asset-details-portfolio">
                                    <div class="asset-name-portfolio">${asset.name}${syncIndicator}</div>
                                    <div class="asset-meta-portfolio">
                                        <span class="asset-quantity-portfolio">${asset.quantity} ${asset.ticker}</span>
                                        <span class="asset-investment-portfolio">Investi: €${invested.toFixed(0)}</span>
                                    </div>
                                </div>
                                <div class="asset-price-portfolio">
                                    <div class="asset-value-portfolio">€${currentValue.toFixed(2)}</div>
                                    <div class="asset-pnl-portfolio ${pnlClass}">
                                        ${pnlSign}€${Math.abs(pnl).toFixed(0)} (${pnlSign}${pnlPercent.toFixed(1)}%)
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    });
                }

                /// Calculer la performance totale
                const totalPnl = totalValue - totalInvested;
                const totalPnlPercent = totalInvested > 0 ? (totalPnl / totalInvested) * 100 : 0;

                // Mettre à jour les statistiques principales
                document.getElementById('portfolioTotalMain').textContent = `€${totalValue.toLocaleString()}`;

                // Mettre à jour le montant gain/perte
                const pnlAmountEl = document.getElementById('portfolioPnlAmount');
                const pnlSign = totalPnl >= 0 ? '+' : '';
                pnlAmountEl.textContent = `${pnlSign}€${Math.abs(totalPnl).toFixed(0)}`;
                pnlAmountEl.style.color = totalPnl >= 0 ? 'var(--revolut-green)' : 'var(--revolut-red)';

                // Mettre à jour le pourcentage de performance
                const pnlPercentEl = document.getElementById('portfolioPnlPercent');
                pnlPercentEl.textContent = `${pnlSign}${totalPnlPercent.toFixed(1)}%`;
                pnlPercentEl.style.color = totalPnl >= 0 ? 'var(--revolut-green)' : 'var(--revolut-red)';

                document.getElementById('assetsList').innerHTML = html;
                generatePortfolioChart();
            }

            function generatePortfolioChart() {
                const chartContainer = document.getElementById('portfolioChart3D');
                const legendContainer = document.getElementById('portfolioChartLegend');

                if (!chartContainer || !legendContainer) return;

                if (appData.assets.length === 0) {
                    chartContainer.innerHTML = `
                    <div class="chart-empty-modern">
                        <svg class="chart-empty-icon-modern" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <div class="chart-empty-text-modern">Aucun actif</div>
                        <div class="chart-empty-subtext-modern">Ajoutez vos premiers investissements</div>
                    </div>
                `;
                    legendContainer.innerHTML = '';
                    return;
                }

                // Calculer les valeurs par actif
                const assetValues = appData.assets.map(asset => {
                    const price = asset.currentPrice || asset.price || 0;
                    const value = asset.quantity * price;
                    return {
                        name: asset.name,
                        ticker: asset.ticker,
                        value: value
                    };
                }).sort((a, b) => b.value - a.value);

                const totalValue = assetValues.reduce((sum, asset) => sum + asset.value, 0);

                // Couleurs pour le graphique
                const colors = [
                    '#6366f1', '#ec4899', '#f97316', '#10b981',
                    '#f59e0b', '#8b5cf6', '#06b6d4', '#ef4444'
                ];

                // Créer le conteneur du graphique
                chartContainer.innerHTML = `
                <div class="chart-donut-wrapper">
                    <svg class="chart-donut" viewBox="0 0 200 200" id="portfolioChartSvg">
                    </svg>
                    <div class="chart-center-modern">
                        <div class="chart-total-modern">€${totalValue.toLocaleString()}</div>
                        <div class="chart-label-modern">Total</div>
                    </div>
                </div>
            `;

                // Générer les segments SVG
                const svg = document.getElementById('portfolioChartSvg');
                let currentAngle = 0;

                assetValues.forEach((asset, index) => {
                    const percentage = (asset.value / totalValue) * 100;
                    const angle = (asset.value / totalValue) * 360;
                    const color = colors[index % colors.length];

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const pathData = createDonutSegment(currentAngle, currentAngle + angle);

                    path.setAttribute('d', pathData);
                    path.setAttribute('stroke', color);
                    path.setAttribute('class', 'chart-segment-modern');
                    path.style.setProperty('--dash-array', (angle / 360) * 628);

                    svg.appendChild(path);
                    currentAngle += angle;
                });

                // Générer la légende
                const legendHTML = assetValues.map((asset, index) => {
                    const percentage = (asset.value / totalValue) * 100;
                    const color = colors[index % colors.length];

                    return `
                    <div class="legend-item-modern" style="animation-delay: ${index * 0.1}s">
                        <div class="legend-color-modern" style="background: ${color}"></div>
                        <div class="legend-details-modern">
                            <div class="legend-name-modern">${asset.ticker}</div>
                            <div class="legend-amount-modern">€${asset.value.toLocaleString()}</div>
                        </div>
                        <div class="legend-percentage-modern">${percentage.toFixed(1)}%</div>
                    </div>
                `;
                }).join('');

                legendContainer.className = 'chart-legend-modern';
                legendContainer.innerHTML = legendHTML;
            }

            function deleteAssetFromEdit() {
                const assetId = window.editingAssetId;
                if (!assetId) return;

                const asset = appData.assets.find(a => a.id === assetId);
                if (!asset) return;

                if (confirm(`Êtes-vous sûr de vouloir supprimer "${asset.name}" de votre portefeuille ?`)) {
                    // Supprimer l'actif
                    appData.assets = appData.assets.filter(a => a.id !== assetId);

                    // Sauvegarder et mettre à jour
                    saveData();
                    displayAssets();
                    updateDisplay();

                    // Fermer la modal
                    hideModal('editAssetModal');

                    // Nettoyer
                    window.editingAssetId = null;
                }
            }

            function editAsset(assetId) {
                const asset = appData.assets.find(a => a.id === assetId);
                if (!asset) return;

                // Remplir les informations non modifiables
                document.getElementById('editAssetIcon').textContent = asset.ticker;
                document.getElementById('editAssetName').textContent = asset.name;
                document.getElementById('editAssetTicker').textContent = asset.ticker;

                // Remplir les champs modifiables
                document.getElementById('editAssetQuantity').value = asset.quantity;

                // Déterminer le type d'investissement selon les données existantes
                if (asset.avgPrice && asset.avgPrice > 0) {
                    document.getElementById('editInvestmentType').value = 'avgPrice';
                    document.getElementById('editAssetAvgPrice').value = asset.avgPrice;
                } else if (asset.totalInvested && asset.totalInvested > 0) {
                    document.getElementById('editInvestmentType').value = 'totalInvested';
                    document.getElementById('editAssetTotalInvested').value = asset.totalInvested;
                } else {
                    // Fallback si les données sont incomplètes
                    document.getElementById('editInvestmentType').value = 'avgPrice';
                    const calculatedAvgPrice = asset.totalInvested ? asset.totalInvested / asset.quantity : 0;
                    document.getElementById('editAssetAvgPrice').value = calculatedAvgPrice;
                }

                toggleEditInvestmentInput();

                // Stocker l'ID pour la sauvegarde
                window.editingAssetId = assetId;

                showModal('editAssetModal');
            }

            function saveAssetEdit() {
                const assetId = window.editingAssetId;
                if (!assetId) return;

                const asset = appData.assets.find(a => a.id === assetId);
                if (!asset) return;

                const newQuantity = parseFloat(document.getElementById('editAssetQuantity').value);
                const investmentType = document.getElementById('editInvestmentType').value;

                let newAvgPrice = 0;
                let newTotalInvested = 0;

                if (investmentType === 'avgPrice') {
                    newAvgPrice = parseFloat(document.getElementById('editAssetAvgPrice').value);
                    newTotalInvested = newAvgPrice * newQuantity;
                } else {
                    newTotalInvested = parseFloat(document.getElementById('editAssetTotalInvested').value);
                    newAvgPrice = newTotalInvested / newQuantity;
                }

                if (!newQuantity || (!newAvgPrice && !newTotalInvested)) {
                    alert('Veuillez remplir tous les champs requis');
                    return;
                }

                // Mettre à jour l'actif
                asset.quantity = newQuantity;
                asset.avgPrice = newAvgPrice;
                asset.totalInvested = newTotalInvested;

                // Sauvegarder et mettre à jour l'affichage
                saveData();
                displayAssets();
                updateDisplay();
                hideModal('editAssetModal');

                // Nettoyer
                window.editingAssetId = null;
            }

            function deleteAsset(id) {
                if (confirm('Supprimer cet actif ?')) {
                    appData.assets = appData.assets.filter(a => a.id !== id);
                    saveData();
                    displayAssets();
                    updateDisplay();
                }
            }

            // Fonctions pour les calculs financiers
            function calculateCurrentBalance() {
                let balance = appData.settings.currentBalance;
                const today = new Date();
                today.setHours(23, 59, 59, 999);

                appData.transactions.forEach(transaction => {
                    const transactionDate = new Date(transaction.date);
                    if (transactionDate <= today) {
                        balance += transaction.type === 'income' ? transaction.amount : -transaction.amount;
                    }
                });

                return balance;
            }

            function calculateTotalAssets() {
                const cashBalance = calculateCurrentBalance();
                const assetsValue = appData.assets.reduce((total, asset) => {
                    const price = asset.currentPrice || asset.price || 0;
                    return total + (asset.quantity * price);
                }, 0);
                return cashBalance + assetsValue;
            }

            // Fonctions pour les transactions récentes
            function displayRecentTransactions() {
                const today = new Date();
                today.setHours(23, 59, 59, 999);

                // Exclure les transactions Bitcoin pures (transfers)
                const recentTransactions = appData.transactions
                    .filter(transaction => {
                        const transactionDate = new Date(transaction.date);
                        return transactionDate <= today &&
                            !transaction.isPureBitcoin &&
                            transaction.type !== 'bitcoin_only';
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 3);

                let html = '';
                if (recentTransactions.length === 0) {
                    html = '<p style="text-align: center; color: var(--text-secondary); margin: 20px 0;">Aucune transaction</p>';
                } else {
                    recentTransactions.forEach(transaction => {
                        const isBitcoin = transaction.category === 'bitcoin';
                        const iconType = transaction.type === 'income' ? 'income' : (isBitcoin ? 'bitcoin' : 'expense');
                        const icon = getCategoryIcon(transaction);
                        html += `
                        <div class="transaction-item" onclick="showTransactionDetails(${transaction.id})" style="cursor: pointer;">
                            <div class="transaction-icon ${iconType}">${icon}</div>
                            <div class="transaction-details">
                                <div class="transaction-name">${transaction.name}</div>
                                <div class="transaction-meta">${transaction.date} • ${transaction.category || 'Sans catégorie'}</div>
                            </div>
                            <div class="transaction-amount">
                                ${transaction.type === 'income' ? '+' : '-'}€${Math.abs(transaction.amount).toFixed(2)}
                            </div>
                        </div>
                    `;
                    });
                }

                document.getElementById('recentTransactions').innerHTML = html;
            }





            function deleteTransaction(id) {
                if (confirm('Supprimer cette transaction ?')) {
                    appData.transactions = appData.transactions.filter(t => t.id !== id);
                    saveData();

                    // 🔥 SYNC AUTOMATIQUE
                    if (currentUser && supabase) {
                        syncDataSilently();
                    }

                    updateDisplay();
                    displayRecentTransactions();
                    displayAllTransactions();
                    displayBitcoinSummary();
                    generateCalendar();

                    if (window.selectedDateForTransaction) {
                        selectDate(window.selectedDateForTransaction);
                    }
                }
            }

            // Fonctions pour FIRE
            function calculateClassicFire() {
                const monthlyIncome = parseFloat(document.getElementById('classicMonthlyIncome').value) || 0;
                const withdrawalRate = parseFloat(document.getElementById('classicWithdrawalRate').value) / 100 || 0.04;

                if (monthlyIncome <= 0 || withdrawalRate <= 0) {
                    alert('Veuillez entrer des valeurs valides');
                    return;
                }

                const annualIncome = monthlyIncome * 12;
                const requiredCapital = annualIncome / withdrawalRate;
                const currentAssets = calculateTotalAssets();
                const progress = (currentAssets / requiredCapital) * 100;

                const resultHTML = `
                <div style="background: var(--revolut-gray); border-radius: 16px; padding: 20px; margin-top: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--revolut-green); margin-bottom: 8px;">
                            €${requiredCapital.toLocaleString()}
                        </div>
                        <p style="color: var(--text-secondary);">Capital requis</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <p><strong>Revenu annuel:</strong> €${annualIncome.toLocaleString()}</p>
                        <p><strong>Taux de retrait:</strong> ${(withdrawalRate * 100).toFixed(1)}%</p>
                        <div style="margin: 16px 0;">
                            <div style="background: var(--revolut-dark); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${Math.min(progress, 100)}%; height: 100%; background: var(--revolut-green); transition: width 0.3s ease;"></div>
                            </div>
                            <p style="margin-top: 8px;"><strong>Progression:</strong> ${progress.toFixed(1)}%</p>
                        </div>
                    </div>
                    <button onclick="saveClassicFireGoal()" style="background: var(--revolut-green); border: none; color: white; padding: 12px 20px; border-radius: 20px; cursor: pointer; width: 100%; margin-bottom: 8px;">Sauver comme Objectif</button>
                    <button onclick="resetClassicFire()" style="background: var(--revolut-gray); border: none; color: white; padding: 12px 20px; border-radius: 20px; cursor: pointer; width: 100%;">Réinitialiser</button>
                </div>
            `;

                document.getElementById('classicFireResult').innerHTML = resultHTML;
                document.getElementById('classicFireResult').style.display = 'block';

                window.currentClassicResult = {
                    type: 'classic',
                    monthlyIncome,
                    withdrawalRate: withdrawalRate * 100,
                    requiredCapital,
                    annualIncome
                };
            }

            function saveClassicFireGoal() {
                // Vérifier qu'il y a un résultat à sauvegarder
                if (!window.currentClassicResult) {
                    alert('Veuillez d\'abord calculer votre simulation');
                    return;
                }

                // Demander le nom de l'objectif
                const name = prompt('Nom de cet objectif FIRE:', `FIRE Classique - €${window.currentClassicResult.monthlyIncome}/mois`);
                if (!name) return;

                // Créer l'objectif
                const goal = {
                    id: Date.now(),
                    name: name,
                    type: window.currentClassicResult.type,
                    monthlyIncome: window.currentClassicResult.monthlyIncome,
                    withdrawalRate: window.currentClassicResult.withdrawalRate,
                    requiredCapital: window.currentClassicResult.requiredCapital,
                    annualIncome: window.currentClassicResult.annualIncome,
                    createdDate: new Date().toISOString().split('T')[0]
                };

                // Initialiser le tableau des objectifs FIRE s'il n'existe pas
                if (!appData.fireGoals) {
                    appData.fireGoals = [];
                }

                // Ajouter l'objectif
                appData.fireGoals.push(goal);

                // Sauvegarder les données
                saveData();

                // Mettre à jour l'affichage des objectifs FIRE
                displayFireGoals();

                // Nettoyer la variable temporaire
                window.currentClassicResult = null;

                // Réinitialiser le simulateur
                resetClassicFire();

                // Confirmer la sauvegarde
                alert('Objectif FIRE sauvegardé avec succès !');
            }

            function displayFireGoals() {
                if (!appData.fireGoals) appData.fireGoals = [];

                let html = '';
                const currentAssets = calculateTotalAssets();

                if (appData.fireGoals.length === 0) {
                    html = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucun objectif FIRE configuré</p>';
                } else {
                    appData.fireGoals.forEach(goal => {
                        const progress = (currentAssets / goal.requiredCapital) * 100;
                        const remaining = Math.max(0, goal.requiredCapital - currentAssets);

                        html += `
                        <div style="background: linear-gradient(135deg, rgba(0, 122, 239, 0.08), rgba(0, 122, 239, 0.04)); backdrop-filter: blur(30px); border: 1px solid rgba(0, 122, 239, 0.15); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 8px 32px rgba(0, 122, 239, 0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h4 style="margin: 0; color: var(--text-primary);">${goal.name}</h4>
                                <button onclick="deleteFireGoal(${goal.id})" style="background: var(--revolut-red); border: none; color: white; padding: 6px 12px; border-radius: 12px; cursor: pointer; font-size: 12px;">×</button>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <p style="color: var(--text-secondary); margin-bottom: 4px;">Objectif:</p>
                                    <p style="color: var(--text-primary); font-weight: 600;">€${goal.monthlyIncome}/mois</p>
                                </div>
                                <div>
                                    <p style="color: var(--text-secondary); margin-bottom: 4px;">Capital requis:</p>
                                    <p style="color: var(--text-primary); font-weight: 600;">€${goal.requiredCapital.toLocaleString()}</p>
                                </div>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <div style="background: var(--revolut-dark); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${Math.min(progress, 100)}%; height: 100%; background: var(--revolut-blue); transition: width 0.3s ease;"></div>
                                </div>
                                <p style="margin-top: 8px; color: var(--text-primary);"><strong>Progression: ${progress.toFixed(1)}%</strong></p>
                                <p style="margin-top: 4px; color: var(--text-secondary); font-size: 14px;">Reste: €${remaining.toLocaleString()}</p>
                            </div>
                        </div>
                    `;
                    });
                }

                document.getElementById('fireGoalsList').innerHTML = html;
            }

            function toggleFireGoals() {
                const goalsList = document.getElementById('fireGoalsList');
                const classicForm = document.getElementById('classicFireForm');
                const classicResult = document.getElementById('classicFireResult');

                // Masquer le formulaire et les résultats
                classicForm.style.display = 'none';
                classicResult.style.display = 'none';

                if (goalsList.style.display === 'none' || goalsList.style.display === '') {
                    goalsList.style.display = 'block';
                    displayFireGoals();
                } else {
                    goalsList.style.display = 'none';
                }
            }


            function toggleFireForm(type) {
                const form = document.getElementById('classicFireForm');
                const goalsList = document.getElementById('fireGoalsList');
                const results = document.getElementById('classicFireResult');

                // Masquer les objectifs
                goalsList.style.display = 'none';
                results.style.display = 'none';

                if (form.style.display === 'none' || form.style.display === '') {
                    form.style.display = 'block';
                } else {
                    form.style.display = 'none';
                }
            }

            function resetClassicFire() {
                document.getElementById('classicMonthlyIncome').value = '1500';
                document.getElementById('classicWithdrawalRate').value = '4';
                document.getElementById('classicFireResult').style.display = 'none';
                window.currentClassicResult = null;
            }

            function deleteFireGoal(id) {
                if (confirm('Supprimer cet objectif FIRE ?')) {
                    appData.fireGoals = appData.fireGoals.filter(goal => goal.id !== id);
                    saveData();
                    displayFireGoals();
                }
            }

            // Fonctions pour la gestion des données
            function saveData() {
                try {
                    const dataStr = JSON.stringify(appData, null, 2);

                    // 🔥 Vérifier la taille avant sauvegarde
                    if (dataStr.length > 5000000) { // 5MB
                        console.warn('⚠️ Données trop volumineuses !');
                        alert('Attention : Les données sont volumineuses. Pensez à supprimer d\'anciennes transactions.');
                    }

                    localStorage.setItem('moneyflowData', dataStr);
                    localStorage.setItem('lastSaved', new Date().toISOString());

                    checkStorageSize();

                    console.log('✅ Données sauvegardées');

                    if (currentUser && supabase) {
                        syncDataSilently();
                    }
                } catch (error) {
                    console.error('❌ Erreur sauvegarde:', error);
                    alert('❌ Erreur lors de la sauvegarde. Les données sont peut-être trop volumineuses.');
                }
            }

            // Fonction pour sync silencieuse (sans alertes)
            async function syncDataSilently() {
                try {
                    // D'abord vérifier s'il y a des données plus récentes sur le serveur
                    const {data: serverData, error: fetchError} = await supabase
                        .from('user_data')
                        .select('data, updated_at')
                        .eq('user_id', currentUser.id)
                        .single();

                    if (serverData && !fetchError) {
                        const serverDate = new Date(serverData.updated_at);
                        const localDate = new Date(localStorage.getItem('lastSaved') || 0);

                        // Si les données serveur sont plus récentes, les charger silencieusement
                        if (serverDate > localDate) {
                            appData = serverData.data;
                            localStorage.setItem('moneyflowData', JSON.stringify(appData, null, 2));
                            localStorage.setItem('lastSaved', serverData.updated_at);
                            updateDisplay();
                            console.log('🔄 Données mises à jour depuis le serveur');
                            return;
                        }
                    }

                    // Sinon, envoyer les données locales
                    await supabase
                        .from('user_data')
                        .upsert({
                            user_id: currentUser.id,
                            data: appData,
                            updated_at: new Date().toISOString()
                        });
                    console.log('✅ Sync automatique réussie');
                } catch (error) {
                    console.error('❌ Sync automatique échouée:', error);
                }
            }

            function saveData() {
                try {
                    const dataStr = JSON.stringify(appData, null, 2);

                    // 🔥 Vérifier la taille avant sauvegarde
                    const sizeKB = Math.round(dataStr.length / 1024);
                    console.log(`📊 Taille des données: ${sizeKB}KB`);

                    if (dataStr.length > 4500000) { // ~4.5MB (limite sécurisée pour iOS)
                        console.error('❌ Données trop volumineuses !');
                        alert('⚠️ ERREUR : Trop de données !\n\n' +
                            `Taille actuelle: ${sizeKB}KB\n` +
                            `Nombre de transactions: ${appData.transactions.length}\n\n` +
                            'Veuillez supprimer d\'anciennes transactions ou réduire les transactions récurrentes.');
                        return false; // 🔥 Arrêter la sauvegarde
                    }

                    localStorage.setItem('moneyflowData', dataStr);
                    localStorage.setItem('lastSaved', new Date().toISOString());

                    console.log('✅ Données sauvegardées');

                    if (currentUser && supabase) {
                        syncDataSilently();
                    }
                    return true;
                } catch (error) {
                    console.error('❌ Erreur sauvegarde:', error);
                    alert('❌ Erreur lors de la sauvegarde.\n\n' +
                        `Nombre de transactions: ${appData.transactions.length}\n\n` +
                        'Les données sont trop volumineuses pour localStorage.');
                    return false;
                }
            }

            function loadData() {
                console.log('🔄 Chargement des données...');
                const savedData = localStorage.getItem('moneyflowData');

                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        console.log('✅ Données chargées avec succès');

                        // CORRECTION : Mise à jour des catégories
                        const defaultCategories = ['Bitcoin', 'Alimentation', 'Transport', 'Carburant', 'Crédit', 'Loyer', 'Loisirs', 'Santé', 'Shopping', 'Divers', 'Investissement', 'Remboursement'];
                        let userCategories = parsedData.categories || [];

                        defaultCategories.forEach(defaultCat => {
                            const exists = userCategories.some(userCat =>
                                userCat.toLowerCase() === defaultCat.toLowerCase()
                            );
                            if (!exists) {
                                userCategories.push(defaultCat);
                            }
                        });

                        appData = {
                            transactions: parsedData.transactions || [],
                            assets: parsedData.assets || [],
                            fireGoals: parsedData.fireGoals || [],
                            debtors: parsedData.debtors || [],
                            categories: userCategories,
                            categoryEmojis: parsedData.categoryEmojis || {},
                            settings: parsedData.settings || {currentBalance: 0},
                            budgetSettings: parsedData.budgetSettings || {
                                enabled: false,
                                global: 2500,
                                categories: {
                                    alimentation: 500,
                                    loisirs: 300,
                                    shopping: 200,
                                    bitcoin: 1000,
                                    divers: 350
                                },
                                alerts: {
                                    threshold80: true,
                                    threshold100: true
                                }
                            },
                            budgetAlerts: parsedData.budgetAlerts || {}
                        };

                        console.log('📊 Données chargées:', {
                            transactions: appData.transactions.length,
                            assets: appData.assets.length,
                            debtors: appData.debtors.length,
                            categoryEmojis: Object.keys(appData.categoryEmojis || {}).length
                        });

                        // 🔥 MIGRATION AUTOMATIQUE DES DÉBITEURS (1 seule fois)
                        const migrationKey = 'debtorsMigrationDone_v1';
                        if (!localStorage.getItem(migrationKey)) {
                            console.log('🔄 Lancement de la migration des débiteurs...');
                            const updated = applyDebtorsToExistingTransactions();
                            if (updated > 0) {
                                console.log(`✅ Migration automatique : ${updated} transactions associées`);
                                // Notification discrète (pas d'alerte)
                                setTimeout(() => {
                                    const notification = document.createElement('div');
                                    notification.style.cssText = `
                                        position: fixed;
                                        top: 80px;
                                        left: 50%;
                                        transform: translateX(-50%);
                                        background: rgba(16, 185, 129, 0.95);
                                        backdrop-filter: blur(10px);
                                        color: white;
                                        padding: 12px 24px;
                                        border-radius: 20px;
                                        font-size: 14px;
                                        font-weight: 500;
                                        z-index: 10000;
                                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                                        animation: slideDown 0.3s ease-out;
                                    `;
                                    notification.textContent = `✅ ${updated} transaction(s) associée(s) automatiquement`;
                                    document.body.appendChild(notification);

                                    setTimeout(() => {
                                        notification.style.animation = 'slideUp 0.3s ease-out';
                                        setTimeout(() => notification.remove(), 300);
                                    }, 3000);
                                }, 1000);
                            }
                            localStorage.setItem(migrationKey, 'true');
                        }

                    } catch (e) {
                        console.error('❌ Erreur parsing localStorage:', e);
                        console.log('⚠️ Tentative de récupération...');

                        // 🔥 En cas d'erreur, ne pas tout perdre
                        if (!appData.debtors) appData.debtors = [];
                        if (!appData.transactions) appData.transactions = [];
                        if (!appData.assets) appData.assets = [];
                        if (!appData.categoryEmojis) appData.categoryEmojis = {};

                        // Vider le localStorage corrompu et sauvegarder ce qui reste
                        localStorage.removeItem('moneyflowData');
                        saveData();

                        alert('⚠️ Erreur de chargement des données. Certaines données ont pu être récupérées.');
                    }
                } else {
                    console.log('ℹ️ Aucune donnée sauvegardée, initialisation...');
                    // 🔥 Initialiser categoryEmojis même pour une nouvelle installation
                    if (!appData.categoryEmojis) {
                        appData.categoryEmojis = {};
                    }
                }

                if (!appData.categories.includes('bitcoin')) {
                    appData.categories.unshift('bitcoin');
                }

                if (!appData.debtors) {
                    appData.debtors = [];
                }

                // 🔥 S'assurer que categoryEmojis existe toujours
                if (!appData.categoryEmojis) {
                    appData.categoryEmojis = {};
                }
            }

            // 🔥 Fonction pour vérifier la taille des données
            function checkStorageSize() {
                const data = localStorage.getItem('moneyflowData');
                if (data) {
                    const sizeKB = Math.round(data.length / 1024);
                    const maxSizeKB = 5000; // iOS limite souvent à 5-10MB

                    console.log(`📊 Taille localStorage: ${sizeKB}KB / ${maxSizeKB}KB`);

                    if (sizeKB > maxSizeKB * 0.8) {
                        console.warn('⚠️ localStorage proche de la limite !');
                        return false;
                    }
                    return true;
                }
                return true;
            }

            // Fonction pour exporter UNIQUEMENT les transactions Bitcoin + catégories
            function exportBitcoinOnly() {
                // Filtrer uniquement les transactions Bitcoin
                const bitcoinTransactions = appData.transactions.filter(t =>
                    t.category === 'bitcoin' || t.isPureBitcoin || t.type === 'bitcoin_only'
                );

                if (bitcoinTransactions.length === 0) {
                    alert('Aucune transaction Bitcoin à exporter');
                    return;
                }

                const bitcoinData = {
                    transactions: bitcoinTransactions,
                    categories: appData.categories || [], // 🔥 AJOUT des catégories
                    exportDate: new Date().toISOString(),
                    count: bitcoinTransactions.length
                };

                const dataStr = JSON.stringify(bitcoinData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `bitcoin-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                alert(`✅ ${bitcoinTransactions.length} transactions Bitcoin + catégories exportées`);
            }

            // Fonction pour importer UNIQUEMENT les transactions Bitcoin + catégories
            function importBitcoinOnly(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        if (!importedData.transactions || !Array.isArray(importedData.transactions)) {
                            alert('Format de fichier invalide');
                            return;
                        }

                        // Vérifier que ce sont bien des transactions Bitcoin
                        const bitcoinTxs = importedData.transactions.filter(t =>
                            t.category === 'bitcoin' || t.isPureBitcoin || t.type === 'bitcoin_only'
                        );

                        if (bitcoinTxs.length === 0) {
                            alert('Aucune transaction Bitcoin trouvée dans le fichier');
                            return;
                        }

                        // 🔥 Préparer le message de confirmation avec les catégories
                        let confirmMessage = `Voulez-vous importer ${bitcoinTxs.length} transactions Bitcoin ?\n\n`;

                        if (importedData.categories && importedData.categories.length > 0) {
                            const newCategories = importedData.categories.filter(c => !appData.categories.includes(c));
                            if (newCategories.length > 0) {
                                confirmMessage += `Nouvelles catégories à ajouter : ${newCategories.join(', ')}\n\n`;
                            }
                        }

                        confirmMessage += `⚠️ Cela ajoutera ces transactions à vos données existantes.`;

                        const confirmImport = confirm(confirmMessage);

                        if (!confirmImport) return;

                        // 🔥 Importer les catégories
                        if (importedData.categories && Array.isArray(importedData.categories)) {
                            importedData.categories.forEach(category => {
                                if (!appData.categories.includes(category)) {
                                    appData.categories.push(category);
                                    console.log(`✅ Catégorie ajoutée : ${category}`);
                                }
                            });
                        }

                        // Ajouter les transactions Bitcoin aux données existantes
                        bitcoinTxs.forEach(tx => {
                            // Générer un nouvel ID pour éviter les conflits
                            tx.id = Date.now() + Math.random() * 1000;
                            appData.transactions.push(tx);
                        });

                        saveData();
                        loadCategories(); // 🔥 Recharger les catégories dans les selects
                        updateDisplay();
                        updateBitcoinAssetFromTransactions();

                        if (document.querySelector('#bitcoin.active')) {
                            displayBitcoinPage();
                        }

                        alert(`✅ ${bitcoinTxs.length} transactions Bitcoin + catégories importées avec succès !`);
                        location.reload();

                    } catch (error) {
                        alert('Erreur lors de l\'importation : ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            function exportData() {
                const dataStr = JSON.stringify(appData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `moneyflow-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.transactions && Array.isArray(importedData.transactions)) {
                            appData = {
                                transactions: importedData.transactions || [],
                                assets: importedData.assets || [],
                                fireGoals: importedData.fireGoals || [],
                                categories: importedData.categories || ['Bitcoin', 'Alimentation', 'Transport', 'Carburant', 'Crédit', 'Loyer', 'Loisirs', 'Santé', 'Shopping', 'Divers', 'Investissement', 'Remboursement'],
                                settings: importedData.settings || {currentBalance: 0}
                            };

                            if (!appData.categories.includes('bitcoin')) {
                                appData.categories.unshift('bitcoin');
                            }

                            saveData();
                            updateDisplay();
                            alert('Données importées avec succès !');
                            location.reload();
                        } else {
                            alert('Format de fichier invalide');
                        }
                    } catch (error) {
                        alert('Erreur lors de l\'importation : ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            function clearAllData() {
                if (confirm('Êtes-vous sûr de vouloir effacer toutes les données ? Cette action est irréversible.')) {
                    localStorage.removeItem('moneyflowData');
                    appData = {
                        transactions: [],
                        assets: [],
                        fireGoals: [],
                        debtors: [], // 🔥 AJOUTER CETTE LIGNE
                        categories: ['Bitcoin', 'Alimentation', 'Transport', 'Carburant', 'Crédit', 'Loyer', 'Loisirs', 'Santé', 'Shopping', 'Divers', 'Investissement', 'Remboursement'],
                        settings: {currentBalance: 0}
                    };
                    updateDisplay();
                    loadCategories();
                    displayCategories();
                    alert('Toutes les données ont été effacées.');
                }
            }

            // Fonction pour mettre à jour l'affichage
            function updateDisplay() {
                const balance = calculateCurrentBalance();
                const totalAssets = calculateTotalAssets();

                document.getElementById('headerBalance').textContent = `€${balance.toLocaleString()}`;
                document.getElementById('headerTotalAssets').textContent = `€${totalAssets.toLocaleString()}`;


                displayFireGoals();
                displayRecentTransactions();

                if (document.querySelector('#bitcoin.active')) {
                    displayBitcoinPage();
                }
            }

            // Fonctions utilitaires
            function setTodayDate() {
                const today = new Date().toISOString().split('T')[0];
                const transactionDate = document.getElementById('transactionDate');
                if (transactionDate) {
                    transactionDate.value = today;
                }
            }

            function setupEventListeners() {
                setupBitcoinTransactionListener();

                const editBitcoinForm = document.getElementById('editBitcoinTransactionForm');
                if (editBitcoinForm) {
                    editBitcoinForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        saveBitcoinTransactionEdit();
                    });
                }

                const assetTickerInput = document.getElementById('assetTicker');
                if (assetTickerInput) {
                    assetTickerInput.addEventListener('input', checkBitcoinSync);
                    assetTickerInput.addEventListener('blur', checkBitcoinSync); // Ajouter aussi sur blur
                }

                const transactionForm = document.getElementById('transactionForm');
                if (transactionForm) {
                    transactionForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        addTransaction();
                    });
                }

                // 🔥 Event listener pour le nouveau formulaire de transaction
                const newTransactionForm = document.getElementById('newTransactionForm');
                if (newTransactionForm) {
                    newTransactionForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        addNewTransaction();
                    });
                }

                // 🔥 Fermer la page en cliquant sur l'overlay
                const addTransactionPage = document.getElementById('addTransactionPage');
                if (addTransactionPage) {
                    addTransactionPage.addEventListener('click', function (e) {
                        if (e.target === addTransactionPage) {
                            hideAddTransactionPage();
                        }
                    });
                }

                const transactionType = document.getElementById('transactionType');
                if (transactionType) {
                    transactionType.addEventListener('change', function () {
                        toggleBitcoinQuantity(); // Relancer pour mettre à jour le texte
                    });
                }

                const assetTicker = document.getElementById('assetTicker');
                if (assetTicker) {
                    assetTicker.addEventListener('input', checkBitcoinSync);
                }

                const assetForm = document.getElementById('assetForm');
                if (assetForm) {
                    assetForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        addAsset();
                    });
                }

                const editAssetForm = document.getElementById('editAssetForm');
                if (editAssetForm) {
                    editAssetForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        saveAssetEdit();
                    });
                }

                window.addEventListener('click', function (event) {
                    if (event.target.classList.contains('modal')) {
                        // Trouver quelle modale est ouverte
                        const openModal = event.target;
                        const modalId = openModal.id;

                        // Fermer la modale (ce qui réactivera automatiquement le scroll)
                        hideModal(modalId);
                    }
                });
            }

            // Fonctions globales - À DÉPLACER ICI
            window.displayRecentTransactions = displayRecentTransactions;
            window.showPage = showPage;
            window.showModal = showModal;
            window.hideModal = hideModal;
            window.changeMonth = changeMonth;
            window.selectDate = selectDate;
            window.addTransactionForDate = addTransactionForDate;
            window.deleteTransaction = deleteTransaction;
            window.calculateClassicFire = calculateClassicFire;
            window.saveClassicFireGoal = saveClassicFireGoal;
            window.deleteAsset = deleteAsset;
            window.deleteFireGoal = deleteFireGoal;
            window.exportData = exportData;
            window.importData = importData;
            window.clearAllData = clearAllData;
            window.toggleFireForm = toggleFireForm;
            window.resetClassicFire = resetClassicFire;
            window.editAsset = editAsset;
            window.toggleRecurringOptions = toggleRecurringOptions;
            window.toggleBitcoinQuantity = toggleBitcoinQuantity;
            window.addCategory = addCategory;
            window.deleteCategory = deleteCategory;
            window.goToHeaderSlide = goToHeaderSlide;
            window.searchTransactions = searchTransactions;
            window.highlightTransaction = highlightTransaction;
            window.changeAnalyticsMonth = changeAnalyticsMonth;
            window.updateAnalyticsDisplay = updateAnalyticsDisplay;
            window.showTransactionDetails = showTransactionDetails;
            window.resetTransactionModal = resetTransactionModal;
            window.clearSearch = clearSearch;
            window.showAllSearchResults = showAllSearchResults;
            window.handleTransactionsScroll = handleTransactionsScroll;
            window.groupTransactionsByDate = groupTransactionsByDate;
            window.generateTransactionHTML = generateTransactionHTML;
            window.backToSearchResults = backToSearchResults;
            window.uploadProfilePicture = uploadProfilePicture;
            window.handleProfilePictureUpload = handleProfilePictureUpload;
            window.login = login;
            window.register = register;
            window.logout = logout;
            window.syncData = syncData;
            window.filterAllTransactions = filterAllTransactions;
            window.filterByMonth = filterByMonth;
            window.handleAllTransactionsScroll = handleAllTransactionsScroll;
            window.displayAllTransactionsPage = displayAllTransactionsPage;
            window.applySortToTransactions = applySortToTransactions;
            window.showModernTooltip = showModernTooltip;
            window.hideModernTooltip = hideModernTooltip;
            window.updateModernTooltipPosition = updateModernTooltipPosition;
            window.editTransactionFromDetails = editTransactionFromDetails;
            window.deleteTransactionFromDetails = deleteTransactionFromDetails;
            window.clearAllTransactionsSearch = clearAllTransactionsSearch;
            window.syncSearchInputs = syncSearchInputs;
            window.handleMainSearchInput = handleMainSearchInput;
            window.handleSearchFocus = handleSearchFocus;
            window.showAuthOptions = showAuthOptions;
            window.openDataManagementPage = openDataManagementPage;
            window.toggleCompoundSimulator = toggleCompoundSimulator;
            window.calculateCompoundInterest = calculateCompoundInterest;
            window.resetCompoundSimulator = resetCompoundSimulator;
            window.toggleFireGoals = toggleFireGoals;
            window.toggleInvestmentInput = toggleInvestmentInput;
            window.resetAssetModal = resetAssetModal;
            window.toggleEditInvestmentInput = toggleEditInvestmentInput;
            window.saveAssetEdit = saveAssetEdit;
            window.deleteAssetFromEdit = deleteAssetFromEdit;
            window.checkBitcoinSync = checkBitcoinSync;
            window.updateBitcoinAssetFromTransactions = updateBitcoinAssetFromTransactions;
            window.getBitcoinDataFromTransactions = getBitcoinDataFromTransactions;
            window.checkBitcoinSync = checkBitcoinSync;
            window.updateBitcoinAssetFromTransactions = updateBitcoinAssetFromTransactions;
            window.getBitcoinDataFromTransactions = getBitcoinDataFromTransactions;
            window.changeBudgetMonth = changeBudgetMonth;
            window.updateBudgetDisplay = updateBudgetDisplay;
            window.calculateMonthExpenses = calculateMonthExpenses;
            window.updateBudgetCategories = updateBudgetCategories;
            window.toggleBudgetEnabled = toggleBudgetEnabled;
            window.saveBudgetSettings = saveBudgetSettings;
            window.editCategoryBudget = editCategoryBudget;
            window.showBudgetAlert = showBudgetAlert;
            window.checkBudgetThresholds = checkBudgetThresholds;
            window.openBudgetSettings = openBudgetSettings;
            window.updateBudgetCategoryList = updateBudgetCategoryList;
            window.updateAvailableCategories = updateAvailableCategories;
            window.addCategoryBudget = addCategoryBudget;
            window.editBudgetCategory = editBudgetCategory;
            window.deleteBudgetCategory = deleteBudgetCategory;
            window.displayAllCategoriesForBudget = displayAllCategoriesForBudget;
            window.updateBudgetStatus = updateBudgetStatus;
            window.updateBudgetToggleButton = updateBudgetToggleButton;
            window.addPureBitcoinTransaction = addPureBitcoinTransaction;
            window.resetBitcoinTransactionModal = resetBitcoinTransactionModal;
            window.setupBitcoinTransactionListener = setupBitcoinTransactionListener;
            window.initBitcoinTransactionModal = initBitcoinTransactionModal;
            window.openEditBitcoinTransactionModal = openEditBitcoinTransactionModal;
            window.openEditNormalTransactionModal = openEditNormalTransactionModal;
            window.saveBitcoinTransactionEdit = saveBitcoinTransactionEdit;
            window.deleteBitcoinTransactionFromEdit = deleteBitcoinTransactionFromEdit;
            window.getCategoryIcon = getCategoryIcon;

            // ========== FONCTIONS BUDGET ==========

            function changeBudgetMonth(direction) {
                currentBudgetDate.setMonth(currentBudgetDate.getMonth() + direction);
                updateBudgetDisplay();
            }

            function updateBudgetDisplay() {
                const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                    'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

                const currentMonth = currentBudgetDate.getMonth();
                const currentYear = currentBudgetDate.getFullYear();

                const monthEl = document.getElementById('currentBudgetMonth');
                if (monthEl) {
                    monthEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
                }

                if (!appData.budgetSettings || !appData.budgetSettings.enabled) {
                    const totalEl = document.getElementById('budgetTotalAmount');
                    const statusEl = document.getElementById('budgetStatusText');
                    const listEl = document.getElementById('budgetCategoriesList');

                    if (totalEl) totalEl.textContent = '€0.00';
                    if (statusEl) statusEl.textContent = 'Budget mensuel • Configurez vos budgets';
                    if (listEl) listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">Activez les budgets pour commencer le suivi</div>';
                    return;
                }

                const monthExpenses = calculateMonthExpenses(currentMonth, currentYear);
                const totalBudget = appData.budgetSettings.global;

                // Calculer seulement les dépenses des catégories budgétisées
                let totalSpent = 0;
                if (appData.budgetSettings.categories) {
                    for (const [category, budgetAmount] of Object.entries(appData.budgetSettings.categories)) {
                        if (budgetAmount > 0) {  // Seulement les catégories budgétisées
                            totalSpent += monthExpenses[category] || 0;
                        }
                    }
                }

                const usagePercentage = totalBudget > 0 ? Math.round((totalSpent / totalBudget) * 100) : 0;

                const totalEl = document.getElementById('budgetTotalAmount');
                const statusEl = document.getElementById('budgetStatusText');

                if (totalEl) totalEl.textContent = `€${totalBudget.toFixed(2)}`;
                if (statusEl) statusEl.textContent = `Budget mensuel • ${usagePercentage}% utilisé`;

                updateBudgetCategories(monthExpenses);
            }

            function calculateMonthExpenses(month, year) {
                const expenses = {};

                appData.transactions.forEach(transaction => {
                    if (transaction.type === 'expense') {
                        const transactionDate = new Date(transaction.date);
                        if (transactionDate.getMonth() === month && transactionDate.getFullYear() === year) {
                            const category = transaction.category || 'divers';
                            expenses[category] = (expenses[category] || 0) + transaction.amount;
                        }
                    }
                });

                return expenses;
            }

            function updateBudgetCategories(monthExpenses) {
                const container = document.getElementById('budgetCategoriesList');
                if (!container) return;

                let html = '';

                if (!appData.budgetSettings || !appData.budgetSettings.categories) {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">Configurez vos budgets par catégorie</div>';
                    return;
                }

                // Créer un tableau avec SEULEMENT les catégories qui ont un budget > 0
                const budgetedCategories = [];

                for (const [category, budgetAmount] of Object.entries(appData.budgetSettings.categories)) {
                    if (budgetAmount > 0) {
                        const spent = monthExpenses[category] || 0;
                        budgetedCategories.push({
                            category,
                            budgetAmount,
                            spent,
                            remaining: budgetAmount - spent,
                            percentage: Math.min((spent / budgetAmount) * 100, 100)
                        });
                    }
                }

                // Trier par ordre décroissant de dépenses
                budgetedCategories.sort((a, b) => b.spent - a.spent);

                // Si aucune catégorie n'a de budget > 0
                if (budgetedCategories.length === 0) {
                    html = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">Aucun budget configuré avec un montant > 0</div>';
                    container.innerHTML = html;
                    return;
                }

                // Commencer le conteneur unique
                html = '<div class="budget-categories-container">';

                // Générer le HTML pour chaque catégorie
                budgetedCategories.forEach((item, index) => {
                    const {category, budgetAmount, spent, remaining, percentage} = item;

                    let statusClass = 'safe';
                    if (percentage >= 100) {
                        statusClass = 'danger';
                    } else if (percentage >= 80) {
                        statusClass = 'warning';
                    }

                    html += `
                    <div class="category-budget-card-clean">
                        <div class="budget-category-header-clean">
                            <div class="budget-category-name-clean">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                            <button class="budget-edit-btn" onclick="openBudgetSettings()">⚙️</button>
                        </div>
                        <div class="budget-amounts-clean">
                            <span class="budget-spent-clean">€${spent.toFixed(2)}</span>
                            <span class="budget-total-clean">/ €${budgetAmount.toFixed(2)}</span>
                            <span class="budget-remaining-clean ${remaining >= 0 ? 'positive' : 'negative'}">
                                ${remaining >= 0 ? `€${remaining.toFixed(2)} restant` : `-€${Math.abs(remaining).toFixed(2)} dépassé`}
                            </span>
                        </div>
                        <div class="budget-progress-bar-clean">
                            <div class="budget-progress-fill-clean ${statusClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                    </div>
                `;
                });

                // Fermer le conteneur unique
                html += '</div>';

                container.innerHTML = html;
            }


            function toggleBudgetEnabled() {
                if (!appData.budgetSettings) {
                    appData.budgetSettings = {
                        enabled: false,
                        global: 2500,
                        categories: {},
                        alerts: {threshold80: true, threshold100: true}
                    };
                }

                // Vérifier qu'il y a des budgets configurés
                const hasActiveBudgets = appData.budgetSettings.categories &&
                    Object.values(appData.budgetSettings.categories).some(amount => amount > 0);

                if (!hasActiveBudgets && !appData.budgetSettings.enabled) {
                    showBudgetAlert('Configurez d\'abord vos budgets !', 'warning');
                    showModal('budgetSettingsModal');
                    return;
                }

                appData.budgetSettings.enabled = !appData.budgetSettings.enabled;
                saveData();
                updateBudgetDisplay();
                updateBudgetToggleButton();

                // Supprimez ces lignes pour retirer la notification :
                // showBudgetAlert(
                //     appData.budgetSettings.enabled ? 'Suivi budget activé !' : 'Suivi budget désactivé', 
                //     appData.budgetSettings.enabled ? 'success' : 'warning'
                // );
            }

            function saveBudgetSettings() {
                const globalBudget = parseFloat(document.getElementById('globalBudgetInput').value) || 0;

                if (!appData.budgetSettings) {
                    appData.budgetSettings = {
                        enabled: false,
                        global: 0,
                        categories: {},
                        alerts: {threshold80: true, threshold100: true}
                    };
                }

                appData.budgetSettings.global = globalBudget;

                let hasActiveBudgets = false;
                appData.categories.forEach(category => {
                    const input = document.getElementById(`budget_${category}`);
                    if (input) {
                        const value = parseFloat(input.value) || 0;
                        appData.budgetSettings.categories[category] = value;
                        if (value > 0) {
                            hasActiveBudgets = true;
                        }
                    }
                });

                if (hasActiveBudgets && globalBudget > 0) {
                    appData.budgetSettings.enabled = true;
                }

                saveData();

                // 🔥 SYNC AUTOMATIQUE
                if (currentUser && supabase) {
                    syncDataSilently();
                }

                updateBudgetDisplay();
                updateBudgetToggleButton();
                hideModal('budgetSettingsModal');

                if (hasActiveBudgets) {
                    showBudgetAlert(`Budgets configurés et activés !`, 'success');
                } else {
                    showBudgetAlert(`Configuration sauvegardée !`, 'success');
                }
            }

            function updateBudgetToggleButton() {
                const toggleText = document.getElementById('budgetToggleText');
                if (toggleText && appData.budgetSettings) {
                    toggleText.textContent = appData.budgetSettings.enabled ? 'Désactiver' : 'Activer';
                }
            }

            function editCategoryBudget(category) {
                const newAmount = prompt(`Nouveau budget pour ${category} :`, appData.budgetSettings.categories[category] || 0);
                if (newAmount && !isNaN(newAmount)) {
                    appData.budgetSettings.categories[category] = parseInt(newAmount);
                    saveData();
                    updateBudgetDisplay();
                    showBudgetAlert(`Budget ${category} mis à jour !`, 'success');
                }
            }

            function openBudgetSettings() {
                showModal('budgetSettingsModal');

                // Initialiser budgetSettings si ça n'existe pas
                if (!appData.budgetSettings) {
                    appData.budgetSettings = {
                        enabled: false,
                        global: 2500,
                        categories: {},
                        alerts: {threshold80: true, threshold100: true}
                    };
                }

                // Remplir le budget global avec la valeur sauvegardée
                const globalInput = document.getElementById('globalBudgetInput');
                if (globalInput) {
                    globalInput.value = appData.budgetSettings.global || 2500;
                }

                // Afficher toutes les catégories avec leurs valeurs sauvegardées
                displayAllCategoriesForBudget();
            }

            // Afficher toutes les catégories avec leurs champs budget
            function displayAllCategoriesForBudget() {
                const container = document.getElementById('allCategoriesList');
                if (!container) return;

                let html = '';

                appData.categories.forEach(category => {
                    // Récupérer la valeur sauvegardée
                    const currentBudget = (appData.budgetSettings &&
                        appData.budgetSettings.categories &&
                        appData.budgetSettings.categories[category]) || 0;

                    const isActive = currentBudget > 0;
                    const displayName = category === 'bitcoin' ? 'Bitcoin' : category.charAt(0).toUpperCase() + category.slice(1);

                    html += `
                    <div class="category-budget-item">
                        <div class="category-budget-name">${displayName}</div>
                        <div style="display: flex; align-items: center;">
                            <input 
                                type="number" 
                                class="category-budget-input" 
                                id="budget_${category}"
                                placeholder="0"
                                value="${currentBudget > 0 ? currentBudget : ''}"
                                oninput="updateBudgetStatus('${category}')"
                            >
                            <span style="margin: 0 8px; color: var(--text-secondary);">€</span>
                            <div class="budget-status-indicator ${isActive ? 'active' : 'inactive'}" id="status_${category}"></div>
                        </div>
                    </div>
                `;
                });

                container.innerHTML = html;
            }

            function updateBudgetStatus(category) {
                const input = document.getElementById(`budget_${category}`);
                const indicator = document.getElementById(`status_${category}`);

                if (!input || !indicator) return;

                const value = parseInt(input.value) || 0;

                if (value > 0) {
                    indicator.className = 'budget-status-indicator active';
                } else {
                    indicator.className = 'budget-status-indicator inactive';
                }
            }

            function updateBudgetCategoryList() {
                const container = document.getElementById('budgetCategoryList');
                if (!container) return;

                let html = '';

                if (appData.budgetSettings && appData.budgetSettings.categories) {
                    for (const [category, amount] of Object.entries(appData.budgetSettings.categories)) {
                        if (amount > 0) {
                            html += `
                            <div class="budget-category-item">
                                <div class="budget-category-info">
                                    <div class="budget-category-name">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                                    <div class="budget-category-amount">€${amount}</div>
                                </div>
                                <div class="budget-category-actions">
                                    <button class="budget-mini-btn" onclick="editBudgetCategory('${category}', ${amount})">
                                        ✏️
                                    </button>
                                    <button class="budget-mini-btn delete" onclick="deleteBudgetCategory('${category}')">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                        `;
                        }
                    }
                }

                if (html === '') {
                    html = '<div style="text-align: center; color: var(--text-secondary); padding: 20px; font-size: 14px;">Aucun budget configuré</div>';
                }

                container.innerHTML = html;
            }

            function updateAvailableCategories() {
                const select = document.getElementById('newBudgetCategory');
                if (!select) return;

                // Vider le select
                select.innerHTML = '<option value="">Choisir une catégorie</option>';

                // Obtenir les catégories déjà budgétisées
                const budgetedCategories = appData.budgetSettings && appData.budgetSettings.categories ?
                    Object.keys(appData.budgetSettings.categories).filter(cat => appData.budgetSettings.categories[cat] > 0) : [];

                // Ajouter les catégories disponibles
                appData.categories.forEach(category => {
                    if (!budgetedCategories.includes(category)) {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                        if (category === 'bitcoin') {
                            option.textContent = 'Bitcoin';
                        }
                        select.appendChild(option);
                    }
                });
            }

            function getCategoryIcon(transaction) {
                // 🔥 PRIORITÉ 1 : Si la transaction a un débiteur avec une photo, l'utiliser
                if (transaction.debtor && transaction.debtor.picture) {
                    return `<img src="${transaction.debtor.picture}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                }

                const category = transaction.category;
                const type = transaction.type;

                // Bitcoin reste en texte
                if (category === 'bitcoin' || transaction.isPureBitcoin || transaction.type === 'bitcoin_only') {
                    return '₿';
                }

                // 🔥 PRIORITÉ 2 : Vérifier si un emoji personnalisé existe pour cette catégorie
                if (appData.categoryEmojis && appData.categoryEmojis[category]) {
                    return appData.categoryEmojis[category];
                }

                // Emojis par défaut
                const emojiIcons = {
                    'alimentation': '🍽️',
                    'transport': '🚗',
                    'carburant': '⛽',
                    'crédit': '💳',
                    'loyer': '🏠',
                    'loisirs': '🎮',
                    'santé': '⚕️',
                    'shopping': '🛍️',
                    'investissement': '📈',
                    'remboursement': '💰',
                    'divers': type === 'income' ? '💰' : '📝'
                };

                return emojiIcons[category] || (type === 'income' ? '💰' : '📝');
            }

            function addCategoryBudget() {
                const categorySelect = document.getElementById('newBudgetCategory');
                const amountInput = document.getElementById('newBudgetAmount');

                if (!categorySelect || !amountInput) return;

                const category = categorySelect.value;
                const amount = parseInt(amountInput.value);

                if (!category) {
                    alert('Veuillez choisir une catégorie');
                    return;
                }

                if (!amount || amount <= 0) {
                    alert('Veuillez entrer un montant valide');
                    return;
                }

                // Initialiser budgetSettings si nécessaire
                if (!appData.budgetSettings) {
                    appData.budgetSettings = {
                        enabled: false,
                        global: 2500,
                        categories: {},
                        alerts: {threshold80: true, threshold100: true}
                    };
                }

                if (!appData.budgetSettings.categories) {
                    appData.budgetSettings.categories = {};
                }

                // Ajouter le budget
                appData.budgetSettings.categories[category] = amount;

                // Réinitialiser les champs
                categorySelect.value = '';
                amountInput.value = '';

                // Mettre à jour l'affichage
                updateBudgetCategoryList();
                updateAvailableCategories();

                showBudgetAlert(`Budget ${category} ajouté !`, 'success');
            }

            function editBudgetCategory(category, currentAmount) {
                const newAmount = prompt(`Nouveau budget pour ${category} :`, currentAmount);
                if (newAmount && !isNaN(newAmount) && parseInt(newAmount) > 0) {
                    appData.budgetSettings.categories[category] = parseInt(newAmount);
                    updateBudgetCategoryList();
                    showBudgetAlert(`Budget ${category} modifié !`, 'success');
                }
            }

            function deleteBudgetCategory(category) {
                if (confirm(`Supprimer le budget pour ${category} ?`)) {
                    if (appData.budgetSettings && appData.budgetSettings.categories) {
                        delete appData.budgetSettings.categories[category];
                    }
                    updateBudgetCategoryList();
                    updateAvailableCategories();
                    showBudgetAlert(`Budget ${category} supprimé !`, 'success');
                }
            }

            function showBudgetAlert(message, type = 'warning') {
                const alert = document.getElementById('budgetAlertNotification');
                if (!alert) return;

                alert.textContent = message;
                alert.className = `budget-alert-notification ${type}`;
                alert.classList.add('show');

                setTimeout(() => {
                    alert.classList.remove('show');
                }, 4000);
            }

            function checkBudgetThresholds() {
                if (!appData.budgetSettings || !appData.budgetSettings.enabled) return;

                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthExpenses = calculateMonthExpenses(currentMonth, currentYear);

                for (const [category, budgetAmount] of Object.entries(appData.budgetSettings.categories)) {
                    const spent = monthExpenses[category] || 0;
                    const percentage = (spent / budgetAmount) * 100;

                    if (percentage >= 100 && !sessionStorage.getItem(`alert_${category}_100`)) {
                        showBudgetAlert(`🚨 Budget ${category} dépassé !`, 'danger');
                        sessionStorage.setItem(`alert_${category}_100`, 'true');
                    } else if (percentage >= 80 && !sessionStorage.getItem(`alert_${category}_80`)) {
                        showBudgetAlert(`⚠️ 80% du budget ${category} atteint`, 'warning');
                        sessionStorage.setItem(`alert_${category}_80`, 'true');
                    }
                }
            }
            // Initialisation au chargement
            document.addEventListener('DOMContentLoaded', function () {
                loadData();
                verifyDataIntegrity();
                updateDisplay();
                setTodayDate();
                setupEventListeners();
                setupHeaderSwipe();
                loadCategories();
                displayCategories();
                priceManager.startAutomaticUpdates();
                displayRecentTransactions();
                updateAnalyticsDisplay();
                initSupabase();
                setupAuthEventListeners();
                loadSavedProfilePicture();

                setTimeout(() => {
                    document.querySelectorAll('.transaction-card').forEach((card, index) => {
                        setTimeout(() => {
                            card.style.animation = 'slideIn 0.6s ease forwards';
                        }, index * 100);
                    });
                }, 100);
            });

            // Variables pour Analytics
            let currentAnalyticsDate = new Date();

            // Fonction de recherche
            function searchTransactions(query) {
                // Toujours rediriger vers la page "tout afficher" dès qu'on tape dans la recherche
                if (document.querySelector('#dashboard.active')) {
                    showPage('all-transactions');
                }

                // Synchroniser les deux champs de recherche
                setTimeout(() => {
                    const allTransactionsInput = document.getElementById('allTransactionsSearchInput');
                    if (allTransactionsInput) {
                        allTransactionsInput.value = query;
                    }

                    // Appliquer le filtre
                    if (query.trim()) {
                        filterAllTransactions(query);
                    } else {
                        // Si recherche vide, afficher toutes les transactions
                        displayAllTransactionsPage();
                    }
                }, 100);
            }

            function handleSearchFocus() {
                // Rediriger vers all-transactions quand on clique sur la barre de recherche
                if (document.querySelector('#dashboard.active')) {
                    showPage('all-transactions');
                }
            }

            function handleMainSearchInput(query) {
                // S'assurer qu'on est sur la bonne page
                if (!document.querySelector('#all-transactions.active')) {
                    showPage('all-transactions');
                }

                // Synchroniser et filtrer
                setTimeout(() => {
                    syncSearchInputs('searchInput', query);
                }, 50);
            }

            function syncSearchInputs(sourceInputId, query) {
                // Synchroniser les deux champs de recherche
                const mainInput = document.getElementById('searchInput');
                const allTransactionsInput = document.getElementById('allTransactionsSearchInput');

                if (sourceInputId === 'searchInput' && allTransactionsInput) {
                    allTransactionsInput.value = query;
                } else if (sourceInputId === 'allTransactionsSearchInput' && mainInput) {
                    mainInput.value = query;
                }

                // Appliquer le filtre
                filterAllTransactions(query);
            }

            function showAllSearchResults(query) {
                const resultsContainer = document.getElementById('searchResults');

                // Refiltrer toutes les transactions
                const today = new Date();
                today.setHours(23, 59, 59, 999);

                const allFilteredTransactions = appData.transactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const searchText = query.toLowerCase();

                    return transactionDate <= today && (
                        transaction.name.toLowerCase().includes(searchText) ||
                        transaction.amount.toString().includes(searchText) ||
                        transaction.date.includes(searchText) ||
                        (transaction.category && transaction.category.toLowerCase().includes(searchText))
                    );
                })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                // Grouper par date
                const groupedTransactions = groupTransactionsByDate(allFilteredTransactions);

                let html = `
                <div class="search-overlay-full">
                    <div class="search-header-full">
                        <button class="back-arrow" onclick="backToSearchResults(\`${query.replace(/`/g, "\\`")}\`)">←</button>
                        <h3>Transactions</h3>
                    </div>
                    <div class="month-selector-sticky" id="monthSelector" style="display: none;">
                        <div class="month-pills">
                            <div class="month-pill active">Juin</div>
                            <div class="month-pill">Mai</div>
                            <div class="month-pill">Avril</div>
                            <div class="month-pill">Mars</div>
                            <div class="month-pill">Février</div>
                            <div class="month-pill">Janvier</div>
                        </div>
                    </div>
                    <div class="transactions-list" id="transactionsList" onscroll="handleTransactionsScroll()">
            `;

                Object.keys(groupedTransactions).forEach(dateGroup => {
                    html += `<div class="date-group-header">${dateGroup}</div>`;
                    groupedTransactions[dateGroup].forEach(transaction => {
                        html += generateTransactionHTML(transaction);
                    });
                });

                html += '</div></div>';
                resultsContainer.innerHTML = html;
            }

            function generateTransactionHTML(transaction) {
                const isBitcoin = transaction.category === 'bitcoin';
                const amountColor = transaction.type === 'income' ? 'var(--revolut-green)' : 'var(--text-primary)';

                const transactionDate = new Date(transaction.date);
                const timeDisplay = transactionDate.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});

                return `
                <div class="search-transaction-item" onclick="showTransactionDetails(${transaction.id})" style="cursor: pointer;">
                    <div class="search-transaction-icon ${transaction.type === 'income' ? 'income' : (isBitcoin ? 'bitcoin' : 'expense')}">
                        ${transaction.type === 'income' ? '+' : (isBitcoin ? '₿' : '-')}
                    </div>
                    <div class="search-transaction-details">
                        <div class="search-transaction-name">${transaction.name}</div>
                        <div class="search-transaction-meta">${timeDisplay}${transaction.category && transaction.category !== transaction.name ? ' • ' + transaction.category : ''}</div>
                    </div>
                    <div class="search-transaction-amount" style="color: ${amountColor};">
                        ${transaction.type === 'income' ? '+' : '-'}€${Math.abs(transaction.amount).toFixed(2)}
                    </div>
                </div>
            `;
            }

            function groupTransactionsByDate(transactions) {
                const grouped = {};
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                transactions.forEach(transaction => {
                    const transactionDate = new Date(transaction.date);
                    let dateKey;

                    if (transactionDate.toDateString() === today.toDateString()) {
                        dateKey = 'aujourd\'hui';
                    } else if (transactionDate.toDateString() === yesterday.toDateString()) {
                        dateKey = 'hier';
                    } else {
                        const day = transactionDate.getDate();
                        const month = transactionDate.toLocaleDateString('fr-FR', {month: 'long'});
                        dateKey = `${day} ${month}`;
                    }

                    if (!grouped[dateKey]) {
                        grouped[dateKey] = [];
                    }
                    grouped[dateKey].push(transaction);
                });

                return grouped;
            }

            function backToSearchResults(query) {
                // Retourner à la vue de recherche limitée
                searchTransactions(query);
                // Remettre la valeur dans le champ de recherche
                document.getElementById('searchInput').value = query;
            }

            function handleTransactionsScroll() {
                const transactionsList = document.getElementById('transactionsList');
                const monthSelector = document.getElementById('monthSelector');

                if (transactionsList.scrollTop > 100) {
                    monthSelector.style.display = 'block';
                } else {
                    monthSelector.style.display = 'none';
                }
            }

            function clearSearch() {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').style.display = 'none';
            }

            // Variable globale pour stocker l'ID de la transaction en cours de visualisation
            let currentViewingTransactionId = null;

            function showTransactionDetails(transactionId) {
                // Fermer les résultats de recherche si ouverts
                const searchResults = document.getElementById('searchResults');
                if (searchResults) {
                    searchResults.style.display = 'none';
                }

                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = '';
                }

                // Trouver la transaction
                const transaction = appData.transactions.find(t => t.id === transactionId);
                if (!transaction) return;

                // Stocker l'ID pour les actions (modifier/supprimer)
                currentViewingTransactionId = transactionId;

                // Remplir le nom
                const nameEl = document.getElementById('detailName');
                if (nameEl) {
                    nameEl.textContent = transaction.name;
                }

                // 🔥 AJOUT - Afficher la description si elle existe
                const descriptionDetail = document.getElementById('descriptionDetail');
                const descriptionEl = document.getElementById('detailDescription');
                if (transaction.description && descriptionDetail && descriptionEl) {
                    descriptionEl.textContent = transaction.description;
                    descriptionDetail.style.display = 'flex';
                } else if (descriptionDetail) {
                    descriptionDetail.style.display = 'none';
                }

                // Formater le montant avec le signe ET ajouter les classes de couleur
                const amountText = transaction.type === 'income' ?
                    `+€${transaction.amount.toFixed(2)}` :
                    `-€${Math.abs(transaction.amount).toFixed(2)}`;
                const amountEl = document.getElementById('detailAmount');
                if (amountEl) {
                    amountEl.textContent = amountText;
                    amountEl.className = transaction.type === 'income' ? 'positive' : 'negative';
                }

                // Type de transaction avec classe de couleur
                const typeEl = document.getElementById('detailType');
                if (typeEl) {
                    typeEl.textContent = transaction.type === 'income' ? 'Revenu' : 'Dépense';
                    typeEl.className = transaction.type === 'income' ? 'income' : 'expense';
                }

                // Catégorie
                const categoryEl = document.getElementById('detailCategory');
                if (categoryEl) {
                    const categoryText = transaction.category === 'bitcoin' ? 'Bitcoin' :
                        (transaction.category ? transaction.category.charAt(0).toUpperCase() + transaction.category.slice(1) : 'Sans catégorie');
                    categoryEl.textContent = categoryText;
                }

                // Date formatée
                const dateEl = document.getElementById('detailDate');
                if (dateEl) {
                    const transactionDate = new Date(transaction.date);
                    const formattedDate = transactionDate.toLocaleDateString('fr-FR', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    dateEl.textContent = formattedDate;
                }

                // Quantité Bitcoin (si applicable)
                const bitcoinDetail = document.getElementById('bitcoinQuantityDetail');
                const bitcoinQuantityEl = document.getElementById('detailBitcoinQuantity');
                if (transaction.category === 'bitcoin' && transaction.bitcoinQuantity && bitcoinDetail && bitcoinQuantityEl) {
                    bitcoinQuantityEl.textContent = `${transaction.bitcoinQuantity.toFixed(8)} BTC`;
                    bitcoinDetail.style.display = 'flex';
                } else if (bitcoinDetail) {
                    bitcoinDetail.style.display = 'none';
                }

                // Récurrence (si applicable)
                const recurringDetail = document.getElementById('recurringDetail');
                const recurringEl = document.getElementById('detailRecurring');
                if (transaction.recurring && recurringDetail && recurringEl) {
                    const frequencyText = {
                        'monthly': 'Mensuelle',
                        'weekly': 'Hebdomadaire',
                        'yearly': 'Annuelle'
                    }[transaction.frequency] || transaction.frequency;

                    recurringEl.textContent = `Oui (${frequencyText})`;
                    recurringDetail.style.display = 'flex';
                } else if (recurringDetail) {
                    recurringDetail.style.display = 'none';
                }

                // Afficher la modal
                showModal('transactionDetailsModal');

                // Adresse de départ (si présente)
                const fromAddressDetail = document.getElementById('fromAddressDetail');
                const fromAddressEl = document.getElementById('detailFromAddress');
                if (transaction.fromAddress && fromAddressDetail && fromAddressEl) {
                    fromAddressEl.textContent = transaction.fromAddress;
                    fromAddressDetail.style.display = 'flex';
                } else if (fromAddressDetail) {
                    fromAddressDetail.style.display = 'none';
                }

                // Adresse de destination (si présente)
                const toAddressDetail = document.getElementById('toAddressDetail');
                const toAddressEl = document.getElementById('detailToAddress');
                if (transaction.toAddress && toAddressDetail && toAddressEl) {
                    toAddressEl.textContent = transaction.toAddress;
                    toAddressDetail.style.display = 'flex';
                } else if (toAddressDetail) {
                    toAddressDetail.style.display = 'none';
                }

                // ID de transaction (si présent)
                const txIdDetail = document.getElementById('txIdDetail');
                const txIdEl = document.getElementById('detailTxId');
                if (transaction.transactionId && txIdDetail && txIdEl) {
                    txIdEl.textContent = transaction.transactionId;
                    txIdDetail.style.display = 'flex';
                } else if (txIdDetail) {
                    txIdDetail.style.display = 'none';
                }
            }

            // Fonction pour modifier depuis les détails
            function editTransactionFromDetails() {
                if (!currentViewingTransactionId) return;

                // Fermer la modal des détails
                hideModal('transactionDetailsModal');

                // Trouver la transaction
                const transaction = appData.transactions.find(t => t.id === currentViewingTransactionId);
                if (!transaction) return;

                // Vérifier si c'est une transaction Bitcoin pure
                if (transaction.isPureBitcoin || transaction.type === 'bitcoin_only') {
                    // Ouvrir la modal Bitcoin
                    openEditBitcoinTransactionModal(transaction);
                } else {
                    // Ouvrir la modal normale
                    openEditNormalTransactionModal(transaction);
                }
            }

            function openEditBitcoinTransactionModal(transaction) {
                // Remplir les champs avec les données de la transaction
                document.getElementById('editBitcoinTransactionType').value = transaction.bitcoinQuantity > 0 ? 'add' : 'remove';
                document.getElementById('editBitcoinTransactionQuantity').value = Math.abs(transaction.bitcoinQuantity);
                document.getElementById('editBitcoinTransactionDescription').value = transaction.name;
                document.getElementById('editBitcoinTransactionDate').value = transaction.date;

                // Remplir les champs optionnels
                document.getElementById('editBitcoinFromAddress').value = transaction.fromAddress || '';
                document.getElementById('editBitcoinToAddress').value = transaction.toAddress || '';
                document.getElementById('editBitcoinTxId').value = transaction.transactionId || '';

                // Stocker l'ID pour la sauvegarde
                window.editingBitcoinTransactionId = currentViewingTransactionId;

                showModal('editBitcoinTransactionModal');
            }

            function openEditNormalTransactionModal(transaction) {
                // Remplir le modal d'édition normal
                document.getElementById('transactionModalTitle').textContent = 'Modifier la transaction';
                document.getElementById('transactionName').value = transaction.name;
                document.getElementById('transactionDescription').value = transaction.description || '';
                document.getElementById('transactionAmount').value = transaction.amount;
                document.getElementById('transactionType').value = transaction.type;
                document.getElementById('transactionCategory').value = transaction.category || '';
                document.getElementById('transactionDate').value = transaction.date;
                document.getElementById('transactionRecurring').value = transaction.recurring ? 'yes' : 'no';

                if (transaction.category === 'bitcoin' && transaction.bitcoinQuantity) {
                    document.getElementById('bitcoinQuantity').value = Math.abs(transaction.bitcoinQuantity);
                    toggleBitcoinQuantity();
                }

                if (transaction.recurring) {
                    document.getElementById('recurringFrequency').value = transaction.frequency || 'monthly';
                    document.getElementById('recurringStartDate').value = transaction.startDate || '';
                    document.getElementById('recurringEndDate').value = transaction.endDate || '';
                    toggleRecurringOptions();
                }

                // Configurer pour l'édition
                window.editingTransactionId = currentViewingTransactionId;

                const submitBtn = document.querySelector('#transactionForm button[type="submit"]');
                submitBtn.textContent = 'Modifier';
                submitBtn.style.background = 'var(--revolut-orange)';

                showModal('transactionModal');
            }

            function saveBitcoinTransactionEdit() {
                const transactionId = window.editingBitcoinTransactionId;
                if (!transactionId) return;

                const transaction = appData.transactions.find(t => t.id === transactionId);
                if (!transaction) return;

                const type = document.getElementById('editBitcoinTransactionType').value;
                const quantity = parseFloat(document.getElementById('editBitcoinTransactionQuantity').value);
                const description = document.getElementById('editBitcoinTransactionDescription').value;
                const date = document.getElementById('editBitcoinTransactionDate').value;

                const fromAddress = document.getElementById('editBitcoinFromAddress').value.trim();
                const toAddress = document.getElementById('editBitcoinToAddress').value.trim();
                const txId = document.getElementById('editBitcoinTxId').value.trim();

                if (!quantity || quantity <= 0) {
                    alert('Veuillez entrer une quantité valide');
                    return;
                }

                if (!description.trim()) {
                    alert('Veuillez entrer une description');
                    return;
                }

                // Mettre à jour la transaction
                const bitcoinQuantityToAdd = type === 'add' ? quantity : -quantity;

                transaction.name = description;
                transaction.bitcoinQuantity = bitcoinQuantityToAdd;
                transaction.date = date;
                transaction.fromAddress = fromAddress || null;
                transaction.toAddress = toAddress || null;
                transaction.transactionId = txId || null;

                // Sauvegarder et mettre à jour
                saveData();
                updateBitcoinAssetFromTransactions();
                if (document.querySelector('#bitcoin.active')) {
                    displayBitcoinPage();
                }
                updateDisplay();

                // Fermer la modal et nettoyer
                hideModal('editBitcoinTransactionModal');
                window.editingBitcoinTransactionId = null;
            }

            function deleteBitcoinTransactionFromEdit() {
                const transactionId = window.editingBitcoinTransactionId;
                if (!transactionId) return;

                const transaction = appData.transactions.find(t => t.id === transactionId);
                if (!transaction) return;

                if (confirm(`Êtes-vous sûr de vouloir supprimer cette transaction Bitcoin "${transaction.name}" ?`)) {
                    // Supprimer la transaction
                    appData.transactions = appData.transactions.filter(t => t.id !== transactionId);

                    // Sauvegarder et mettre à jour
                    saveData();
                    updateBitcoinAssetFromTransactions();
                    if (document.querySelector('#bitcoin.active')) {
                        displayBitcoinPage();
                    }
                    updateDisplay();

                    // Fermer la modal et nettoyer
                    hideModal('editBitcoinTransactionModal');
                    window.editingBitcoinTransactionId = null;
                    currentViewingTransactionId = null;
                }
            }

            // Fonction pour supprimer depuis les détails
            function deleteTransactionFromDetails() {
                if (!currentViewingTransactionId) return;

                const transaction = appData.transactions.find(t => t.id === currentViewingTransactionId);
                if (!transaction) return;

                if (confirm(`Êtes-vous sûr de vouloir supprimer la transaction "${transaction.name}" ?`)) {
                    // Supprimer la transaction
                    appData.transactions = appData.transactions.filter(t => t.id !== currentViewingTransactionId);

                    // Sauvegarder et mettre à jour
                    saveData();
                    updateDisplay();
                    displayRecentTransactions();

                    // Mettre à jour les affichages spécifiques
                    if (transaction.category === 'bitcoin') {
                        displayBitcoinSummary();
                        if (document.querySelector('#bitcoin.active')) {
                            displayBitcoinPage();
                        }
                    }

                    // Régénérer le calendrier si on est sur cette page
                    if (document.querySelector('#calendar.active')) {
                        generateCalendar();
                    }

                    // Mettre à jour analytics
                    updateAnalyticsDisplay();

                    // Fermer la modal
                    hideModal('transactionDetailsModal');
                    currentViewingTransactionId = null;

                    // Si on était dans les détails d'une date spécifique, actualiser
                    if (window.selectedDateForTransaction) {
                        selectDate(window.selectedDateForTransaction);
                    }
                }
            }

            function resetTransactionModal() {
                document.getElementById('transactionModalTitle').textContent = 'Nouvelle Transaction';
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionDescription').value = '';
                setTodayDate();

                const submitBtn = document.querySelector('#transactionForm button[type="submit"]');
                submitBtn.textContent = 'Ajouter';
                submitBtn.style.background = 'var(--revolut-blue)';

                window.editingTransactionId = null;
            }

            // Fonctions Analytics
            function changeAnalyticsMonth(direction) {
                currentAnalyticsDate.setMonth(currentAnalyticsDate.getMonth() + direction);
                updateAnalyticsDisplay();
            }

            function updateAnalyticsDisplay() {
                const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                    'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

                const currentMonth = currentAnalyticsDate.getMonth();
                const currentYear = currentAnalyticsDate.getFullYear();

                document.getElementById('currentAnalyticsMonth').textContent =
                    `${monthNames[currentMonth]} ${currentYear}`;

                // Filtrer les transactions du mois
                const monthTransactions = appData.transactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    return transactionDate.getMonth() === currentMonth &&
                        transactionDate.getFullYear() === currentYear;
                });

                // Calculer les revenus, dépenses et Bitcoin stacké
                let totalIncome = 0;
                let totalExpenses = 0;
                let bitcoinStacked = 0;
                const expensesByCategory = {};

                monthTransactions.forEach(transaction => {
                    if (transaction.type === 'income') {
                        totalIncome += transaction.amount;
                    } else {
                        totalExpenses += transaction.amount;
                        const category = transaction.category || 'Divers';
                        expensesByCategory[category] = (expensesByCategory[category] || 0) + transaction.amount;

                        // Calculer le Bitcoin stacké
                        if (transaction.category === 'bitcoin' && transaction.bitcoinQuantity) {
                            bitcoinStacked += transaction.bitcoinQuantity;
                        }
                    }
                });

                // Calculer et afficher la variation du solde
                const balanceVariation = totalIncome - totalExpenses;
                updateBalanceVariationDisplay(balanceVariation, totalIncome, totalExpenses);

                // Afficher le Bitcoin stacké
                updateBitcoinStackedDisplay(bitcoinStacked);

                // Générer le graphique moderne
                generateAnalytics3DChart(monthTransactions);

                // Mettre à jour la liste des transactions
                updateMonthlyTransactionsList(monthTransactions);
            }

            // Fonction pour mettre à jour l'affichage du Bitcoin stacké
            function updateBitcoinStackedDisplay(bitcoinStacked) {
                const amountEl = document.getElementById('bitcoinStackedAmount');
                const valueEl = document.getElementById('bitcoinStackedValue');

                // Afficher la quantité
                amountEl.textContent = `${bitcoinStacked.toFixed(8)} BTC`;

                // Calculer et afficher la valeur en euros
                const btcPriceData = priceManager.getCachedPrice('BTC');
                const currentBtcPrice = btcPriceData ? btcPriceData.price : 0;
                const bitcoinValue = bitcoinStacked * currentBtcPrice;

                valueEl.textContent = `€${bitcoinValue.toFixed(0)}`;

                // Masquer la carte si pas de Bitcoin stacké
                const cardEl = document.getElementById('bitcoinStackedCard');
                if (bitcoinStacked === 0) {
                    cardEl.style.opacity = '0.5';
                    amountEl.textContent = '0 BTC';
                    valueEl.textContent = '€0 | 0,00000000 BTC';
                } else {
                    cardEl.style.opacity = '1';
                }
            }

            // Fonction pour mettre à jour l'indicateur de variation du solde
            function updateBalanceVariationDisplay(variation, income, expenses) {
                const variationEl = document.getElementById('balanceVariation');
                const breakdownEl = document.getElementById('variationBreakdown');
                const cardEl = document.getElementById('balanceVariationCard');

                // Formater l'affichage
                const sign = variation >= 0 ? '+' : '';
                variationEl.textContent = `${sign}€${variation.toFixed(0)}`;

                // Appliquer les classes de couleur
                variationEl.className = 'variation-amount ' +
                    (variation > 0 ? 'positive' : variation < 0 ? 'negative' : 'neutral');

                // Mettre à jour la répartition
                breakdownEl.innerHTML = `
                <span class="income-part">+€${income.toFixed(0)} revenus</span>
                <span class="expense-part">-€${expenses.toFixed(0)} dépenses</span>
            `;

                // Ajouter un effet de bordure selon la variation
                if (variation > 0) {
                    cardEl.style.borderColor = 'rgba(48, 209, 88, 0.3)';
                } else if (variation < 0) {
                    cardEl.style.borderColor = 'rgba(255, 59, 48, 0.3)';
                } else {
                    cardEl.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                }
            }

            // Fonction pour générer le graphique 3D Analytics (identique au calendrier)
            function generateAnalytics3DChart(monthTransactions) {
                const chartContainer = document.getElementById('analyticsChart3D');
                const legendContainer = document.getElementById('analyticsChartLegend');

                if (!chartContainer || !legendContainer) return;

                // Calculer les dépenses par catégorie
                const expensesByCategory = {};
                let totalExpenses = 0;

                monthTransactions.forEach(transaction => {
                    if (transaction.type === 'expense') {
                        const category = transaction.category || 'Divers';
                        expensesByCategory[category] = (expensesByCategory[category] || 0) + transaction.amount;
                        totalExpenses += transaction.amount;
                    }
                });

                if (totalExpenses === 0) {
                    renderEmptyAnalyticsChartState(chartContainer, legendContainer);
                    return;
                }

                // Couleurs modernes
                const colors = [
                    '#6366f1', '#ec4899', '#f97316', '#10b981',
                    '#f59e0b', '#8b5cf6', '#06b6d4', '#ef4444'
                ];

                // Trier les catégories par montant
                const sortedCategories = Object.entries(expensesByCategory)
                    .sort(([, a], [, b]) => b - a);

                // Remplacer le contenu du conteneur par le nouveau graphique
                chartContainer.className = 'chart-container-modern';
                chartContainer.innerHTML = `
                <div class="chart-header-modern">
                    <div class="chart-title-modern">Répartition des Dépenses</div>
                    <div class="chart-subtitle-modern">Analyse des catégories du mois</div>
                </div>
                <div class="chart-donut-wrapper">
                    <svg class="chart-donut" viewBox="0 0 200 200" id="analyticsChartSvg">
                    </svg>
                    <div class="chart-center-modern">
                        <div class="chart-total-modern">€${totalExpenses.toLocaleString()}</div>
                        <div class="chart-label-modern">Total</div>
                    </div>
                </div>
            `;

                // Générer le graphique SVG
                renderAnalyticsDonutChart(sortedCategories, totalExpenses, colors);

                // Générer la légende moderne
                renderAnalyticsLegend(sortedCategories, totalExpenses, colors, legendContainer);

                // Créer le tooltip s'il n'existe pas
                createModernTooltip();
            }

            // Rendre le graphique donut Analytics
            function renderAnalyticsDonutChart(sortedCategories, totalExpenses, colors) {
                const svg = document.getElementById('analyticsChartSvg');
                if (!svg) return;

                let currentAngle = 0;

                sortedCategories.forEach(([category, amount], index) => {
                    const percentage = (amount / totalExpenses) * 100;
                    const angle = (amount / totalExpenses) * 360;
                    const color = colors[index % colors.length];

                    // Créer le segment SVG
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const pathData = createDonutSegment(currentAngle, currentAngle + angle);

                    path.setAttribute('d', pathData);
                    path.setAttribute('stroke', color);
                    path.setAttribute('class', 'chart-segment-modern');
                    path.style.setProperty('--dash-array', (angle / 360) * 628);

                    // Ajouter les événements pour le tooltip
                    path.addEventListener('mouseenter', (e) => {
                        showModernTooltip(e, category, amount, percentage.toFixed(1));
                    });

                    path.addEventListener('mouseleave', hideModernTooltip);

                    path.addEventListener('mousemove', (e) => {
                        updateModernTooltipPosition(e);
                    });

                    svg.appendChild(path);
                    currentAngle += angle;
                });
            }

            // Rendre la légende Analytics
            function renderAnalyticsLegend(sortedCategories, totalExpenses, colors, container) {
                container.className = 'chart-legend-modern';

                const legendHTML = sortedCategories.map(([category, amount], index) => {
                    const percentage = (amount / totalExpenses) * 100;
                    const color = colors[index % colors.length];

                    return `
                    <div class="legend-item-modern" style="animation-delay: ${index * 0.1}s">
                        <div class="legend-color-modern" style="background: ${color}"></div>
                        <div class="legend-details-modern">
                            <div class="legend-name-modern">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                            <div class="legend-amount-modern">€${amount.toLocaleString()}</div>
                        </div>
                        <div class="legend-percentage-modern">${percentage.toFixed(1)}%</div>
                    </div>
                `;
                }).join('');

                container.innerHTML = legendHTML;
            }

            // État vide pour le graphique Analytics
            function renderEmptyAnalyticsChartState(chartContainer, legendContainer) {
                chartContainer.className = 'chart-container-modern';
                chartContainer.innerHTML = `
                <div class="chart-header-modern">
                    <div class="chart-title-modern">Répartition des Dépenses</div>
                    <div class="chart-subtitle-modern">Analyse des catégories du mois</div>
                </div>
                <div class="chart-empty-modern">
                    <svg class="chart-empty-icon-modern" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <div class="chart-empty-text-modern">Aucune donnée</div>
                    <div class="chart-empty-subtext-modern">Aucune dépense ce mois</div>
                </div>
            `;

                legendContainer.innerHTML = '';
            }

            function updateMonthlyTransactionsList(transactions) {
                const container = document.getElementById('monthlyTransactionsList');

                if (transactions.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune transaction ce mois</div>';
                    return;
                }

                let html = '';
                transactions
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .forEach(transaction => {
                        const isBitcoin = transaction.category === 'bitcoin';
                        const iconType = transaction.type === 'income' ? 'income' : (isBitcoin ? 'bitcoin' : 'expense');
                        const icon = getCategoryIcon(transaction);
                        const amountColor = transaction.type === 'income' ? 'var(--revolut-green)' : 'var(--text-primary)';

                        html += `
                        <div class="transaction-item" onclick="showTransactionDetails(${transaction.id})" style="cursor: pointer;">
                            <div class="transaction-icon ${iconType}">${icon}</div>
                            <div class="transaction-details">
                                <div class="transaction-name">${transaction.name}</div>
                                <div class="transaction-meta">${transaction.date} • ${transaction.category || 'Sans catégorie'}</div>
                            </div>
                            <div class="transaction-amount" style="color: ${amountColor};">
                                ${transaction.type === 'income' ? '+' : '-'}€${Math.abs(transaction.amount).toFixed(2)}
                            </div>
                        </div>
                    `;
                    });

                container.innerHTML = html;
            }

            function highlightTransaction(transactionId) {
                // Cette fonction est appelée par les fonctions globales mais n'existe pas
                // On peut la rediriger vers showTransactionDetails
                showTransactionDetails(transactionId);
            }

            // Fermer les résultats de recherche en cliquant ailleurs
            document.addEventListener('click', function (event) {
                const searchContainer = event.target.closest('.search-container');
                if (!searchContainer) {
                    document.getElementById('searchResults').style.display = 'none';
                }
            });

            // Configuration Supabase
            const SUPABASE_URL = 'https://wadoopwvafhxwysuvkvl.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhZG9vcHd2YWZoeHd5c3V2a3ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0Njc4MTcsImV4cCI6MjA4MzA0MzgxN30.fQdJPcFJwzustHPSBXdj2Wliz7COyD9nXth_QNouytc';

            let supabase = null;
            let currentUser = null;
            let realtimeChannel = null; // 🔥 NOUVEAU

            function initSupabase() {
                if (typeof window.supabase === 'undefined') {
                    console.error('❌ SDK Supabase non chargé');
                    return;
                }

                try {
                    console.log('🔄 Initialisation Supabase...');
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('✅ Supabase initialisé');

                    supabase.auth.getSession().then(({data: {session}}) => {
                        if (session) {
                            currentUser = session.user;
                            updateUIForAuthenticatedUser(session.user);
                            subscribeToRealtimeUpdates(); // 🔥 NOUVEAU
                        }
                    });

                    supabase.auth.onAuthStateChange((event, session) => {
                        console.log('Auth event:', event);

                        if (event === 'SIGNED_IN' && session) {
                            currentUser = session.user;
                            updateUIForAuthenticatedUser(session.user);
                            subscribeToRealtimeUpdates(); // 🔥 NOUVEAU
                        } else if (event === 'SIGNED_OUT') {
                            currentUser = null;
                            unsubscribeFromRealtimeUpdates(); // 🔥 NOUVEAU
                            document.getElementById('authButtons').style.display = 'flex';
                            document.getElementById('userActions').style.display = 'none';
                            document.getElementById('profileButton').classList.remove('connected');
                        }
                    });

                } catch (error) {
                    console.error('❌ Erreur initialisation Supabase:', error);
                }
            }

            // 🔥 NOUVEAU : Abonnement Realtime
            function subscribeToRealtimeUpdates() {
                if (!supabase || !currentUser) {
                    console.log('⚠️ Impossible de démarrer Realtime : pas de session');
                    return;
                }

                if (realtimeChannel) {
                    console.log('✅ Déjà abonné au Realtime');
                    return;
                }

                console.log('🔄 Abonnement aux mises à jour Realtime...');

                realtimeChannel = supabase
                    .channel('user_data_changes')
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'user_data',
                            filter: `user_id=eq.${currentUser.id}`
                        },
                        (payload) => {
                            console.log('🔔 Mise à jour Realtime reçue:', payload);
                            handleRealtimeUpdate(payload);
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('✅ Abonné au Realtime avec succès');
                            showRealtimeNotification('🔄 Synchronisation en temps réel activée');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('❌ Erreur d\'abonnement Realtime');
                        } else if (status === 'TIMED_OUT') {
                            console.warn('⚠️ Timeout de l\'abonnement Realtime');
                        }
                    });
            }

            // 🔥 NOUVEAU : Désabonnement Realtime
            function unsubscribeFromRealtimeUpdates() {
                if (realtimeChannel) {
                    console.log('🔄 Désabonnement du Realtime...');
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                    console.log('✅ Désabonné du Realtime');
                }
            }

            // 🔥 NOUVEAU : Gérer les mises à jour Realtime
            async function handleRealtimeUpdate(payload) {
                const {eventType, new: newRecord} = payload;

                console.log('📦 Type d\'événement:', eventType);

                const lastSyncTime = sessionStorage.getItem('lastSyncTime');
                const timeSinceLastSync = Date.now() - parseInt(lastSyncTime || '0');

                if (timeSinceLastSync < 2000) {
                    console.log('⏭️ Mise à jour ignorée (sync récente depuis cet appareil)');
                    return;
                }

                switch (eventType) {
                    case 'INSERT':
                    case 'UPDATE':
                        if (newRecord && newRecord.data) {
                            console.log('🔄 Application des nouvelles données...');

                            appData = {
                                transactions: newRecord.data.transactions || [],
                                assets: newRecord.data.assets || [],
                                fireGoals: newRecord.data.fireGoals || [],
                                debtors: newRecord.data.debtors || [],
                                categories: newRecord.data.categories || ['Bitcoin', 'Alimentation', 'Transport', 'Carburant', 'Crédit', 'Loyer', 'Loisirs', 'Santé', 'Shopping', 'Divers', 'Investissement', 'Remboursement'],
                                categoryEmojis: newRecord.data.categoryEmojis || {},
                                settings: newRecord.data.settings || {currentBalance: 0},
                                budgetSettings: newRecord.data.budgetSettings || {
                                    enabled: false,
                                    global: 2500,
                                    categories: {},
                                    alerts: {threshold80: true, threshold100: true}
                                },
                                budgetAlerts: newRecord.data.budgetAlerts || {}
                            };

                            saveData();
                            updateDisplay();
                            loadCategories();
                            displayRecentTransactions();

                            showRealtimeNotification('✅ Données synchronisées depuis un autre appareil');

                            console.log('✅ Données mises à jour depuis Realtime');
                        }
                        break;

                    case 'DELETE':
                        console.log('🗑️ Données supprimées sur le serveur');
                        showRealtimeNotification('⚠️ Données supprimées depuis un autre appareil');
                        break;
                }
            }

            // 🔥 NOUVEAU : Afficher notification
            function showRealtimeNotification(message) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.85);
                    backdrop-filter: blur(10px);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 20px;
                    font-size: 13px;
                    font-weight: 400;
                    z-index: 10000;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    animation: slideDown 0.3s ease-out;
                    pointer-events: none;
                `;
                notification.textContent = message;

                if (!document.getElementById('realtime-notification-style')) {
                    const style = document.createElement('style');
                    style.id = 'realtime-notification-style';
                    style.textContent = `
                        @keyframes slideDown {
                            from {
                                opacity: 0;
                                transform: translateX(-50%) translateY(-20px);
                            }
                            to {
                                opacity: 1;
                                transform: translateX(-50%) translateY(0);
                            }
                        }
                        @keyframes slideUp {
                            from {
                                opacity: 1;
                                transform: translateX(-50%) translateY(0);
                            }
                            to {
                                opacity: 0;
                                transform: translateX(-50%) translateY(-20px);
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideUp 0.3s ease-out';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }

            async function login(email, password) {
                if (!supabase) return;

                try {
                    const {data, error} = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) throw error;

                    currentUser = data.user;
                    updateUIForAuthenticatedUser(data.user);
                    hideModal('loginModal');

                } catch (error) {
                    alert('Erreur de connexion: ' + error.message);
                }
            }

            async function register(email, password, name) {
                if (!supabase) return;

                try {
                    const {data, error} = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                name: name
                            }
                        }
                    });

                    if (error) throw error;

                    alert('Compte créé ! Vérifiez votre email pour confirmer.');
                    hideModal('registerModal');

                } catch (error) {
                    alert('Erreur inscription: ' + error.message);
                }
            }

            async function logout() {
                if (!supabase) return;

                try {
                    await supabase.auth.signOut();
                    currentUser = null;
                    updateUIForUnauthenticatedUser();
                    hideModal('profileModal');
                } catch (error) {
                    console.error('Erreur déconnexion:', error);
                }
            }

            function updateUIForAuthenticatedUser(user) {
                document.getElementById('userName').textContent = user.user_metadata?.name || user.email;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('authButtons').style.display = 'none';
                document.getElementById('userActions').style.display = 'block';
                document.getElementById('profileButton').classList.add('connected');

                const hasLocalData = appData.transactions.length > 0 || appData.assets.length > 0;

                loadDataFromSupabase(!hasLocalData).then(dataLoaded => {
                    if (!dataLoaded && hasLocalData) {
                        syncDataSilently();
                        console.log('📤 Première connexion : données locales envoyées au serveur');
                    }
                });
            }

            function updateUIForUnauthenticatedUser() {
                document.getElementById('userName').textContent = 'Utilisateur';
                document.getElementById('userEmail').textContent = 'Non connecté';
                document.getElementById('authButtons').style.display = 'block';
                document.getElementById('userActions').style.display = 'none';
                document.getElementById('profileButton').classList.remove('connected');
            }

            // Gestion photo de profil
            function uploadProfilePicture() {
                document.getElementById('profilePictureInput').click();
            }

            async function handleProfilePictureUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        // 🔥 Compresser l'image
                        const compressedImage = await compressImage(e.target.result, 200, 0.6);

                        // Mettre à jour les images
                        document.getElementById('profilePicture').src = compressedImage;
                        document.getElementById('profilePicture').style.display = 'block';
                        document.getElementById('profileIcon').style.display = 'none';

                        document.getElementById('profilePictureLarge').src = compressedImage;
                        document.getElementById('profilePictureLarge').style.display = 'block';
                        document.getElementById('profileIconLarge').style.display = 'none';

                        // Sauvegarder en local
                        localStorage.setItem('profilePicture', compressedImage);

                        console.log('✅ Photo de profil compressée:',
                            Math.round(compressedImage.length / 1024) + 'KB');
                    } catch (error) {
                        console.error('❌ Erreur compression photo profil:', error);
                    }
                };
                reader.readAsDataURL(file);
            }

            // Synchroniser les données avec Supabase
            async function syncData() {
                if (!supabase || !currentUser) {
                    alert('Vous devez être connecté pour synchroniser');
                    return;
                }

                try {
                    // 1. D'abord récupérer les données serveur
                    const {data: serverData, error: fetchError} = await supabase
                        .from('user_data')
                        .select('data, updated_at')
                        .eq('user_id', currentUser.id)
                        .single();

                    let shouldUpload = true;

                    if (serverData && !fetchError) {
                        const serverDate = new Date(serverData.updated_at);
                        const localDate = new Date(localStorage.getItem('lastSaved') || 0);

                        if (serverDate > localDate) {
                            const useServer = confirm(
                                'Les données du serveur sont plus récentes. Voulez-vous les charger ?\n' +
                                'Sinon, vos données locales écraseront celles du serveur.'
                            );

                            if (useServer) {
                                appData = serverData.data;
                                saveData();
                                updateDisplay();
                                shouldUpload = false;
                                alert('Données du serveur chargées !');
                            }
                        }
                    }

                    // 2. Ensuite envoyer les données locales si nécessaire
                    if (shouldUpload) {
                        const {error: uploadError} = await supabase
                            .from('user_data')
                            .upsert({
                                user_id: currentUser.id,
                                data: appData,
                                updated_at: new Date().toISOString()
                            });

                        if (uploadError) throw uploadError;

                        localStorage.setItem('lastSaved', new Date().toISOString());
                        alert('Données sauvegardées sur le serveur !');
                    }

                } catch (error) {
                    console.error('Erreur synchronisation:', error);
                    alert('Erreur lors de la synchronisation: ' + error.message);
                }
            }

            // Event listeners pour les formulaires - NOUVELLE VERSION
            function setupAuthEventListeners() {
                // Connexion
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        const email = document.getElementById('loginEmail').value;
                        const password = document.getElementById('loginPassword').value;

                        if (email && password) {
                            login(email, password);
                        } else {
                            alert('Veuillez remplir tous les champs');
                        }
                    });
                }

                // Inscription  
                const registerForm = document.getElementById('registerForm');
                if (registerForm) {
                    registerForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        const name = document.getElementById('registerName').value;
                        const email = document.getElementById('registerEmail').value;
                        const password = document.getElementById('registerPassword').value;

                        if (name && email && password) {
                            register(email, password, name);
                        } else {
                            alert('Veuillez remplir tous les champs');
                        }
                    });
                }
            }

            // Charger la photo de profil sauvegardée
            function loadSavedProfilePicture() {
                const savedPicture = localStorage.getItem('profilePicture');
                if (savedPicture) {
                    document.getElementById('profilePicture').src = savedPicture;
                    document.getElementById('profilePicture').style.display = 'block';
                    document.getElementById('profileIcon').style.display = 'none';

                    document.getElementById('profilePictureLarge').src = savedPicture;
                    document.getElementById('profilePictureLarge').style.display = 'block';
                    document.getElementById('profileIconLarge').style.display = 'none';
                }
            }

            // Récupérer les données depuis Supabase
            async function loadDataFromSupabase(forceLoad = false) {
                if (!supabase || !currentUser) return false;

                try {
                    const {data, error} = await supabase
                        .from('user_data')
                        .select('data')
                        .eq('user_id', currentUser.id)
                        .single();

                    if (error && error.code !== 'PGRST116') {
                        throw error;
                    }

                    if (data && data.data) {
                        const hasLocalData = appData.transactions.length > 0 || appData.assets.length > 0;
                        let shouldReplace = forceLoad;

                        if (!forceLoad && hasLocalData) {
                            shouldReplace = confirm(
                                'Des données ont été trouvées sur le serveur. Voulez-vous les charger ?\n' +
                                '(Cela remplacera vos données locales actuelles)'
                            );
                        }

                        if (shouldReplace || !hasLocalData) {
                            appData = {
                                transactions: data.data.transactions || [],
                                assets: data.data.assets || [],
                                fireGoals: data.data.fireGoals || [],
                                debtors: data.data.debtors || [], // 🔥 Important pour les débiteurs
                                categories: data.data.categories || ['Bitcoin', 'Alimentation', 'Transport','Carburant', 'Crédit', 'Loyer', 'Loisirs', 'Santé', 'Shopping', 'Divers', 'Investissement', 'Remboursement'],
                                categoryEmojis: data.data.categoryEmojis || {},
                                settings: data.data.settings || {currentBalance: 0},
                                budgetSettings: data.data.budgetSettings || {
                                    enabled: false,
                                    global: 2500,
                                    categories: {},
                                    alerts: { threshold80: true, threshold100: true }
                                },
                                budgetAlerts: data.data.budgetAlerts || {}
                            };

                            saveData();
                            updateDisplay();
                            loadCategories();
                            displayRecentTransactions();

                            console.log('✅ Données synchronisées depuis le serveur');
                            return true; // 🔥 On indique qu'on a chargé des données
                        }
                    }
                    return false; // 🔥 Pas de données chargées
                } catch (error) {
                    console.error('Erreur chargement données:', error);
                    return false;
                }
            }



            // Fonctions pour le menu profil
            function toggleProfileMenu() {
                const menu = document.getElementById('profileMenu');
                const isActive = menu.classList.contains('active');

                if (isActive) {
                    hideProfileMenu();
                } else {
                    showProfileMenu();
                }
            }

            // Fonction pour afficher/masquer les options d'authentification
            function showAuthOptions() {
                const subMenu = document.getElementById('authSubMenu');
                const isVisible = subMenu.style.display === 'block';

                if (isVisible) {
                    subMenu.style.display = 'none';
                } else {
                    subMenu.style.display = 'block';
                }
            }

            // Masquer le sous-menu quand on clique sur une option
            function openLoginFromMenu() {
                document.getElementById('authSubMenu').style.display = 'none';
                hideProfileMenu();
                showModal('loginModal');
            }

            function openRegisterFromMenu() {
                document.getElementById('authSubMenu').style.display = 'none';
                hideProfileMenu();
                showModal('registerModal');
            }

            function showProfileMenu() {
                const menu = document.getElementById('profileMenu');
                menu.classList.add('active');

                // Bloquer le scroll
                document.body.classList.add('modal-open');

                // Mettre à jour les infos utilisateur
                updateProfileMenuInfo();
            }

            function hideProfileMenu() {
                const menu = document.getElementById('profileMenu');
                menu.classList.remove('active');

                // Débloquer le scroll
                document.body.classList.remove('modal-open');
            }

            function updateProfileMenuInfo() {
                const nameEl = document.getElementById('profileMenuName');
                const emailEl = document.getElementById('profileMenuEmail');
                const pictureEl = document.getElementById('profileMenuPicture');
                const iconEl = document.getElementById('profileMenuIcon');
                const authSection = document.getElementById('authSection');
                const userSection = document.getElementById('userSection');

                if (currentUser) {
                    // Utilisateur connecté
                    nameEl.textContent = currentUser.user_metadata?.name || currentUser.email;
                    emailEl.textContent = currentUser.email;
                    authSection.style.display = 'none';
                    userSection.style.display = 'block';
                } else {
                    // Utilisateur non connecté
                    nameEl.textContent = 'Utilisateur';
                    emailEl.textContent = 'Non connecté';
                    authSection.style.display = 'block';
                    userSection.style.display = 'none';
                }

                // Photo de profil
                const savedPicture = localStorage.getItem('profilePicture');
                if (savedPicture) {
                    pictureEl.src = savedPicture;
                    pictureEl.style.display = 'block';
                    iconEl.style.display = 'none';
                } else {
                    pictureEl.style.display = 'none';
                    iconEl.style.display = 'block';
                }
            }

            // Fonctions pour les actions du menu
            function openProfileSettings() {
                hideProfileMenu();
                showModal('profileModal');
            }

            function openCategoriesPage() {
                hideProfileMenu();
                showPage('settings');
            }

            function openLoginFromMenu() {
                hideProfileMenu();
                showModal('loginModal');
            }

            function openRegisterFromMenu() {
                hideProfileMenu();
                showModal('registerModal');
            }

            function syncDataFromMenu() {
                hideProfileMenu();
                syncData();
            }

            function logoutFromMenu() {
                hideProfileMenu();
                logout();
            }

            // Fonction pour ouvrir la page de gestion des données
            function openDataManagementPage() {
                hideProfileMenu();
                showPage('data-management');
            }

            // Fonction pour ouvrir la page des catégories (renommée pour clarté)
            function openCategoriesPage() {
                hideProfileMenu();
                showPage('settings');
            }

            // Fermer le menu en cliquant à l'extérieur
            document.addEventListener('click', function (event) {
                const menu = document.getElementById('profileMenu');
                const profileButton = document.getElementById('profileButton');
                const menuContainer = document.querySelector('.profile-menu-container');

                if (menu && menu.classList.contains('active')) {
                    // Si on clique sur le fond noir (pas sur le conteneur du menu) ou pas sur le bouton profil
                    if (event.target === menu || (!menuContainer.contains(event.target) && !profileButton.contains(event.target))) {
                        hideProfileMenu();
                    }
                }
            });





        </script>

        <!-- Modal Détails Transaction -->
        <div id="transactionDetailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="transactionDetailsTitle">Détails de la transaction</h3>
                    <span class="close" onclick="hideModal('transactionDetailsModal')">&times;</span>
                </div>

                <div id="transactionDetailsContent">
                    <div class="transaction-detail-item">
                        <strong>Nom :</strong>
                        <span id="detailName"></span>
                    </div>

                    <div class="transaction-detail-item" id="descriptionDetail" style="display: none;">
                        <strong>Description :</strong>
                        <span id="detailDescription"
                            style="font-size: 14px; opacity: 0.9; display: block; margin-top: 4px; line-height: 1.5;"></span>
                    </div>

                    <div class="transaction-detail-item">
                        <strong>Montant :</strong>
                        <span id="detailAmount"></span>
                    </div>

                    <div class="transaction-detail-item">
                        <strong>Type :</strong>
                        <span id="detailType"></span>
                    </div>

                    <div class="transaction-detail-item">
                        <strong>Catégorie :</strong>
                        <span id="detailCategory"></span>
                    </div>

                    <div class="transaction-detail-item">
                        <strong>Date :</strong>
                        <span id="detailDate"></span>
                    </div>

                    <div class="transaction-detail-item" id="bitcoinQuantityDetail" style="display: none;">
                        <strong>Quantité Bitcoin :</strong>
                        <span id="detailBitcoinQuantity"></span>
                    </div>

                    <div class="transaction-detail-item" id="recurringDetail" style="display: none;">
                        <strong>Récurrence :</strong>
                        <span id="detailRecurring"></span>
                    </div>
                    <div class="transaction-detail-item" id="fromAddressDetail" style="display: none;">
                        <strong>Adresse de départ :</strong>
                        <span id="detailFromAddress"></span>
                    </div>

                    <div class="transaction-detail-item" id="toAddressDetail" style="display: none;">
                        <strong>Adresse de destination :</strong>
                        <span id="detailToAddress"></span>
                    </div>

                    <div class="transaction-detail-item" id="txIdDetail" style="display: none;">
                        <strong>ID de transaction :</strong>
                        <span id="detailTxId"></span>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button class="btn" onclick="editTransactionFromDetails()"
                        style="flex: 1; background: var(--revolut-orange);">
                        Modifier
                    </button>
                    <button class="btn btn-red" onclick="deleteTransactionFromDetails()" style="flex: 1;">
                        Supprimer
                    </button>
                </div>
            </div>
        </div>

</body>

</html>